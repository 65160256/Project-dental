<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - Smile Clinic</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:#f5f7fa}

    /* Sidebar */
    .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,.1)}
    .sidebar .logo{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
    .sidebar .logo h3{font-size:16px;font-weight:600}
    .sidebar ul{list-style:none;padding:10px 0}
    .sidebar ul li{margin:2px 0}
    .sidebar ul li a{display:flex;align-items:center;gap:8px;padding:12px 20px;color:rgba(255,255,255,.9);text-decoration:none;transition:.2s}
    .sidebar ul li:hover a{background:rgba(255,255,255,.2);color:#fff;border-radius:8px;margin:0 10px}

    /* Main */
    .main{margin-left:180px;min-height:100vh}
    .top-bar{position:sticky;top:0;z-index:2;background:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .page-title{font-size:22px;font-weight:700;color:#333}
    .user-section{display:flex;align-items:center;gap:15px}
    .notification-icon{width:20px;height:20px;cursor:pointer;color:#666}
    .profile-dropdown{position:relative}
    .user-info{display:flex;align-items:center;gap:10px;cursor:pointer}
    .avatar{width:32px;height:32px;border-radius:50%;background:#4A90E2;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .user-details strong{display:block;font-size:13px;color:#333}
    .user-details small{color:#666;font-size:11px}
    .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:10}
    .dropdown-menu a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px}
    .dropdown-menu a:hover{background:#f8f9fa}

    /* Profile Content */
    .profile-content{padding:20px 30px}
    .profile-header{display:flex;align-items:center;margin-bottom:24px;gap:15px}
    .back-button{background:#f8f9fa;border:1px solid #e1e5e9;padding:8px 12px;border-radius:6px;color:#666;text-decoration:none;display:flex;align-items:center;gap:8px;font-size:14px}
    .back-button:hover{background:#e9ecef}
    .profile-title{font-size:24px;font-weight:700;color:#333}

    .profile-container{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);max-width:980px;display:flex}
    .profile-left{padding:28px;display:flex;flex-direction:column;align-items:center;border-right:1px solid #f0f0f0;min-width:270px}
    .profile-avatar{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#4A90E2,#2DA8FF);display:flex;align-items:center;justify-content:center;font-size:44px;color:#fff;font-weight:700;margin-bottom:16px;cursor:pointer;transition:.2s;overflow:hidden}
    .profile-avatar:hover{transform:scale(1.03)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .dentist-name{font-size:20px;font-weight:700;color:#333;margin-bottom:6px;text-align:center}
    .last-login{color:#666;font-size:12px;text-align:center}

    .profile-right{flex:1;padding:28px}
    .edit-form{width:100%}
    .form-section{margin-bottom:22px}
    .section-title{font-size:16px;font-weight:700;color:#333;margin-bottom:12px;display:flex;align-items:center;gap:8px}

    .form-row{margin-bottom:14px}
    .form-label{display:block;font-size:12px;color:#666;margin-bottom:5px;font-weight:600}
    .form-input,.form-textarea,.form-select{width:100%;padding:10px 12px;border:1px solid #e0e0e0;border-radius:6px;font-size:14px;background:#f8f9fa;transition:.2s}
    .form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:#4A90E2;background:#fff;box-shadow:0 0 0 3px rgba(74,144,226,.12)}
    .form-input[readonly],.form-input[disabled]{background:#f0f2f5;color:#6c757d;cursor:not-allowed}
    .form-textarea{min-height:90px;resize:vertical}
    .readonly-warning{background:#fff3cd;border:1px solid #ffeaa7;border-radius:6px;padding:12px;margin-bottom:12px;font-size:12px;color:#856404;display:flex;align-items:center;gap:8px}
    .field-help{font-size:11px;color:#6c757d;margin-top:4px;display:block}
    
    /* License Input Group */
    .license-input-group{display:flex;gap:8px;align-items:stretch}
    .license-prefix{flex:0 0 180px;min-width:160px}
    .license-number{flex:1}

    .action-buttons{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:8px;padding:12px 20px;font-size:14px;font-weight:700;cursor:pointer;transition:.2s;text-decoration:none}
    .btn-save{background:#4CAF50;color:#fff}
    .btn-save:hover{background:#3f9443}
    .btn-password{background:#E0E0E0;color:#555}
    .btn-password:hover{background:#cfcfcf}
    .btn-cancel{background:#666;color:#fff}
    .btn-cancel:hover{background:#555}

    .security-section{background:#e7f3ff;border:1px solid #b3d9ff;border-radius:6px;padding:12px;margin-bottom:16px}
    .security-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .security-description{margin:0;font-size:13px;color:#555;line-height:1.4}

    .alert{padding:12px 14px;border-radius:6px;margin-bottom:14px;font-size:14px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}

    .char-counter{font-size:11px;color:#6c757d;margin-top:4px;text-align:right}

    @media (max-width:768px){
      .sidebar{width:100%;height:auto;position:relative}
      .main{margin-left:0}
      .profile-container{flex-direction:column;max-width:100%}
      .profile-left{border-right:none;border-bottom:1px solid #f0f0f0;min-width:auto}
      .action-buttons{flex-direction:column}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">ü¶∑</div>
      <h3>Smile Clinic</h3>
    </div>
    <ul>
      <li><a href="/dentist/dashboard"><i class="fas fa-chart-bar"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
      <li><a href="/dentist/schedule"><i class="fas fa-calendar-alt"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</a></li>
      <li><a href="/dentist/appointments"><i class="fas fa-hospital"></i> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
      <li><a href="/dentist/patients"><i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Top Bar -->
    <div class="top-bar" role="navigation" aria-label="‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô">
      <h1 class="page-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
      <div class="user-section">
        <i class="fas fa-bell notification-icon" onclick="toggleNotifications()" aria-label="‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"></i>
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()" aria-haspopup="true" aria-expanded="false">
            <div class="avatar" id="navAvatar">
              <% if (dentist && dentist.photo && dentist.photo !== 'default-avatar.png') { %>
                <img src="/uploads/<%= dentist.photo %>" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
                     onerror="this.remove(); document.getElementById('navAvatar').textContent='<%= (dentist && dentist.fname && dentist.lname) ? (dentist.fname.charAt(0)+dentist.lname.charAt(0)).toUpperCase() : 'DR' %>';">
              <% } else { %>
                <%= (dentist && dentist.fname && dentist.lname) ? (dentist.fname.charAt(0)+dentist.lname.charAt(0)).toUpperCase() : 'DR' %>
              <% } %>
            </div>
            <div class="user-details">
              <strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ó‡∏û. <%= (dentist && dentist.fname) ? dentist.fname : '' %> <%= (dentist && dentist.lname) ? dentist.lname : '' %></strong>
              <small>‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</small>
            </div>
            <i class="fas fa-caret-down" aria-hidden="true"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/dentist/profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
            <hr />
            <a href="/logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Content -->
    <div class="profile-content">
      <div class="profile-header">
        <a href="/dentist/profile" class="back-button"><i class="fas fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
        <h1 class="profile-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
      </div>

      <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-<%= messageType || 'success' %>"><%= message %></div>
      <% } %>

      <div id="alertContainer"></div>

      <div class="profile-container">
        <div class="profile-left">
          <div class="profile-avatar" id="profileAvatar" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
            <% if (dentist && dentist.photo && dentist.photo !== 'default-avatar.png') { %>
              <img src="/uploads/<%= dentist.photo %>" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
                   onerror="this.remove(); document.getElementById('profileAvatar').textContent='<%= (dentist && dentist.fname && dentist.lname) ? (dentist.fname.charAt(0)+dentist.lname.charAt(0)).toUpperCase() : 'DR' %>';">
            <% } else { %>
              <%= (dentist && dentist.fname && dentist.lname) ? (dentist.fname.charAt(0)+dentist.lname.charAt(0)).toUpperCase() : 'DR' %>
            <% } %>
          </div>

          <input type="file" id="photoInput" name="photo" accept="image/*" style="display:none">

          <h2 class="dentist-name">‡∏ó‡∏û. <%= (dentist && dentist.fname) ? dentist.fname : '' %> <%= (dentist && dentist.lname) ? dentist.lname : '' %></h2>
          <p class="last-login">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
            <% if (dentist && dentist.last_login) { %>
              <%= new Date(dentist.last_login).toLocaleDateString('th-TH', {
                    day:'2-digit', month:'short', year:'numeric'
                  }) %>
              ‡πÄ‡∏ß‡∏•‡∏≤ <%= new Date(dentist.last_login).toLocaleTimeString('th-TH', {
                    hour:'2-digit', minute:'2-digit', hour12:false
                  }) %> ‡∏ô.
            <% } else { %> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö <% } %>
          </p>
        </div>

        <div class="profile-right">
          <form class="edit-form" id="editProfileForm" novalidate>
            <% if (typeof csrfToken !== 'undefined') { %>
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <% } %>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-user" style="color:#4A90E2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>

              <div class="form-row">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠: <span style="color:red">*</span></label>
                <input type="text" name="fname" class="form-input" 
                       value="<%= dentist?.fname || '' %>" 
                       required
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á">
                <small class="field-help">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: <span style="color:red">*</span></label>
                <input type="text" name="lname" class="form-input" 
                       value="<%= dentist?.lname || '' %>" 
                       required
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <small class="field-help">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: <span style="color:red">*</span></label>
                <input type="text" name="id_card" id="id_card" class="form-input" 
                       value="<%= dentist?.id_card || '' %>" 
                       required
                       maxlength="13"
                       pattern="^\d{13}$"
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å 13 ‡∏´‡∏•‡∏±‡∏Å">
                <small class="field-help">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°:</label>
                <div class="license-input-group">
                  <select name="license_prefix" class="form-input license-prefix">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                    <option value="‡∏ó.‡∏ö.">‡∏ó.‡∏ö. - ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="‡∏ó.‡∏õ.">‡∏ó.‡∏õ. - ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á</option>
                    <option value="‡∏ó.‡∏ß.">‡∏ó.‡∏ß. - ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
                    <option value="‡∏ó.‡∏ó.">‡∏ó.‡∏ó. - ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</option>
                  </select>
                  <input type="text" name="license_no" class="form-input license-number" 
                         placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç">
                </div>
                <small class="field-help">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó.‡∏ö. 32458)</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•: <span style="color:red">*</span></label>
                <input type="email" name="email" id="email" class="form-input" 
                       value="<%= dentist?.email || '' %>" 
                       required
                       autocomplete="email"
                       placeholder="example@email.com">
                <small class="field-help">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</small>
              </div>
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û -->
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-briefcase-medical" style="color:#28a745"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</h3>

              <div class="form-row">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î:</label>
                <input type="date" name="dob" class="form-input"
                       value="<%= (dentist && dentist.dob) ? new Date(dentist.dob).toISOString().split('T')[0] : '' %>">
                <small class="field-help">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏•‡∏±‡∏Å:</label>
                <select name="specialty" class="form-select">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏•‡∏±‡∏Å</option>
                  <option value="General Dentistry" <%= dentist?.specialty === 'General Dentistry' ? 'selected' : '' %>>‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                  <option value="Tooth Extraction" <%= dentist?.specialty === 'Tooth Extraction' ? 'selected' : '' %>>‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô</option>
                  <option value="Orthodontics" <%= dentist?.specialty === 'Orthodontics' ? 'selected' : '' %>>‡∏à‡∏±‡∏î‡∏ü‡∏±‡∏ô</option>
                  <option value="Endodontics" <%= dentist?.specialty === 'Endodontics' ? 'selected' : '' %>>‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô</option>
                  <option value="Periodontics" <%= dentist?.specialty === 'Periodontics' ? 'selected' : '' %>>‡∏õ‡∏£‡∏¥‡∏ó‡∏±‡∏ô‡∏ï‡πå</option>
                  <option value="Oral Surgery" <%= dentist?.specialty === 'Oral Surgery' ? 'selected' : '' %>>‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
                </select>
                <small class="field-help">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                <textarea name="education" id="education" maxlength="800" class="form-textarea"
                          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."><%= dentist?.education || '' %></textarea>
                <div class="char-counter"><span id="eduCount">0</span>/800</div>
                <small class="field-help">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏ö‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</small>
              </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ -->
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-phone" style="color:#17a2b8"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>

              <div class="form-row">
                <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</label>
                <textarea name="address" class="form-textarea" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."><%= dentist?.address || '' %></textarea>
                <small class="field-help">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</small>
              </div>

              <div class="form-row">
                <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
                <input type="tel" name="phone" id="phone" class="form-input"
                       value="<%= dentist?.phone || '' %>"
                       placeholder="08xxxxxxxx" inputmode="numeric"
                       pattern="^0\d{8,9}$">
                <small class="field-help">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 9‚Äì10 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 0</small>
              </div>
            </div>

            <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ -->
            <div class="form-section">
              <h3 class="section-title"><i class="fas fa-shield-alt" style="color:#6f42c1"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h3>
              <div class="security-section">
                <div class="security-header">
                  <i class="fas fa-info-circle" style="color:#0d6efd"></i>
                  <strong>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</strong>
                </div>
                <p class="security-description">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
              </div>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <a href="/dentist/profile/change-password" class="btn btn-password"><i class="fas fa-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</a>
              </div>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
            <div class="action-buttons">
              <button type="submit" class="btn btn-save" id="saveBtn">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
              </button>
              <a href="/dentist/profile" class="btn btn-cancel"><i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Initialize license fields =====
    document.addEventListener('DOMContentLoaded', function() {
      const licenseValue = '<%= dentist?.license_no || "" %>';
      if (licenseValue) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏ó.‡∏ö. 32458)
        const thaiLicenseMatch = licenseValue.match(/^([‡∏ó]\.[‡∏ö‡∏õ‡∏ß‡∏ó]\.)\s*(\d+)$/);
        if (thaiLicenseMatch) {
          // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏ó.‡∏ö. 32458
          document.querySelector('select[name="license_prefix"]').value = thaiLicenseMatch[1];
          document.querySelector('input[name="license_no"]').value = thaiLicenseMatch[2];
        } else if (/^\d+$/.test(licenseValue)) {
          // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏ó.‡∏ö. (‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
          document.querySelector('select[name="license_prefix"]').value = '‡∏ó.‡∏ö.';
          document.querySelector('input[name="license_no"]').value = licenseValue;
        } else {
          // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ - ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á number ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å prefix
          document.querySelector('input[name="license_no"]').value = licenseValue;
        }
      }
    });

    // ===== Top bar interactions =====
    function toggleDropdown(){
      const menu=document.getElementById('profileDropdown');
      const expanded = menu.style.display==='block';
      menu.style.display= expanded ? 'none':'block';
      const ui=document.querySelector('.user-info');
      if(ui) ui.setAttribute('aria-expanded',(!expanded).toString());
    }
    function toggleNotifications(){ alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤!'); }
    document.addEventListener('click',function(e){
      const prof=document.querySelector('.profile-dropdown');
      if(prof && !prof.contains(e.target)){
        const dd=document.getElementById('profileDropdown');
        if(dd) dd.style.display='none';
        const ui=document.querySelector('.user-info');
        if(ui) ui.setAttribute('aria-expanded','false');
      }
    });

    // ===== Helpers =====
    const alertContainer = document.getElementById('alertContainer');
    function showAlert(msg,type='success'){
      alertContainer.innerHTML = '<div class="alert alert-'+type+'" role="alert">'+msg+'</div>';
      if(type==='success'){ setTimeout(()=>{ alertContainer.innerHTML=''; }, 5000); }
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function setDirty(v){ window.__dirty = v; }
    window.addEventListener('beforeunload', function (e) {
      if(window.__dirty){
        e.preventDefault(); e.returnValue='';
      }
    });

    // ‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    const edu = document.getElementById('education');
    if(edu){
      const count = document.getElementById('eduCount');
      const updateCount = ()=>{ count.textContent = edu.value.length; };
      edu.addEventListener('input', ()=>{ updateCount(); setDirty(true); });
      updateCount();
    }

    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const phone = document.getElementById('phone');
    if(phone){
      phone.addEventListener('input', ()=>{
        const caret = phone.selectionStart;
        phone.value = phone.value.replace(/[^0-9]/g,'');
        phone.setSelectionRange(caret, caret);
        setDirty(true);
      });
    }

    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const idCard = document.getElementById('id_card');
    if(idCard){
      idCard.addEventListener('input', ()=>{
        const caret = idCard.selectionStart;
        idCard.value = idCard.value.replace(/[^0-9]/g,'').slice(0, 13);
        idCard.setSelectionRange(caret, caret);
        setDirty(true);
      });
    }

    // Avatar: ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
    const avatar = document.getElementById('profileAvatar');
    const photoInput = document.getElementById('photoInput');
    if(avatar && photoInput){
      avatar.addEventListener('click', ()=> photoInput.click());
      photoInput.addEventListener('change', ()=>{
        const file = photoInput.files && photoInput.files[0];
        if(!file) return;
        const allowed = ['image/jpeg','image/png','image/webp','image/gif'];
        if(!allowed.includes(file.type)){ showAlert('‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô JPG/PNG/WEBP/GIF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô','danger'); photoInput.value=''; return; }
        if(file.size > 3*1024*1024){ showAlert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3MB','danger'); photoInput.value=''; return; }
        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        const reader = new FileReader();
        reader.onload = e=>{
          avatar.textContent='';
          const img = new Image();
          img.alt='‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå';
          img.onload = ()=>{ avatar.innerHTML=''; avatar.appendChild(img); };
          img.src = e.target.result;
          img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
        };
        reader.readAsDataURL(file);
        setDirty(true);
      });
    }

    // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ dirty ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    document.querySelectorAll('input[name],textarea[name],select[name]').forEach(el=>{
      if(el.name === '_csrf') return;
      el.addEventListener('change', ()=>setDirty(true));
      el.addEventListener('input', ()=>setDirty(true));
    });

    // ===== Form submission (multipart; ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ) =====
    document.getElementById('editProfileForm').addEventListener('submit', async function(e){
      e.preventDefault();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏Ñ‡∏•‡πÄ‡∏≠‡∏ô‡∏ï‡πå
      const dobInput = this.querySelector('input[name="dob"]');
      if(dobInput && dobInput.value){
        const d = new Date(dobInput.value);
        const today = new Date(); today.setHours(0,0,0,0);
        if(d > today){ showAlert('‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'danger'); return; }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
      if(phone && phone.value && !/^0\d{8,9}$/.test(phone.value)){
        showAlert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0 ‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ß 9‚Äì10 ‡∏´‡∏•‡∏±‡∏Å)', 'danger'); return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
      if(idCard && idCard.value && !/^\d{13}$/.test(idCard.value)){
        showAlert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'danger'); return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      const fname = this.querySelector('input[name="fname"]');
      const lname = this.querySelector('input[name="lname"]');
      const email = this.querySelector('input[name="email"]');
      
      if(!fname || !fname.value.trim()){ showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', 'danger'); return; }
      if(!lname || !lname.value.trim()){ showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'danger'); return; }
      if(!email || !email.value.trim()){ showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•', 'danger'); return; }
      if(!idCard || !idCard.value.trim()){ showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'danger'); return; }

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try{
        const fd = new FormData();
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        ['fname','lname','id_card','license_no','email','dob','specialty','education','address','phone','_csrf'].forEach(name=>{
          const el = this.querySelector('[name="'+name+'"]');
          if(el && el.value !== undefined){ fd.append(name, el.value); }
        });
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if(photoInput && photoInput.files && photoInput.files[0]){ fd.append('photo', photoInput.files[0]); }

        const headers = {};
        <% if (typeof csrfToken !== 'undefined') { %>
          headers['CSRF-Token'] = '<%= csrfToken %>';
        <% } %>
        headers['X-Requested-With'] = 'XMLHttpRequest';

        const res = await fetch('/dentist/profile/update', {
          method:'POST',
          headers,
          body: fd
        });

        const payload = await res.json().catch(()=>({success:false,error:'‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}));

        if(res.ok && payload.success){
          showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success');
          window.__dirty = false;
          setTimeout(()=>{ window.location.href='/dentist/profile'; }, 1500);
        }else{
          const msg = payload && payload.error ? payload.error : '‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
          showAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg,'danger');
        }
      }catch(err){
        console.error(err);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå','danger');
      }finally{
        saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    });
  </script>
</body>
</html>