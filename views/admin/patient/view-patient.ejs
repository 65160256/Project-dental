<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลผู้ป่วย - Smile Clinic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background-color:#f5f7fa;margin:0}

        /* Sidebar */
        .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;padding:0;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,0.1);z-index:1000}
        .sidebar .logo{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
        .sidebar .logo h3{margin:0;font-size:16px;font-weight:600}
        .sidebar ul{list-style:none;padding:10px 0;margin:0}
        .sidebar ul li{margin:2px 0}
        .sidebar ul li a{display:block;padding:12px 20px;color:rgba(255,255,255,0.9);text-decoration:none;transition:all .3s ease;font-size:14px;display:flex;align-items:center;gap:8px}
        .sidebar ul li.active a,.sidebar ul li:hover a{background-color:rgba(255,255,255,0.2);color:#fff;border-radius:8px;margin:0 10px}

        /* Main */
        .main{margin-left:180px;min-height:100vh}

        /* Header */
        .header{background:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .header h2{margin:0;font-size:24px;color:#333;font-weight:600}
        .top-right{display:flex;align-items:center;gap:20px}

        .notification-container{position:relative}
        .notification-icon{cursor:pointer;color:#666;transition:color .3s ease;font-size:18px}
        .notification-icon:hover{color:#4A90E2}
        .notification-badge{position:absolute;top:-8px;right:-8px;background:#ff4757;color:#fff;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:600;animation:pulse 2s infinite}
        .notification-badge.show{display:flex}
        @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
        .notification-dropdown{position:absolute;top:100%;right:-10px;background:#fff;border:1px solid #e1e5e9;border-radius:12px;min-width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.15);z-index:2000;display:none;max-height:400px;overflow:hidden}
        .notification-dropdown.show{display:block;animation:slideDown .3s ease}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .notification-header{padding:15px 20px;border-bottom:1px solid #e1e5e9;background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;font-weight:600;display:flex;justify-content:space-between;align-items:center}
        .mark-all-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;cursor:pointer;transition:all .2s ease}
        .notification-content{max-height:300px;overflow-y:auto}
        .notification-item{padding:12px 20px;border-bottom:1px solid #f1f3f4;cursor:pointer;transition:background .2s ease}
        .notification-item:hover{background:#f8f9fa}
        .notification-item.unread{background:#f0f8ff;border-left:4px solid #4A90E2}
        .notification-title{font-weight:600;color:#333;font-size:13px;margin-bottom:3px}
        .notification-message{color:#666;font-size:12px;margin-bottom:5px}
        .notification-time{color:#999;font-size:11px}
        .empty-notifications{padding:30px 20px;text-align:center;color:#666}
        .empty-notifications i{font-size:24px;color:#ddd;margin-bottom:10px}

        .admin-info{display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
        .admin-avatar{width:35px;height:35px;border-radius:50%;background:#4A90E2;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:600;text-transform:uppercase}
        .admin-details{color:#333}
        .admin-details strong{display:block;font-size:13px}
        .admin-details small{color:#666;font-size:11px}
        .admin-dropdown{position:absolute;top:100%;right:0;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:150px;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:1000;display:none}
        .admin-dropdown a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px;transition:background .2s ease}
        .admin-dropdown a:hover{background:#f8f9fa}

        /* Content */
        .content{padding:30px;display:grid;grid-template-columns:300px 1fr;gap:30px;max-width:1200px}

        /* Left Panel */
        .left-panel{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,0.08);height:fit-content;text-align:center}
        .patient-avatar{width:200px;height:200px;border-radius:12px;object-fit:cover;margin:0 auto 20px;border:3px solid #e1e5e9;background:linear-gradient(135deg,#4A90E2,#2DA8FF);display:flex;align-items:center;justify-content:center;color:#fff;font-size:60px;font-weight:600}
        .patient-id-badge{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;margin-bottom:20px}
        .status-badge{background:#10b981;color:#fff;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:500;display:inline-block}

        /* Right Panel */
        .right-panel{display:flex;flex-direction:column;gap:25px}
        .info-section{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .section-header{display:flex;align-items:center;gap:10px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f1f3f4}
        .section-icon{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,rgba(74,144,226,0.1),rgba(45,168,255,0.1));display:flex;align-items:center;justify-content:center;color:#4A90E2;font-size:16px}
        .section-title{font-size:18px;font-weight:600;color:#333;margin:0}
        .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .info-item{display:flex;flex-direction:column;gap:5px}
        .info-label{font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:.5px}
        .info-value{font-size:14px;color:#333;font-weight:500;word-break:break-word}
        .info-value.empty{color:#999;font-style:italic}
        .info-value.loading{color:#999;font-style:italic}

        /* Medical alert styling */
        .info-value.has-medical-alert {
            color: #dc2626;
            font-weight: 600;
            background: #fee2e2;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #dc2626;
        }

        .medical-section {
            background: #fff9f0;
            border-left: 4px solid #f59e0b;
        }

        .medical-icon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
            color: #f59e0b;
        }

        /* Actions */
        .action-section{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .action-buttons{display:flex;gap:15px;flex-wrap:wrap}
        .btn{padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all .3s ease}
        .btn-primary{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,0.3)}
        .btn-warning{background:#ffc107;color:#212529}
        .btn-warning:hover{background:#e0a800;transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,193,7,0.3)}
        .btn-danger{background:#dc3545;color:#fff}
        .btn-danger:hover{background:#c82333;transform:translateY(-2px);box-shadow:0 4px 12px rgba(220,53,69,0.3)}
        .btn-secondary{background:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268;transform:translateY(-2px);box-shadow:0 4px 12px rgba(108,117,125,0.3)}

        /* Toast */
        .toast{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:#fff;font-size:14px;font-weight:500;z-index:4000;box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideInRight .3s ease;display:flex;align-items:center;gap:10px;min-width:300px}
        .toast.success{background:#10b981}.toast.error{background:#ef4444}.toast.info{background:#3b82f6}.toast.warning{background:#f59e0b}
        @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

        /* Modal */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:none;align-items:center;justify-content:center}
        .modal-content{background:#fff;border-radius:12px;padding:30px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center}
        .modal-icon{width:60px;height:60px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;color:#dc2626;font-size:24px;margin:0 auto 20px}
        .modal-title{font-size:18px;font-weight:600;color:#333;margin-bottom:10px}
        .modal-message{color:#666;margin-bottom:25px;line-height:1.5}
        .modal-actions{display:flex;gap:10px;justify-content:center}

        /* Stats */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:20px}
        .stat-card{background:linear-gradient(135deg,#f8fafc,#e2e8f0);padding:15px;border-radius:8px;text-align:center;border:1px solid #e2e8f0}
        .stat-number{font-size:24px;font-weight:700;color:#4A90E2;margin-bottom:5px}
        .stat-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:.5px}

        /* Responsive */
        @media (max-width:1024px){.content{grid-template-columns:1fr}.left-panel{order:-1}}
        @media (max-width:768px){
            .sidebar{width:100%;height:auto;position:relative}
            .main{margin-left:0}
            .action-buttons{flex-direction:column}
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">🦷</div>
            <h3>Smile Clinic</h3>
        </div>
        <ul>
      <li><a href="/admin/dashboard"><i class="fas fa-chart-bar"></i> แดชบอร์ด</a></li>
      <li><a href="/admin/schedule"><i class="fas fa-calendar-alt"></i> ตารางเวลา</a></li>
      <li><a href="/admin/appointments"><i class="fas fa-hospital"></i> การนัดหมาย</a></li>
      <li><a href="/admin/dentists"><i class="fas fa-user-md"></i> ทันตแพทย์</a></li>
      <li class="active"><a href="/admin/patients"><i class="fas fa-users"></i> ผู้ป่วย</a></li>
      <li><a href="/admin/treatments"><i class="fas fa-tooth"></i> การรักษา</a></li>
    </ul>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Header -->
        <div class="header">
            <h2>ข้อมูลผู้ป่วย</h2>
            <div class="top-right">
                <div class="notification-container">
                    <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
                    <div class="notification-badge" id="notificationBadge">0</div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <span>การแจ้งเตือน</span>
                            <button class="mark-all-btn" onclick="markAllAsRead()">อ่านทั้งหมด</button>
                        </div>
                        <div class="notification-content" id="notificationContent">
                            <div class="empty-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>กำลังโหลดการแจ้งเตือน...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-info" onclick="toggleAdminDropdown()">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div class="admin-details">
                        <strong>สวัสดี แอดมิน</strong>
                        <small>ผู้ดูแลระบบ</small>
                    </div>
                    <i class="fas fa-caret-down"></i>
                    <div class="admin-dropdown" id="adminDropdown">
                        <a href="/admin/profile">โปรไฟล์ของฉัน</a>
                        <a href="/logout">ออกจากระบบ</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="patient-avatar" id="patientAvatar">P</div>
                <div class="patient-id-badge" id="patientIdBadge">ID: 001</div>
                <div class="status-badge" id="statusBadge">ใช้งานอยู่</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAppointments">0</div>
                        <div class="stat-label">การนัดหมาย</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTreatments">0</div>
                        <div class="stat-label">การรักษา</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Personal Information -->
                <div class="info-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-user"></i></div>
                        <h3 class="section-title">ข้อมูลส่วนตัว</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ชื่อ-นามสกุล</div>
                            <div class="info-value loading" id="fullName">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">วันเดือนปีเกิด</div>
                            <div class="info-value loading" id="birthDate">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">เพศ</div>
                            <div class="info-value loading" id="gender">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">เลขบัตรประชาชน</div>
                            <div class="info-value loading" id="id_card">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">เยี่ยมครั้งล่าสุด</div>
                            <div class="info-value loading" id="lastVisit">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">เข้าสู่ระบบล่าสุด</div>
                            <div class="info-value loading" id="lastLogin">กำลังโหลด...</div>
                        </div>
                    </div>
                </div>

                <!-- Medical Information -->
                <div class="info-section medical-section">
                    <div class="section-header">
                        <div class="section-icon medical-icon"><i class="fas fa-notes-medical"></i></div>
                        <h3 class="section-title">ข้อมูลทางการแพทย์</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">โรคประจำตัว</div>
                            <div class="info-value loading" id="chronic_disease">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ประวัติการแพ้ยา</div>
                            <div class="info-value loading" id="drug_allergy">กำลังโหลด...</div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="info-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-address-book"></i></div>
                        <h3 class="section-title">ข้อมูลติดต่อ</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ที่อยู่</div>
                            <div class="info-value loading" id="address">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">เบอร์โทรศัพท์</div>
                            <div class="info-value loading" id="phone">กำลังโหลด...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">อีเมล</div>
                            <div class="info-value loading" id="email">กำลังโหลด...</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="action-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-tools"></i></div>
                        <h3 class="section-title">การทำงาน</h3>
                    </div>
                    <div class="action-buttons">
                        <a href="#" class="btn btn-primary" id="treatmentBtn">
                            <i class="fas fa-history"></i> ประวัติการรักษา
                        </a>
                        <a href="#" class="btn btn-warning" id="editBtn">
                            <i class="fas fa-edit"></i> แก้ไขข้อมูล
                        </a>
                        <button class="btn btn-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> กลับ
                        </button>
                        <button class="btn btn-danger" onclick="confirmDelete()">
                            <i class="fas fa-trash"></i> ลบ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="modal-title">ยืนยันการลบ</h3>
            <div class="modal-message" id="deleteMessage">
                คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลผู้ป่วยรายนี้?<br>การกระทำนี้ไม่สามารถย้อนกลับได้
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ยกเลิก</button>
                <button class="btn btn-danger" onclick="deletePatient()">
                    <i class="fas fa-trash"></i> ลบ
                </button>
            </div>
        </div>
    </div>

    <script>
        const TH_LOCALE = 'th-TH';
        let patientId = null;
        let patientData = null;

        document.addEventListener('DOMContentLoaded', function() {
            extractPatientId();
            loadPatientData();
            loadUserInfo();
            loadNotifications();
        });

        // Extract patient ID
        function extractPatientId() {
            const path = window.location.pathname;
            const matches = path.match(/\/patients\/(\d+)(?:\/)?$/);
            if (matches) {
                patientId = parseInt(matches[1]);
                document.getElementById('patientIdBadge').textContent = `ID: ${String(patientId).padStart(3,'0')}`;
            } else {
                showToast('ไม่พบรหัสผู้ป่วยที่ถูกต้อง', 'error');
                setTimeout(()=>window.location.href='/admin/patients', 2000);
            }
        }

        // Load patient data
        async function loadPatientData() {
            if (!patientId) return;
            try {
                const response = await fetch(`/admin/api/patients/${patientId}`);
                if (!response.ok) {
                    const errorText = await response.text().catch(()=> '');
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                const data = await response.json();
                if (data.success && data.patient) {
                    patientData = data.patient;
                    populateData(patientData);
                } else {
                    throw new Error(data.error || 'โหลดข้อมูลผู้ป่วยล้มเหลว');
                }
            } catch (error) {
                showToast('ไม่สามารถโหลดข้อมูลผู้ป่วยได้: ' + error.message, 'error');
                document.querySelectorAll('.loading').forEach(el=>{
                    el.textContent = 'โหลดข้อมูลไม่สำเร็จ';
                    el.classList.remove('loading'); el.classList.add('empty');
                });
                setTimeout(()=>window.location.href='/admin/patients', 3000);
            }
        }

        // Populate data
        function populateData(patient) {
            console.log('📋 กำลังแสดงข้อมูลผู้ป่วย:', patient);

            // Full name & avatar initials
            const fullName = `${patient.fname || ''} ${patient.lname || ''}`.trim();
            setValue('fullName', fullName || 'ไม่ได้ระบุ');
            const initials = (patient.fname && patient.lname) ? (patient.fname[0] + patient.lname[0]).toUpperCase() : 'P';
            document.getElementById('patientAvatar').textContent = initials;

            // DoB
            const dobEl = document.getElementById('birthDate');
            if (patient.dob) {
                const d = new Date(patient.dob);
                if (!isNaN(d)) dobEl.textContent = d.toLocaleDateString(TH_LOCALE,{year:'numeric',month:'long',day:'numeric'});
                else dobEl.innerHTML = '<span class="empty">รูปแบบวันที่ไม่ถูกต้อง</span>';
            } else dobEl.innerHTML = '<span class="empty">ไม่ได้ระบุ</span>';
            dobEl.classList.remove('loading');

            // Gender
            const genderMap = {
                'male': 'ชาย',
                'female': 'หญิง',
                'other': 'อื่นๆ'
            };
            const genderText = patient.gender ? (genderMap[patient.gender] || patient.gender) : 'ไม่ได้ระบุ';
            setValue('gender', genderText);

            // Thai ID
            const idFields = ['id_card','ID_CARD','citizenId','nationalId'];
            let idVal = '';
            for (const f of idFields) {
                if (patient[f]) { idVal = String(patient[f]).trim(); break; }
            }
            const idEl = document.getElementById('id_card');
            if (idVal) {
                if (/^\d{13}$/.test(idVal)) {
                    idEl.textContent = `${idVal.slice(0,1)}-${idVal.slice(1,5)}-${idVal.slice(5,10)}-${idVal.slice(10,12)}-${idVal.slice(12)}`;
                } else idEl.textContent = idVal;
            } else idEl.innerHTML = '<span class="empty">ไม่ได้ระบุ</span>';
            idEl.classList.remove('loading');

            // Medical Information
            const chronicDisease = (patient.chronic_disease || '').trim();
            const allergyHistory = (patient.allergy_history || patient.drug_allergy || '').trim();

            if (chronicDisease) {
                setValue('chronic_disease', chronicDisease);
                document.getElementById('chronic_disease').classList.add('has-medical-alert');
            } else {
                setValue('chronic_disease', '<span class="empty">ไม่มี</span>', true);
            }

            if (allergyHistory) {
                setValue('drug_allergy', allergyHistory);
                document.getElementById('drug_allergy').classList.add('has-medical-alert');
            } else {
                setValue('drug_allergy', '<span class="empty">ไม่มี</span>', true);
            }

            // Address
            setValue('address', (patient.address||'').trim() || '<span class="empty">ไม่ได้ระบุ</span>', true);

            // Phone
            const phoneRaw = (patient.phone||'').trim();
            const phoneEl = document.getElementById('phone');
            if (phoneRaw) {
                let p = phoneRaw.replace(/\D/g,'');
                if (/^\d{10}$/.test(p)) { p = `${p.slice(0,3)}-${p.slice(3,6)}-${p.slice(6)}`; }
                else if (/^\d{9}$/.test(p)) { p = `${p.slice(0,2)}-${p.slice(2,5)}-${p.slice(5)}`; }
                phoneEl.textContent = p;
            } else phoneEl.innerHTML = '<span class="empty">ไม่ได้ระบุ</span>';
            phoneEl.classList.remove('loading');

            // Email
            setValue('email', (patient.email||'').trim() || '<span class="empty">ไม่ได้ระบุ</span>', true);

            // Last visit / login
            setDateTime('lastVisit', patient.last_visit, 'ยังไม่เคยมาเยี่ยม');
            setDateTime('lastLogin', patient.last_login, 'ไม่เคยเข้าสู่ระบบ');

            // Stats
            const totalAppointments = patient.stats?.total_appointments ?? patient.total_appointments ?? 0;
            document.getElementById('totalAppointments').textContent = totalAppointments;
            document.getElementById('totalTreatments').textContent = patient.stats?.total_treatments ?? totalAppointments;

            // Status badge
            if (typeof patient.active !== 'undefined') {
                document.getElementById('statusBadge').textContent = patient.active ? 'ใช้งานอยู่' : 'ถูกระงับ';
                document.getElementById('statusBadge').style.background = patient.active ? '#10b981' : '#9ca3af';
            }

            // Action links
            document.getElementById('treatmentBtn').href = `/admin/patients/${patientId}/treatments`;
            document.getElementById('editBtn').href = `/admin/patients/${patientId}/edit`;

            console.log('✅ แสดงข้อมูลผู้ป่วยสำเร็จ');
        }

        function setValue(id, value, isHTML=false){
            const el = document.getElementById(id);
            if (!el) return;
            if (isHTML) el.innerHTML = value; else el.textContent = value;
            el.classList.remove('loading');
        }

        function setDateTime(id, iso, fallbackText){
            const el = document.getElementById(id);
            if (iso) {
                const d = new Date(iso);
                if (!isNaN(d)) el.textContent = formatDateTime(d);
                else el.innerHTML = '<span class="empty">รูปแบบวันที่ไม่ถูกต้อง</span>';
            } else el.innerHTML = `<span class="empty">${fallbackText}</span>`;
            el.classList.remove('loading');
        }

        // User info
        async function loadUserInfo() {
            try {
                const res = await fetch('/admin/profile/api');
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        const first = data.email ? data.email.charAt(0).toUpperCase() : 'A';
                        document.getElementById('adminAvatar').textContent = first;
                        const nameEl = document.querySelector('.admin-details strong');
                        if (nameEl) nameEl.textContent = `สวัสดี ${data.role || 'แอดมิน'}`;
                    }
                }
            } catch {
                document.getElementById('adminAvatar').textContent = 'A';
            }
        }

        // Notifications
        async function loadNotifications() {
            try {
                const res = await fetch('/admin/api/notifications?limit=10');
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) updateNotificationDisplay(data.notifications, data.pagination.unread_count);
                }
            } catch {
                showEmptyNotifications();
            }
        }

        function updateNotificationDisplay(notifications, unreadCount) {
            const badge = document.getElementById('notificationBadge');
            const content = document.getElementById('notificationContent');

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.add('show');
            } else badge.classList.remove('show');

            if (!notifications || notifications.length === 0) { showEmptyNotifications(); return; }

            content.innerHTML = notifications.map(n=>{
                const timeAgo = getTimeAgo(new Date(n.created_at));
                return `
                    <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="markAsRead(${n.id})">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }

        function showEmptyNotifications() {
            document.getElementById('notificationContent').innerHTML = `
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>ยังไม่มีการแจ้งเตือนใหม่</p>
                </div>
            `;
        }

        function toggleNotifications() {
            const dd = document.getElementById('notificationDropdown');
            if (dd.classList.contains('show')) dd.classList.remove('show');
            else { dd.classList.add('show'); loadNotifications(); }
        }

        function toggleAdminDropdown() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        async function markAsRead(id) {
            try {
                const r = await fetch(`/admin/api/notifications/${id}/read`, { method: 'POST' });
                if (r.ok) { loadNotifications(); showToast('ทำเครื่องหมายว่าอ่านแล้ว', 'success'); }
            } catch {}
        }

        async function markAllAsRead() {
            try {
                const r = await fetch('/admin/api/notifications/read-all', { method: 'POST' });
                if (r.ok) { loadNotifications(); showToast('อ่านการแจ้งเตือนทั้งหมดแล้ว', 'success'); }
            } catch { showToast('ทำเครื่องหมายว่าอ่านทั้งหมดไม่สำเร็จ', 'error'); }
        }

        // Confirm delete
        function confirmDelete() {
            if (!patientData) { showToast('ไม่สามารถลบได้: ยังไม่ได้โหลดข้อมูลผู้ป่วย', 'error'); return; }
            const msg = document.getElementById('deleteMessage');
            msg.innerHTML = `
                ต้องการลบ<br><strong>${(patientData.fname||'ไม่ทราบชื่อ')} ${(patientData.lname||'ผู้ป่วย')}</strong> ใช่หรือไม่?<br>
                <span style="color:#d97706">การกระทำนี้ไม่สามารถย้อนกลับได้</span>
            `;
            document.getElementById('deleteModal').style.display='flex';
        }
        function closeModal(){ document.getElementById('deleteModal').style.display='none'; }

        async function deletePatient() {
            if (!patientId) return;
            try {
                showToast('กำลังลบผู้ป่วย...', 'info');
                const res = await fetch(`/admin/api/patients/${patientId}`, { method:'DELETE' });
                const data = await res.json().catch(()=>({success:false}));
                if (data.success) {
                    closeModal();
                    showToast('ลบข้อมูลผู้ป่วยสำเร็จ', 'success');
                    setTimeout(()=>window.location.href='/admin/patients', 1500);
                } else throw new Error(data.error || 'ลบไม่สำเร็จ');
            } catch (e) {
                showToast('เกิดข้อผิดพลาดระหว่างลบ: ' + e.message, 'error');
            }
        }

        function goBack(){ window.location.href = '/admin/patients'; }

        // Toast
        function showToast(message, type='info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = {success:'fas fa-check-circle',error:'fas fa-exclamation-triangle',warning:'fas fa-exclamation-circle',info:'fas fa-info-circle'}[type];
            toast.innerHTML = `<i class="${icon}"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(()=>{ toast.style.animation='slideOutRight .3s ease'; setTimeout(()=>{ toast.remove(); },300); }, 4500);
        }

        // Time ago
        function getTimeAgo(date){
            const now = new Date();
            const s = Math.floor((now - date)/1000);
            if (s < 60) return 'เมื่อสักครู่';
            if (s < 3600) return `${Math.floor(s/60)} นาทีที่แล้ว`;
            if (s < 86400) return `${Math.floor(s/3600)} ชั่วโมงที่แล้ว`;
            if (s < 604800) return `${Math.floor(s/86400)} วันที่แล้ว`;
            return date.toLocaleString(TH_LOCALE,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
        }

        function formatDateTime(date){
            return date.toLocaleString(TH_LOCALE,{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false});
        }

        // Outside click handlers
        document.addEventListener('click', function(e){
            const adminInfo = document.querySelector('.admin-info');
            if (!adminInfo.contains(e.target)) document.getElementById('adminDropdown').style.display='none';
            const notif = document.querySelector('.notification-container');
            if (!notif.contains(e.target)) document.getElementById('notificationDropdown').classList.remove('show');
            const modal = document.getElementById('deleteModal');
            if (e.target === modal) closeModal();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e){
            if (e.key === 'Escape'){ document.getElementById('notificationDropdown').classList.remove('show'); document.getElementById('adminDropdown').style.display='none'; closeModal(); }
            if ((e.key==='e'||e.key==='E') && patientId && !e.ctrlKey && !e.metaKey) window.location.href = `/admin/patients/${patientId}/edit`;
            if ((e.key==='t'||e.key==='T') && patientId && !e.ctrlKey && !e.metaKey) window.location.href = `/admin/patients/${patientId}/treatments`;
            if ((e.key==='b'||e.key==='B') && !e.ctrlKey && !e.metaKey) goBack();
            if (e.key==='Enter' && document.getElementById('deleteModal').style.display==='flex'){ e.preventDefault(); deletePatient(); }
        });

        // Auto-refresh notifications
        setInterval(loadNotifications, 60000);

        // Connection status
        window.addEventListener('online', ()=>{ showToast('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success'); if (!patientData) loadPatientData(); });
        window.addEventListener('offline', ()=>{ showToast('การเชื่อมต่อขาดหาย', 'warning'); });
    </script>
</body>
</html>