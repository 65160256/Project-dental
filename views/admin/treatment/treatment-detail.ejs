<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ - Smile Clinic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background-color:#f5f7fa;margin:0}

        /* Sidebar */
        .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;padding:0;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,0.1);z-index:1000}
        .sidebar .logo{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
        .sidebar .logo h3{margin:0;font-size:16px;font-weight:600}
        .sidebar ul{list-style:none;padding:10px 0;margin:0}
        .sidebar ul li{margin:2px 0}
        .sidebar ul li a{display:block;padding:12px 20px;color:rgba(255,255,255,0.9);text-decoration:none;transition:all .3s ease;font-size:14px;display:flex;align-items:center;gap:8px}
        .sidebar ul li.active a,.sidebar ul li:hover a{background-color:rgba(255,255,255,0.2);color:#fff;border-radius:8px;margin:0 10px}

        /* Main */
        .main{margin-left:180px;min-height:100vh}

        /* Top Bar */
        .top-bar{background:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:relative}
        .back-section{display:flex;align-items:center;gap:15px}
        .back-btn{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:14px;transition:all .3s ease;display:flex;align-items:center;gap:8px;text-decoration:none}
        .back-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,0.3)}
        .page-info h1{font-size:24px;color:#333;margin:0 0 5px 0;font-weight:600}
        .page-info p{color:#666;margin:0;font-size:13px}
        .user-section{display:flex;align-items:center;gap:15px}
        .notification-container{position:relative}
        .notification-icon{position:relative;width:20px;height:20px;cursor:pointer;color:#666;transition:color .3s ease}
        .notification-icon:hover{color:#4A90E2}
        .notification-badge{position:absolute;top:-8px;right:-8px;background:#ff4757;color:#fff;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:600}
        .profile-dropdown{position:relative}
        .user-info{display:flex;align-items:center;cursor:pointer;gap:10px}
        .avatar{width:32px;height:32px;border-radius:50%;background:#4A90E2;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:600;text-transform:uppercase}
        .user-details strong{display:block;font-size:13px;color:#333}
        .user-details small{color:#666;font-size:11px}
        .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:1000}
        .dropdown-menu a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px}
        .dropdown-menu a:hover{background:#f8f9fa}

        /* Content */
        .content{padding:30px}

        /* Breadcrumb */
        .breadcrumb{background:#fff;padding:15px 20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.05);display:flex;align-items:center;gap:10px;font-size:14px}
        .breadcrumb a{color:#4A90E2;text-decoration:none;transition:color .3s ease}
        .breadcrumb a:hover{color:#2DA8FF}
        .breadcrumb .separator{color:#ccc}
        .breadcrumb .current{color:#666;font-weight:500}

        /* Card */
        .treatment-detail-card{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:transform .3s ease}
        .treatment-detail-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.12)}
        .card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid #f1f3f4}
        .card-icon{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px}
        .card-title h2{color:#333;margin:0 0 5px 0;font-size:24px;font-weight:600}
        .card-title p{color:#666;margin:0;font-size:14px}

        .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .detail-section{background:#f8f9fa;padding:20px;border-radius:8px;border-left:4px solid #4A90E2}
        .detail-section h3{color:#333;margin:0 0 15px 0;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
        .detail-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e9ecef}
        .detail-item:last-child{border-bottom:none}
        .detail-label{font-weight:600;color:#555;font-size:14px}
        .detail-value{color:#333;font-weight:500;font-size:14px;text-align:right;max-width:60%}
        .queue-id-badge{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}

        .diagnosis-section{grid-column:1 / -1;background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(5,150,105,0.05));border-left-color:#10b981}
        .diagnosis-content{background:#fff;padding:15px;border-radius:6px;border:1px solid #d1fae5;font-style:italic;color:#065f46;line-height:1.5}

        /* Status */
        .status-indicator{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;background:linear-gradient(135deg,#d1f2eb,#a3e9d0);color:#0c5a40;border:1px solid #10b981}
        .status-dot{width:8px;height:8px;border-radius:50%;background:#10b981}

        /* Actions */
        .action-buttons{display:flex;gap:15px;margin-top:30px;padding-top:20px;border-top:2px solid #f1f3f4}
        .btn{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
        .btn-primary{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,0.3)}
        .btn-secondary{background:#f8f9fa;color:#666;border:2px solid #e9ecef}
        .btn-secondary:hover{background:#e9ecef;transform:translateY(-1px)}

        /* Loading */
        .loading{display:none;text-align:center;padding:60px;color:#666;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .loading-spinner{width:50px;height:50px;border:4px solid rgba(74,144,226,0.1);border-top:4px solid #4A90E2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

        /* Toast */
        .toast{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:8px;color:#fff;font-size:14px;font-weight:500;z-index:4000;box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideInRight .3s ease;min-width:300px}
        .toast.success{background:linear-gradient(135deg,#10b981,#059669)}
        .toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
        .toast.info{background:linear-gradient(135deg,#4A90E2,#2DA8FF)}
        @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

        /* Responsive */
        @media (max-width:768px){
            .sidebar{width:100%;height:auto;position:relative}
            .main{margin-left:0}
            .top-bar{flex-direction:column;gap:15px;align-items:stretch}
            .detail-grid{grid-template-columns:1fr}
            .action-buttons{flex-direction:column}
            .card-header{flex-direction:column;text-align:center}
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">ü¶∑</div>
            <h3>Smile Clinic</h3>
        </div>
        <ul>
            <li><a href="/admin/dashboard"><i class="fas fa-chart-bar"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
            <li><a href="/admin/schedule"><i class="fas fa-calendar-alt"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î</a></li>
            <li><a href="/admin/appointments"><i class="fas fa-hospital"></i> ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
            <li><a href="/admin/dentists"><i class="fas fa-user-md"></i> ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</a></li>
            <li class="active"><a href="/admin/patients"><i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
            <li><a href="/admin/treatments"><i class="fas fa-tooth"></i> ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</a></li>
        </ul>
    </div>

    <!-- Main -->
    <div class="main">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="back-section">
                <a href="/admin/patients/1/treatments" class="back-btn" id="backButton">
                    <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
                </a>
                <div class="page-info">
                    <h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h1>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</p>
                </div>
            </div>
            <div class="user-section">
                <div class="notification-container">
                    <i class="fas fa-bell notification-icon" onclick="showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ','info')"></i>
                    <div class="notification-badge" id="notificationBadge">0</div>
                </div>
                <div class="profile-dropdown">
                    <div class="user-info" onclick="toggleDropdown()">
                        <div class="avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</strong>
                            <small>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</small>
                        </div>
                        <i class="fas fa-caret-down"></i>
                    </div>
                    <div class="dropdown-menu" id="profileDropdown">
                        <a href="/admin/profile"><i class="fas fa-user"></i> ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                        <hr />
                        <a href="/logout"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="/admin/patients"><i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a>
                <span class="separator"><i class="fas fa-chevron-right"></i></span>
                <a href="/admin/patients/1/treatments" id="patientLink">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a>
                <span class="separator"><i class="fas fa-chevron-right"></i></span>
                <span class="current">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</span>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤...</p>
            </div>

            <!-- Card -->
            <div class="treatment-detail-card" id="treatmentCard" style="display:none;">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-tooth"></i></div>
                    <div class="card-title">
                        <h2 id="treatmentTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                        <p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
                    </div>
                    <div class="status-indicator" id="statusChip">
                        <div class="status-dot"></div><span id="statusText">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
                    </div>
                </div>

                <div class="detail-grid">
                    <!-- Appointment -->
                    <div class="detail-section">
                        <h3><i class="fas fa-calendar-check"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
                        <div class="detail-item">
                            <span class="detail-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏¥‡∏ß:</span>
                            <span class="detail-value"><span class="queue-id-badge" id="queueId">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                            <span class="detail-value" id="appointmentDate">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‡πÄ‡∏ß‡∏•‡∏≤:</span>
                            <span class="detail-value" id="appointmentTime">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</span>
                            <span class="detail-value" id="treatmentName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                    </div>

                    <!-- Doctor -->
                    <div class="detail-section">
                        <h3><i class="fas fa-user-md"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
                        <div class="detail-item">
                            <span class="detail-label">‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå:</span>
                            <span class="detail-value" id="doctorName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á:</span>
                            <span class="detail-value" id="doctorSpecialty">‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‡∏ô‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</span>
                            <span class="detail-value" id="nextAppointment">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                        </div>
                    </div>

                    <!-- Diagnosis -->
                    <div class="detail-section diagnosis-section">
                        <h3><i class="fas fa-stethoscope"></i> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏≤‡∏á‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h3>
                        <div class="diagnosis-content" id="diagnosisContent">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢...</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="action-buttons">
                    <a href="/admin/patients/1/treatments" class="btn btn-secondary" id="backToHistoryBtn">
                        <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
                    </a>
                    <button class="btn btn-primary" onclick="printTreatment()">
                        <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                    <button class="btn btn-primary" onclick="scheduleFollowUp()">
                        <i class="fas fa-calendar-plus"></i> ‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TH = 'th-TH';
        let treatmentData = null;
        let patientId = null;
        let queueId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö /admin/patients/:id/treatments/:queueId ‡πÅ‡∏•‡∏∞‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
            const m = window.location.pathname.match(/\/admin\/patients\/(\d+)\/treatments\/([\w-]+)(?:\/)?$/);
            if (m) {
                patientId = m[1];
                queueId = m[2];
            }
            if (!patientId || !queueId) {
                showToast('‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
                setTimeout(()=>window.location.href='/admin/patients', 1800);
                return;
            }

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            ['backButton','patientLink','backToHistoryBtn'].forEach(id=>{
                const el = document.getElementById(id);
                if (el) el.href = `/admin/patients/${patientId}/treatments`;
            });

            updateUserAvatar();
            loadTreatmentDetails();
        });

        async function updateUserAvatar(){
            try{
                const r = await fetch('/admin/profile/api');
                if (r.ok){
                    const data = await r.json();
                    const first = data.email ? data.email.charAt(0).toUpperCase() : 'A';
                    document.getElementById('userAvatar').textContent = first;
                }else document.getElementById('userAvatar').textContent='A';
            }catch{ document.getElementById('userAvatar').textContent='A'; }
        }

        async function loadTreatmentDetails(){
            const loading = document.getElementById('loading');
            const card = document.getElementById('treatmentCard');
            loading.style.display='block'; card.style.display='none';

            try{
                const res = await fetch(`/admin/api/patients/${patientId}/treatments/${queueId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                treatmentData = normalizeTreatment(data.treatment);
            }catch(e){
                // Fallback ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏´‡∏≤‡∏Å API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)
                const now = new Date();
                treatmentData = {
                    queue_id: queueId,
                    status: 'completed',
                    date: now.toISOString(),
                    treatment_name: '‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°‡∏ã‡∏µ‡πà 38',
                    dentist_name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ó‡∏π‡∏ò‡πÅ‡∏°‡∏ô',
                    specialty: '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å',
                    diagnosis: '‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î‡∏ã‡∏µ‡πà 38 ‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞ pericoronitis ‡πÄ‡∏õ‡πá‡∏ô‡πÜ‡∏´‡∏≤‡∏¢‡πÜ ‡∏ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô',
                };
                showToast('‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°','info');
            }finally{
                populateTreatmentDetails();
                loading.style.display='none';
                card.style.display='block';
            }
        }

        function normalizeTreatment(t){
            // ‡πÅ‡∏õ‡∏•‡∏á/‡πÄ‡∏ï‡∏¥‡∏° field ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á UI
            const d = t.date ? new Date(t.date) : new Date();
            return {
                queue_id: t.queue_id || queueId,
                status: (t.status || 'completed').toLowerCase(),
                date: d.toISOString(),
                treatment_name: t.treatment_name || t.treatment || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤',
                dentist_name: t.dentist_name || (t.dentist ? `${t.dentist.fname} ${t.dentist.lname}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
                specialty: t.specialty || t.dentist_specialty || '‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                diagnosis: t.diagnosis || t.note || ''
            };
        }

        function populateTreatmentDetails(){
            const d = new Date(treatmentData.date);
            const dateStr = d.toLocaleDateString(TH,{year:'numeric',month:'long',day:'numeric'});
            const timeStr = d.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit',hour12:false});

            document.getElementById('treatmentTitle').textContent = treatmentData.treatment_name;
            document.getElementById('queueId').textContent = `#Y-${treatmentData.queue_id}`;
            document.getElementById('appointmentDate').textContent = dateStr;
            document.getElementById('appointmentTime').textContent = timeStr;
            document.getElementById('treatmentName').textContent = treatmentData.treatment_name;

            document.getElementById('doctorName').textContent = `‡∏ó‡∏û. ${treatmentData.dentist_name}`;
            document.getElementById('doctorSpecialty').textContent = treatmentData.specialty || '‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

            const diag = document.getElementById('diagnosisContent');
            if (treatmentData.diagnosis && String(treatmentData.diagnosis).trim()){
                diag.textContent = treatmentData.diagnosis;
            }else{
                diag.innerHTML = '<em style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</em>';
            }

            // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const chip = document.getElementById('statusChip');
            const txt = document.getElementById('statusText');
            const map = {
                completed:{text:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', color:'#10b981'},
                pending:{text:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', color:'#f59e0b'},
                cancelled:{text:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', color:'#ef4444'}
            };
            const s = map[treatmentData.status] || map.completed;
            txt.textContent = s.text;
            chip.querySelector('.status-dot').style.background = s.color;
            chip.style.borderColor = s.color;
        }

        function printTreatment(){
            const d = new Date(treatmentData.date);
            const dateStr = d.toLocaleDateString(TH,{year:'numeric',month:'long',day:'numeric'});
            const timeStr = d.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit',hour12:false});

            const w = window.open('','_blank');
            w.document.write(`
                <!DOCTYPE html>
                <html><head>
                    <meta charset="utf-8">
                    <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>
                    <style>
                        body{font-family:Tahoma,Arial,sans-serif;padding:24px}
                        .header{text-align:center;margin-bottom:20px;border-bottom:2px solid #333;padding-bottom:12px}
                        .header h1{margin:0} .sub{color:#666}
                        .row{margin-bottom:8px}
                        .label{display:inline-block;width:160px;font-weight:bold}
                        .box{margin-top:14px;padding:12px;background:#f8fafc;border-left:4px solid #4A90E2}
                        .muted{color:#666;font-size:12px;margin-top:28px;text-align:center}
                    </style>
                </head><body>
                    <div class="header">
                        <h1>ü¶∑ Smile Clinic</h1>
                        <div class="sub">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>
                        <div class="sub">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏¥‡∏ß: #Y-${treatmentData.queue_id}</div>
                    </div>
                    <div class="row"><span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${dateStr}</div>
                    <div class="row"><span class="label">‡πÄ‡∏ß‡∏•‡∏≤:</span> ${timeStr}</div>
                    <div class="row"><span class="label">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</span> ${treatmentData.treatment_name}</div>
                    <div class="row"><span class="label">‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå:</span> ‡∏ó‡∏û. ${treatmentData.dentist_name}</div>
                    <div class="row"><span class="label">‡∏™‡∏≤‡∏Ç‡∏≤:</span> ${treatmentData.specialty || '‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</div>
                    <div class="box">
                        <strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong>
                        <div>${(treatmentData.diagnosis || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢').replace(/</g,'&lt;')}</div>
                    </div>
                    <div class="muted">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString(TH,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false})}</div>
                    <script>window.onload=()=>window.print()</script>
                </body></html>
            `);
            w.document.close();
        }

        function scheduleFollowUp(){
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•...','info');
            setTimeout(()=>{ window.location.href = `/admin/appointments/add?patient_id=${patientId}&follow_up=true`; },800);
        }

        function toggleDropdown(){
            const menu = document.getElementById('profileDropdown');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function showToast(message, type='info'){
            document.querySelectorAll('.toast').forEach(t=>t.remove());
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            const icon = type==='success'?'check-circle':(type==='error'?'exclamation-circle':'info-circle');
            el.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(el);
            setTimeout(()=>{ el.style.animation='slideOutRight .3s ease'; setTimeout(()=>el.remove(),300); },4200);
        }

        // Close dropdown outside
        document.addEventListener('click', (e)=>{
            const pd = document.querySelector('.profile-dropdown');
            if (pd && !pd.contains(e.target)) document.getElementById('profileDropdown').style.display='none';
        });

        // Shortcuts
        document.addEventListener('keydown', (e)=>{
            if (e.key==='Escape') window.location.href = `/admin/patients/${patientId}/treatments`;
            if ((e.ctrlKey||e.metaKey) && e.key==='p'){ e.preventDefault(); printTreatment(); }
        });

        // Online/Offline
        window.addEventListener('online', ()=>showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','success'));
        window.addEventListener('offline', ()=>showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢','error'));

        // Perf log
        window.addEventListener('load', ()=>console.log(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô ~${Math.round(performance.now())}ms`));
    </script>
</body>
</html>