<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - Smile Clinic</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Sarabun','Segoe UI',sans-serif}
    body{background:#f5f7fa;margin:0}

    /* Sidebar */
    .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;padding:0;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,.1);z-index:1000}
    .sidebar .logo{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
    .sidebar .logo h3{margin:0;font-size:16px;font-weight:600}
    .sidebar ul{list-style:none;padding:10px 0;margin:0}
    .sidebar ul li{margin:2px 0}
    .sidebar ul li a{display:flex;align-items:center;gap:8px;padding:12px 20px;color:rgba(255,255,255,.9);text-decoration:none;transition:.3s;font-size:14px}
    .sidebar ul li.active a,.sidebar ul li:hover a{background:rgba(255,255,255,.2);color:#fff;border-radius:8px;margin:0 10px}

    /* Main / Top Bar (match treatments page) */
    .main{margin-left:180px;min-height:100vh}
    .top-bar{background:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .page-info h1{font-size:22px;margin:0 0 4px;color:#333;font-weight:600}
    .page-info p{font-size:13px;color:#666;margin:0}
    .search-section{display:flex;align-items:center;gap:15px}
    .search-box{background:#f8f9fa;border:1px solid #e1e5e9;border-radius:20px;padding:8px 15px;display:flex;align-items:center;width:300px;transition:.3s}
    .search-box:focus-within{border-color:#4A90E2;box-shadow:0 0 0 2px rgba(74,144,226,.1)}
    .search-box i{color:#666;margin-right:8px;font-size:14px}
    .search-box input{border:none;background:transparent;outline:none;width:100%;font-size:13px;color:#333}

    .user-section{display:flex;align-items:center;gap:15px}
    .notification-container{position:relative}
    .notification-icon{font-size:18px;color:#666;cursor:pointer;transition:.2s}
    .notification-icon:hover{color:#4A90E2}
    .notification-badge{position:absolute;top:-8px;right:-8px;background:#ff4757;color:#fff;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:600}
    .notification-badge.show{display:flex;animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    .notification-dropdown{position:absolute;top:100%;right:-10px;background:#fff;border:1px solid #e1e5e9;border-radius:12px;min-width:380px;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.15);display:none;max-height:500px;overflow:hidden;z-index:2000}
    .notification-dropdown.show{display:block;animation:slideDown .25s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .notification-header{padding:20px;border-bottom:1px solid #e1e5e9;background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;display:flex;justify-content:space-between;align-items:center}
    .notification-content{max-height:400px;overflow-y:auto;padding:10px}
    .notification-item{padding:12px;border-bottom:1px solid #f1f3f4;cursor:pointer;transition:.2s}
    .notification-item:hover{background:#f8f9fa}
    .notification-title{font-weight:600;color:#333;font-size:13px;margin-bottom:3px}
    .notification-message{color:#666;font-size:12px;margin-bottom:5px;line-height:1.3}
    .notification-time{color:#999;font-size:11px}
    .mark-all-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;cursor:pointer}

    .profile-dropdown{position:relative}
    .user-info{display:flex;gap:10px;align-items:center;cursor:pointer;padding:5px;border-radius:8px;transition:.2s}
    .user-info:hover{background:#f8f9fa}
    .avatar{width:32px;height:32px;border-radius:50%;background:#4A90E2;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .user-details strong{display:block;font-size:13px;color:#333}
    .user-details small{color:#666;font-size:11px}
    .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .dropdown-menu a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px}
    .dropdown-menu a:hover{background:#f8f9fa}

    /* Content */
    .content{padding:30px}

    /* Buttons consistent */
    .btn{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:.3s}
    .btn-primary{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(74,144,226,.3)}
    .btn-secondary{background:#f8f9fa;color:#666;border:1px solid #e1e5e9}

    /* Existing page blocks keep your styles */
    .date-navigation{background:#fff;padding:25px;border-radius:16px;margin-bottom:25px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .calendar-title{font-size:18px;font-weight:600;color:#333}
    .week-navigation{display:flex;gap:10px}
    .nav-btn{background:#fff;border:2px solid #e1e5e9;border-radius:50%;width:44px;height:44px;cursor:pointer;font-size:16px;color:#666;transition:.3s;display:flex;align-items:center;justify-content:center}
    .nav-btn:hover{background:#4A90E2;color:#fff;border-color:#4A90E2;transform:scale(1.05)}
    .date-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .date-button{background:#fff;border:2px solid #e1e5e9;border-radius:12px;padding:15px 12px;text-align:center;cursor:pointer;font-size:12px;line-height:1.3;color:#666;transition:.3s;min-width:80px;display:flex;flex-direction:column;align-items:center;position:relative}
    .date-button:hover{background:#f8f9fa;border-color:#4A90E2;transform:translateY(-3px);box-shadow:0 6px 20px rgba(74,144,226,.2)}
    .date-button.active{background:#4A90E2;color:#fff;border-color:#4A90E2;transform:translateY(-3px);box-shadow:0 6px 20px rgba(74,144,226,.3)}
    .date-button.today{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-color:#10b981}
    .day-name{font-weight:600;font-size:10px;opacity:.9;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
    .day-number{font-weight:700;font-size:16px}
    .appointment-count{position:absolute;top:-5px;right:-5px;background:#ff4757;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .date-button.active .appointment-count{background:#fff;color:#4A90E2;border-color:#4A90E2}
    .date-button.today .appointment-count{background:#fff;color:#10b981;border-color:#10b981}

    .stats-bar{background:#fff;padding:25px;border-radius:16px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .stats-info{display:flex;align-items:center;gap:25px;color:#666;font-size:14px}
    .stat-item{display:flex;align-items:center;gap:10px;padding:8px 15px;background:#f8f9fa;border-radius:8px}
    .stat-item i{color:#4A90E2;font-size:18px}
    .stat-number{font-weight:700;color:#333;font-size:16px}

    .filter-toggle{padding:10px 18px;background:#f8f9fa;border:1px solid #e1e5e9;border-radius:8px;color:#666;font-size:13px;cursor:pointer;transition:.3s;font-weight:500}
    .filter-toggle:hover,.filter-toggle.active{background:#4A90E2;color:#fff;border-color:#4A90E2;transform:translateY(-2px)}

    .filter-panel{background:#fff;border-radius:16px;margin-bottom:25px;box-shadow:0 4px 20px rgba(0,0,0,.08);display:none;overflow:hidden}
    .filter-panel.show{display:block;animation:slideDown .4s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .filter-content{padding:25px}
    .filter-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;align-items:end}
    .filter-group{display:flex;flex-direction:column;gap:8px}
    .filter-group label{font-weight:600;color:#333;font-size:13px}
    .filter-group select{padding:12px 16px;border:1px solid #e1e5e9;border-radius:8px;font-size:14px;transition:.3s;background:#f8f9fa}
    .filter-group select:focus{outline:none;border-color:#4A90E2;background:#fff;box-shadow:0 0 0 3px rgba(74,144,226,.1)}
    .filter-input{padding:12px 16px;border:1px solid #e1e5e9;border-radius:8px;font-size:14px;transition:.3s;background:#f8f9fa;width:100%}
    .filter-input:focus{outline:none;border-color:#4A90E2;background:#fff;box-shadow:0 0 0 3px rgba(74,144,226,.1)}

    .table-section{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .appointments-table{width:100%;border-collapse:collapse;font-size:14px}
    .appointments-table thead{background:#f8f9fa}
    .appointments-table th{padding:18px 20px;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #e1e5e9;font-size:13px;white-space:nowrap}
    .appointments-table td{padding:18px 20px;border-bottom:1px solid #f1f3f4;color:#333;vertical-align:middle}
    .appointments-table tbody tr{transition:.2s}
    .appointments-table tbody tr:hover{background:rgba(74,144,226,.05)}
    .time-cell{font-family:Monaco,monospace;color:#4A90E2;font-weight:600;font-size:13px}
    .time-display{font-weight:700;font-size:14px;color:#4A90E2}
    .date-display{font-size:11px;color:#666;margin-top:2px;font-weight:normal}
    .patient-name{font-weight:600;color:#333;font-size:14px}
    .treatment-name{font-weight:500;color:#333;font-size:13px}
    .status-badge{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-flex;align-items:center;gap:5px;min-width:90px;justify-content:center}
    .status-pending{background:linear-gradient(135deg,#fff3cd,#ffeaa7);color:#856404;border:1px solid #fdcb6e}
    .status-confirm{background:linear-gradient(135deg,#d1f2eb,#a7f3d0);color:#065f46;border:1px solid #6ee7b7}
    .status-cancel{background:linear-gradient(135deg,#fee2e2,#fecaca);color:#991b1b;border:1px solid #f87171}
    .btn-view-detail{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:6px}
    .btn-view-detail:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(74,144,226,.3)}
    .appointments-table td:last-child{text-align:center}

    .loading{text-align:center;padding:80px 20px;color:#666}
    .loading-spinner{width:60px;height:60px;border:4px solid rgba(74,144,226,.1);border-top:4px solid #4A90E2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 25px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360)}}

    .empty-state{text-align:center;padding:80px 20px;color:#666;display:none}
    .empty-icon{font-size:64px;color:#ddd;margin-bottom:25px}

    .toast{position:fixed;top:25px;right:25px;padding:16px 24px;border-radius:12px;color:#fff;font-size:14px;font-weight:500;z-index:4000;box-shadow:0 8px 30px rgba(0,0,0,.2);min-width:320px;display:none;align-items:center;gap:12px}
    .toast.show{display:flex;animation:slideInRight .4s ease}
    .toast.success{background:linear-gradient(135deg,#10b981,#059669)}
    .toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

    @media (max-width:768px){
      .sidebar{width:100%;height:auto;position:relative}
      .main{margin-left:0}
      .top-bar{flex-direction:column;gap:15px;align-items:stretch}
      .search-box{width:100%}
      .date-buttons{gap:8px}
      .date-button{min-width:65px;padding:12px 8px}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">ü¶∑</div>
      <h3>Smile Clinic</h3>
    </div>
    <ul>
      <li><a href="/admin/dashboard"><i class="fas fa-chart-bar"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
      <li><a href="/admin/schedule"><i class="fas fa-calendar-alt"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</a></li>
      <li class="active"><a href="/admin/appointments"><i class="fas fa-hospital"></i> ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
      <li><a href="/admin/dentists"><i class="fas fa-user-md"></i> ‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</a></li>
      <li><a href="/admin/patients"><i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
      <li><a href="/admin/treatments"><i class="fas fa-tooth"></i> ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Top Bar (now identical pattern) -->
    <div class="top-bar">
      <div class="page-info">
        <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
        <p>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏à‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
      </div>

      <div class="search-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." id="searchInput"/>
        </div>
      </div>

      <div class="user-section">
        <!-- Notifications -->
        <div class="notification-container">
          <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
          <div class="notification-badge" id="notificationBadge">0</div>
          <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
              <strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</strong>
              <button class="mark-all-btn" onclick="markAllAsRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div id="notificationContent" class="notification-content">
              <div style="text-align:center;color:#666;padding:20px;">
                <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc;"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile dropdown -->
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleProfileDropdown()">
            <div class="avatar" id="userAvatar">A</div>
            <div class="user-details">
              <strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</strong>
              <small>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div id="profileDropdown" class="dropdown-menu">
            <a href="/admin/profile"><i class="fas fa-user"></i> ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
            <hr/>
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Page header -->
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px">
        <div class="page-info">
          <h1>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
          <p>‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô</p>
        </div>
        <div class="page-actions">
          <a href="/admin/appointments/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> ‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
          </a>
        </div>
      </div>

      <!-- Week nav -->
      <div class="date-navigation">
        <div class="calendar-header">
          <div class="calendar-title">
            <i class="fas fa-calendar-week"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            <small style="font-weight:normal;color:#666;font-size:12px;margin-left:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</small>
          </div>
          <div class="week-navigation">
            <button id="prevWeek" class="nav-btn" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"><i class="fas fa-chevron-left"></i></button>
            <button id="nextWeek" class="nav-btn" title="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="date-buttons" id="dateButtons"></div>
        <div style="text-align:center;margin-top:15px;color:#666;font-size:13px;">
          <i class="fas fa-info-circle" style="margin-right:5px;"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-bar">
        <div class="stats-info">
          <div class="stat-item">
            <i class="fas fa-calendar-check"></i>
            <div>
              <span class="stat-number" id="appointmentCount">0</span>
              <span>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ <span id="selectedDateText">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></span>
            </div>
          </div>
          <div class="stat-item" id="pendingStatItem" style="display:none;">
            <i class="fas fa-clock"></i>
            <div>
              <span class="stat-number" id="pendingCount">0</span>
              <span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
            </div>
          </div>
          <div class="stat-item" id="confirmedStatItem" style="display:none;">
            <i class="fas fa-check-circle"></i>
            <div>
              <span class="stat-number" id="confirmedCount">0</span>
              <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
          </div>
          <div class="stat-item" id="cancelledStatItem" style="display:none;">
            <i class="fas fa-times-circle"></i>
            <div>
              <span class="stat-number" id="cancelledCount">0</span>
              <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
          </div>
        </div>
        <div class="tools-section">
          <button class="filter-toggle" onclick="toggleFilters()" id="filterToggle"><i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
          <button class="btn btn-secondary" onclick="refreshAppointments()" title="‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-panel" id="filterPanel">
        <div class="filter-content">
          <div class="filter-row">
            <div class="filter-group">
              <label>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <select id="filterDateRange" onchange="toggleDateRangeInputs()">
                <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
              </select>
            </div>
            <div class="filter-group" id="customDateGroup" style="display:none;">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
              <input type="date" id="filterDateFrom" class="filter-input">
            </div>
            <div class="filter-group" id="customDateToGroup" style="display:none;">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
              <input type="date" id="filterDateTo" class="filter-input">
            </div>
            <div class="filter-group">
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="filterStatus">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                <option value="confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
              </select>
            </div>
            <div class="filter-group">
              <label>‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
              <select id="filterDentist"><option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select>
            </div>
            <div class="filter-group">
              <label>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
              <select id="filterTreatment"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
            </div>
            <div class="filter-actions" style="grid-column:1 / -1; display:flex; gap:12px; justify-content:flex-end; margin-top:15px;">
              <button class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
      </div>

      <!-- Table -->
      <div class="table-section" id="tableSection" style="display:none;">
        <div class="table-container">
          <table class="appointments-table">
            <thead>
              <tr>
                <th><i class="fas fa-clock"></i> ‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th><i class="fas fa-user"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                <th><i class="fas fa-info-circle"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th style="text-align:center;"><i class="fas fa-cogs"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="appointmentTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Empty -->
      <div class="empty-state" id="emptyState">
        <div class="empty-icon"><i class="fas fa-calendar-times"></i></div>
        <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
        <a href="/admin/appointments/add" class="btn btn-primary"><i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</a>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toastMessage"><i class="fas fa-check-circle"></i><span></span></div>

  <script>
    // ======= State =======
    let weekOffset = 0;
    let selectedDate = null;
    let appointmentsData = [];
    let originalAppointmentsData = [];
    let filtersActive = false;

    const thaiMonths = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
    const thaiDays = ['‡∏≠‡∏≤.','‡∏à.','‡∏≠.','‡∏û.','‡∏û‡∏§.','‡∏®.','‡∏™.'];
    const TH_MONTHS_FULL = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    const TH_DAYS_FULL = ['‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò','‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå','‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå'];

    document.addEventListener('DOMContentLoaded', ()=>{
      const today = new Date();
      selectedDate = formatDateForAPI(today);

      // Set default filter to 'today' to show today's appointments
      document.getElementById('filterDateRange').value = 'today';

      initializePage();
      setupEventListeners();
      generateDateButtons();
      loadFilterOptions();
      loadWeekAppointments();
      loadAppointments();

      // Setup UI (Topbar additions)
      updateUserAvatar();
      loadNotifications();
      setupGlobalClickClose();

      // Auto refresh appointments every 30s
      setInterval(()=>{ loadWeekAppointments(); loadAppointments(); }, 30000);
    });

    // ======= Topbar helpers (match treatments page) =======
    function toggleNotifications(){
      document.getElementById('notificationDropdown').classList.toggle('show');
    }
    function toggleProfileDropdown(){
      const el = document.getElementById('profileDropdown');
      el.style.display = (el.style.display==='block'?'none':'block');
    }
    function setupGlobalClickClose(){
      document.addEventListener('click', (e)=>{
        const pd = document.querySelector('.profile-dropdown');
        if(pd && !pd.contains(e.target)){ const m=document.getElementById('profileDropdown'); if(m) m.style.display='none'; }
        const nc = document.querySelector('.notification-container');
        if(nc && !nc.contains(e.target)){ const dd=document.getElementById('notificationDropdown'); if(dd) dd.classList.remove('show'); }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.getElementById('notificationDropdown')?.classList.remove('show'); const m=document.getElementById('profileDropdown'); if(m) m.style.display='none'; }});
    }
    async function updateUserAvatar(){
      try{
        const res = await fetch('/admin/profile/api');
        if(res.ok){
          const data = await res.json();
          if(data.success && data.email){
            document.getElementById('userAvatar').textContent = data.email.charAt(0).toUpperCase();
          }
        }
      }catch(e){ document.getElementById('userAvatar').textContent = 'A'; }
    }
    async function loadNotifications(){
      try{
        const res = await fetch('/admin/api/notifications?limit=20');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const list = data.notifications || [];
        const badge = document.getElementById('notificationBadge');
        const unread = list.filter(x=>x.is_read===0).length;
        if(unread>0){ badge.textContent = unread>99?'99+':unread; badge.classList.add('show'); } else { badge.classList.remove('show'); }
        const wrap = document.getElementById('notificationContent');
        if(list.length===0){
          wrap.innerHTML = `<div style="text-align:center;color:#666;padding:20px;">
            <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc;"></i>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p></div>`;
          return;
        }
        wrap.innerHTML = list.map(n=>`
          <div class="notification-item ${n.is_read? '' : 'unread'}">
            <div class="notification-title">${escapeHtml(n.title||'‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')}</div>
            <div class="notification-message">${escapeHtml(n.message||'-')}</div>
            <div class="notification-time">${fmtDateTime24(n.created_at||new Date())}</div>
          </div>
        `).join('');
      }catch(e){
        document.getElementById('notificationContent').innerHTML = '<div style="padding:16px;color:#b91c1c;"><i class="fas fa-triangle-exclamation"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
      }
    }
    function markAllAsRead(){
      fetch('/admin/api/notifications/mark-all-read',{method:'PUT'}).then(()=>loadNotifications());
    }
    const TH_MONTHS = TH_MONTHS_FULL;
    function pad2(n){return n.toString().padStart(2,'0')}
    function fmtDateTime24(s){
      const d = new Date(s);
      if(isNaN(d)) return '-';
      const dd = d.getDate(), mm = TH_MONTHS[d.getMonth()], yy = d.getFullYear()+543;
      const hh = pad2(d.getHours()), mi = pad2(d.getMinutes());
      return `${dd} ${mm} ${yy} ‚Ä¢ ${hh}:${mi}`;
    }
    function escapeHtml(t){const d=document.createElement('div'); d.textContent = String(t||''); return d.innerHTML;}

    // ======= Existing page logic (unchanged) =======
    function formatDateForAPI(date){const y=date.getFullYear();const m=String(date.getMonth()+1).padStart(2,'0');const d=String(date.getDate()).padStart(2,'0');return `${y}-${m}-${d}`;}
    function parseDateFromAPI(s){const [y,m,d]=s.split('-');return new Date(parseInt(y),parseInt(m)-1,parseInt(d));}
    function initializePage(){updateSelectedDateText();}
    function setupEventListeners(){
      document.getElementById('prevWeek').addEventListener('click', ()=>{weekOffset--;generateDateButtons();loadWeekAppointments();loadAppointments();});
      document.getElementById('nextWeek').addEventListener('click', ()=>{weekOffset++;generateDateButtons();loadWeekAppointments();loadAppointments();});
      let t; document.getElementById('searchInput').addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=>{ filterAppointments(); },500); });
      ['filterStatus','filterDentist','filterTreatment','filterDateRange','filterDateFrom','filterDateTo'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', filterAppointments); });
    }
    function generateDateButtons(){
      const container=document.getElementById('dateButtons'); const today=new Date(); container.innerHTML='';
      for(let i=0;i<7;i++){
        const date=new Date(); date.setDate(today.getDate()+weekOffset*7+i);
        const iso=formatDateForAPI(date); const isToday=formatDateForAPI(today)===iso; const isSelected=selectedDate===iso;
        const btn=document.createElement('button'); btn.className=`date-button ${isSelected?'active':''} ${isToday?'today':''}`; btn.dataset.date=iso;
        
        // Get appointment count for this date
        const appointmentCount = getAppointmentCountForDate(iso);
        const countDisplay = appointmentCount > 0 ? `<div class="appointment-count">${appointmentCount}</div>` : '';
        
        btn.innerHTML=`<div class="day-name">${thaiDays[date.getDay()]}</div><div class="day-number">${date.getDate()}</div><div class="day-month">${thaiMonths[date.getMonth()]}</div>${countDisplay}`;
        btn.addEventListener('click',()=>{ 
          document.querySelectorAll('.date-button').forEach(b=>b.classList.remove('active')); 
          btn.classList.add('active'); 
          selectedDate=iso; 
          updateSelectedDateText(); 
          console.log('Selected date:', selectedDate); // Debug log
          
          // Set filter to 'today' when selecting a specific date
          document.getElementById('filterDateRange').value = 'today';
          loadAppointments(); 
        });
        container.appendChild(btn);
      }
    }
    function updateSelectedDateText(){
      try{
        const d=parseDateFromAPI(selectedDate); const today=new Date(); const todayStr=formatDateForAPI(today); const el=document.getElementById('selectedDateText');
        if(selectedDate===todayStr){ el.textContent='‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'; }
        else{ el.textContent = `${TH_DAYS_FULL[d.getDay()]}‡∏ó‡∏µ‡πà ${d.getDate()} ${TH_MONTHS_FULL[d.getMonth()]} ${d.getFullYear()+543}`; }
      }catch{ document.getElementById('selectedDateText').textContent='‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'; }
    }
    async function loadFilterOptions(){
      try{
        const dr = await fetch('/admin/api/dentists');
        if(dr.ok){ const dj = await dr.json(); if(dj.success && dj.dentists){ const sel=document.getElementById('filterDentist'); dj.dentists.forEach(x=>{const o=document.createElement('option'); o.value=x.dentist_id; o.textContent=`‡∏ó‡∏û. ${x.fname} ${x.lname}`; sel.appendChild(o);}); }}
        const tr = await fetch('/admin/api/treatments');
        if(tr.ok){ const tj = await tr.json(); if(tj.success && tj.treatments){ const sel=document.getElementById('filterTreatment'); tj.treatments.forEach(x=>{const o=document.createElement('option'); o.value=x.treatment_id; o.textContent=x.treatment_name; sel.appendChild(o);}); }}
      }catch(e){ console.error('Error loading filter options',e); }
    }
    async function loadAppointments(){
      try{
        document.getElementById('loading').style.display='block';
        document.getElementById('tableSection').style.display='none';
        document.getElementById('emptyState').style.display='none';
        
        // Build query parameters
        const params = new URLSearchParams();
        
        // Check if filters are active
        const dateRange = document.getElementById('filterDateRange').value;
        const fromDate = document.getElementById('filterDateFrom').value;
        const toDate = document.getElementById('filterDateTo').value;
        let dateToUse = null;
        
        // If custom date range is selected, use those dates
        if(dateRange === 'custom' && (fromDate || toDate)){
          if(fromDate) params.append('date_from', fromDate);
          if(toDate) params.append('date_to', toDate);
        } else if(dateRange === 'week'){
          // Load week data
          const today = new Date();
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() + weekOffset * 7);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          params.append('date_from', formatDateForAPI(weekStart));
          params.append('date_to', formatDateForAPI(weekEnd));
        } else if(dateRange === 'month'){
          // Load month data
          const today = new Date();
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          params.append('date_from', formatDateForAPI(monthStart));
          params.append('date_to', formatDateForAPI(monthEnd));
        } else if(dateRange === 'today'){
          // Load today's appointments or selected date
          dateToUse = selectedDate || formatDateForAPI(new Date());
          params.append('date', dateToUse);
          console.log('Loading TODAY/SELECTED appointments:', dateToUse);
        } else {
          // Default to selected date
          params.append('date', selectedDate);
          console.log('Loading SELECTED DATE appointments:', selectedDate);
        }
        
        // Add filter parameters if active
        const status = document.getElementById('filterStatus').value;
        const dentist = document.getElementById('filterDentist').value;
        const treatment = document.getElementById('filterTreatment').value;
        const search = document.getElementById('searchInput').value.trim();
        
        if(status) params.append('status', status);
        if(dentist) params.append('dentist_id', dentist);
        if(treatment) params.append('treatment_id', treatment);
        if(search) params.append('search', search);
        
        console.log('Date range filter:', dateRange); // Debug log
        console.log('Selected date:', selectedDate); // Debug log
        console.log('Date to use:', dateToUse || 'N/A'); // Debug log
        console.log('Other filters - Status:', status, 'Dentist:', dentist, 'Treatment:', treatment, 'Search:', search);
        console.log('Loading appointments with params:', params.toString()); // Debug log
        const res = await fetch(`/admin/api/appointments?${params.toString()}`);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        console.log('Appointments loaded:', data.appointments?.length || 0, 'appointments'); // Debug log
        if(data.success){
          appointmentsData = data.appointments || [];
          originalAppointmentsData = [...appointmentsData];
          renderAppointments(appointmentsData);
          updateAppointmentCount(appointmentsData.length);
          updateFilterToggleState();
          
          // Update date buttons with appointment counts
          updateDateButtonsWithCounts();
        }else{ throw new Error(data.error||'Failed to load appointments'); }
      }catch(e){ console.error(e); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ: '+e.message,'error'); renderEmptyState(); }
      finally{ document.getElementById('loading').style.display='none'; }
    }
    function renderAppointments(list){
      const tbody=document.getElementById('appointmentTableBody'); const tableSection=document.getElementById('tableSection'); const empty=document.getElementById('emptyState');
      if(!list || list.length===0){ tableSection.style.display='none'; empty.style.display='block'; return; }
      tableSection.style.display='block'; empty.style.display='none';
      tbody.innerHTML = list.map(a=>{
        const statusText = formatStatus(a.queue_status);
        const start = a.time ? new Date(a.time) : null;
        const end = a.time_end ? new Date(a.time_end) : null;
        const formattedRange = (start && end) ? `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')} - ${String(end.getHours()).padStart(2,'0')}:${String(end.getMinutes()).padStart(2,'0')}` : (a.time ? formatDateTime(a.time) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
        const icon = a.queue_status==='pending'?'fas fa-clock':(a.queue_status==='confirm'?'fas fa-check-circle':(a.queue_status==='cancel'?'fas fa-times-circle':'fas fa-question-circle'));
        
        // Format date display
        const appointmentDate = start ? formatDateDisplay(start) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        
        return `<tr data-id="${a.queue_id}">
          <td class="time-cell">
            <div class="time-display">${formattedRange}</div>
            <div class="date-display">${appointmentDate}</div>
          </td>
          <td>
            <div class="patient-name">${escapeHtml(a.patient_name)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
          </td>
          <td><span class="status-badge status-${a.queue_status}"><i class="${icon}"></i> ${statusText}</span></td>
          <td><button class="btn-view-detail" onclick="viewAppointmentDetail(${a.queuedetail_id})"><i class="fas fa-eye"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
        </tr>`;
      }).join('');
    }
    function getStatusIcon(s){return s==='pending'?'fas fa-clock':(s==='confirm'?'fas fa-check-circle':(s==='cancel'?'fas fa-times-circle':'fas fa-question-circle'))}
    function viewAppointmentDetail(id){window.location.href=`/admin/appointments/detail?id=${id}`;}
    function formatDateTime(dt){
      if(!dt) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      try{
        const d=new Date(dt); if(isNaN(d.getTime())) return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        const today=new Date(); const isToday = d.toDateString()===today.toDateString();
        const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); const t=`${hh}:${mm}`;
        if(isToday) return `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ${t}`;
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${t}`;
      }catch{ return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
    }
    
    function formatDateDisplay(date){
      if(!date) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      try{
        const d = new Date(date);
        if(isNaN(d.getTime())) return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        const today = new Date();
        const isToday = d.toDateString() === today.toDateString();
        const isTomorrow = d.toDateString() === new Date(today.getTime() + 24*60*60*1000).toDateString();
        
        if(isToday) return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
        if(isTomorrow) return '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ';
        
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
      }catch{ return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
    }
    function formatStatus(s){ if(s==='pending')return'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; if(s==='confirm')return'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; if(s==='cancel')return'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; return s; }
    function renderEmptyState(){ document.getElementById('tableSection').style.display='none'; document.getElementById('emptyState').style.display='block'; }
    function updateAppointmentCount(total){
      const pending = (appointmentsData||[]).filter(a=>a.queue_status==='pending').length;
      const confirmed = (appointmentsData||[]).filter(a=>a.queue_status==='confirm').length;
      const cancelled = (appointmentsData||[]).filter(a=>a.queue_status==='cancel').length;
      
      document.getElementById('appointmentCount').textContent = total;
      
      // Update pending count
      const ps = document.getElementById('pendingStatItem');
      if(pending>0){ ps.style.display='flex'; document.getElementById('pendingCount').textContent=pending; }
      else{ ps.style.display='none'; }
      
      // Update confirmed count
      const cs = document.getElementById('confirmedStatItem');
      if(confirmed>0){ cs.style.display='flex'; document.getElementById('confirmedCount').textContent=confirmed; }
      else{ cs.style.display='none'; }
      
      // Update cancelled count
      const cans = document.getElementById('cancelledStatItem');
      if(cancelled>0){ cans.style.display='flex'; document.getElementById('cancelledCount').textContent=cancelled; }
      else{ cans.style.display='none'; }
      
      const badge=document.getElementById('notificationBadge');
      if(pending>0){ badge.textContent=pending; badge.classList.add('show'); } else { badge.classList.remove('show'); }
    }
    
    function getAppointmentCountForDate(dateStr){
      // Count appointments for a specific date from the week data
      const weekData = window.weekAppointmentsData || [];
      if(weekData.length === 0) return 0;
      
      return weekData.filter(appointment => {
        if(!appointment.time) return false;
        const appointmentDate = formatDateForAPI(new Date(appointment.time));
        return appointmentDate === dateStr;
      }).length;
    }
    
    function updateDateButtonsWithCounts(){
      // Update appointment counts on date buttons
      const dateButtons = document.querySelectorAll('.date-button');
      dateButtons.forEach(button => {
        const dateStr = button.dataset.date;
        const count = getAppointmentCountForDate(dateStr);
        
        // Remove existing count display
        const existingCount = button.querySelector('.appointment-count');
        if(existingCount) {
          existingCount.remove();
        }
        
        // Add new count display if there are appointments
        if(count > 0) {
          const countDisplay = document.createElement('div');
          countDisplay.className = 'appointment-count';
          countDisplay.textContent = count;
          button.appendChild(countDisplay);
        }
      });
    }
    
    async function loadWeekAppointments(){
      // Load appointments for the entire week to show counts on date buttons
      try {
        const today = new Date();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() + weekOffset * 7);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const params = new URLSearchParams();
        params.append('date_from', formatDateForAPI(weekStart));
        params.append('date_to', formatDateForAPI(weekEnd));
        
        const res = await fetch(`/admin/api/appointments?${params.toString()}`);
        if(res.ok) {
          const data = await res.json();
          if(data.success) {
            // Store week data for counting
            window.weekAppointmentsData = data.appointments || [];
            updateDateButtonsWithCounts();
          }
        }
      } catch(e) {
        console.error('Error loading week appointments:', e);
      }
    }
    function filterAppointments(){
      // Use server-side filtering by reloading appointments
      loadAppointments();
    }
    function updateFilterToggleState(){
      const term=document.getElementById('searchInput').value.trim();
      const st=document.getElementById('filterStatus').value;
      const de=document.getElementById('filterDentist').value;
      const tr=document.getElementById('filterTreatment').value;
      const dateRange=document.getElementById('filterDateRange').value;
      const fromDate=document.getElementById('filterDateFrom').value;
      const toDate=document.getElementById('filterDateTo').value;
      
      const active=[term,st,de,tr].filter(Boolean).length;
      const dateRangeActive = dateRange !== 'today' || fromDate || toDate;
      const totalActive = active + (dateRangeActive ? 1 : 0);
      
      const btn=document.getElementById('filterToggle');
      if(totalActive>0){ 
        btn.classList.add('active'); 
        btn.innerHTML=`<i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (${totalActive})`; 
        filtersActive=true; 
      } else { 
        btn.classList.remove('active'); 
        btn.innerHTML='<i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á'; 
        filtersActive=false; 
      }
    }
    function applyFilters(){ 
      filterAppointments(); 
      showToast('‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); 
    }
    function clearFilters(){
      document.getElementById('filterStatus').value='';
      document.getElementById('filterDentist').value='';
      document.getElementById('filterTreatment').value='';
      document.getElementById('searchInput').value='';
      document.getElementById('filterDateRange').value='today';
      document.getElementById('filterDateFrom').value='';
      document.getElementById('filterDateTo').value='';
      toggleDateRangeInputs();
      filtersActive=false;
      document.getElementById('filterToggle').classList.remove('active');
      document.getElementById('filterToggle').innerHTML='<i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á';
      
      // Reset to today's date
      const today = new Date();
      selectedDate = formatDateForAPI(today);
      
      // Update date buttons to show today as active
      document.querySelectorAll('.date-button').forEach(btn => {
        btn.classList.remove('active');
        if(btn.dataset.date === selectedDate) {
          btn.classList.add('active');
        }
      });
      
      updateSelectedDateText();
      // Reload appointments without filters
      loadAppointments();
      showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß','success');
    }
    function toggleFilters(){ document.getElementById('filterPanel').classList.toggle('show'); }
    function refreshAppointments(){ showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...','success'); loadAppointments(); }
    
    function toggleDateRangeInputs(){
      const dateRange = document.getElementById('filterDateRange').value;
      const customDateGroup = document.getElementById('customDateGroup');
      const customDateToGroup = document.getElementById('customDateToGroup');
      
      if(dateRange === 'custom'){
        customDateGroup.style.display = 'flex';
        customDateToGroup.style.display = 'flex';
      } else {
        customDateGroup.style.display = 'none';
        customDateToGroup.style.display = 'none';
      }
    }
    
    function getDateRangeParams(){
      const dateRange = document.getElementById('filterDateRange').value;
      const today = new Date();
      const todayStr = formatDateForAPI(today);
      
      switch(dateRange){
        case 'today':
          return { date: todayStr };
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          return { 
            date_from: formatDateForAPI(weekStart), 
            date_to: formatDateForAPI(weekEnd) 
          };
        case 'month':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          return { 
            date_from: formatDateForAPI(monthStart), 
            date_to: formatDateForAPI(monthEnd) 
          };
        case 'custom':
          const fromDate = document.getElementById('filterDateFrom').value;
          const toDate = document.getElementById('filterDateTo').value;
          if(fromDate && toDate){
            return { date_from: fromDate, date_to: toDate };
          } else if(fromDate){
            return { date_from: fromDate };
          } else if(toDate){
            return { date_to: toDate };
          }
          return {};
        case 'all':
        default:
          return {};
      }
    }

    // ======= Toast =======
    function showToast(message,type='success'){
      const toast=document.getElementById('toastMessage'); const icon=toast.querySelector('i');
      toast.className='toast'; toast.classList.add(type,'show');
      const iconMap={success:'check-circle',error:'exclamation-circle',info:'info-circle'};
      icon.className=`fas fa-${iconMap[type]||'info-circle'}`;
      toast.querySelector('span').textContent=message;
      setTimeout(()=>{toast.classList.remove('show');},3000);
    }
  </script>
</body>
</html>
