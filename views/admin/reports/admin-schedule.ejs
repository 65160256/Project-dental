<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ตารางเวลาทันตแพทย์ - Smile Clinic</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:#f5f7fa}

    /* Sidebar */
    .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,.1);z-index:1000}
    .sidebar .logo{padding:20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
    .sidebar .logo h3{font-size:16px;font-weight:600}
    .sidebar ul{list-style:none;padding:10px 0}
    .sidebar ul li{margin:2px 0}
    .sidebar ul li a{display:flex;gap:8px;align-items:center;padding:12px 20px;color:rgba(255,255,255,.9);text-decoration:none;transition:.3s}
    .sidebar ul li.active a,.sidebar ul li:hover a{background:rgba(255,255,255,.2);color:#fff;border-radius:8px;margin:0 10px}

    /* Main */
    .main{margin-left:180px;min-height:100vh}

    /* Top bar */
    .top-bar{background:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .search-section{display:flex;align-items:center;gap:15px}
    .search-section label{font-weight:500;color:#555;font-size:14px}
    .search-box{background:#f8f9fa;border:1px solid #e1e5e9;border-radius:20px;padding:8px 15px;display:flex;align-items:center;width:250px;transition:.2s}
    .search-box:focus-within{border-color:#4A90E2;box-shadow:0 0 0 2px rgba(74,144,226,.1)}
    .search-box i{color:#666;margin-right:8px;font-size:14px}
    .search-box input{border:none;background:transparent;outline:none;width:100%;font-size:13px}

    .user-section{display:flex;align-items:center;gap:15px}
    .notification-container{position:relative}
    .notification-icon{width:20px;height:20px;color:#666;cursor:pointer;transition:.2s}
    .notification-icon:hover{color:#4A90E2}
    .notification-badge{position:absolute;top:-8px;right:-8px;background:#ff4757;color:#fff;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:600}
    .notification-badge.show{display:flex;animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

    .notification-dropdown{position:absolute;top:100%;right:-10px;background:#fff;border:1px solid #e1e5e9;border-radius:12px;min-width:380px;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:2000;display:none;max-height:500px;overflow:hidden}
    .notification-dropdown.show{display:block;animation:slideDown .3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .notification-header{padding:20px;border-bottom:1px solid #e1e5e9;background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
    .notification-header h3{margin:0;font-size:18px;font-weight:600}
    .notification-content{max-height:400px;overflow-y:auto;padding:10px}
    .notification-item{padding:12px;border-bottom:1px solid #f1f3f4;cursor:pointer;transition:.2s}
    .notification-item:hover{background:#f8f9fa}
    .notification-title{font-weight:600;color:#333;font-size:13px;margin-bottom:3px}
    .notification-message{color:#666;font-size:12px;margin-bottom:5px;line-height:1.3}
    .notification-time{color:#999;font-size:11px}

    .profile-dropdown{position:relative}
    .user-info{display:flex;align-items:center;gap:10px;cursor:pointer}
    .avatar{width:32px;height:32px;border-radius:50%;background:#4A90E2;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;text-transform:uppercase}
    .user-details strong{display:block;font-size:13px;color:#333}
    .user-details small{color:#666;font-size:11px}
    .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:1000}
    .dropdown-menu a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px}
    .dropdown-menu a:hover{background:#f8f9fa}

    /* Content */
    .content{padding:30px}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .page-title h1{font-size:24px;color:#333;font-weight:600}
    .page-title p{color:#666;font-size:13px}
    .page-actions{display:flex;gap:15px;align-items:center}

    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:.2s;text-decoration:none}
    .btn-primary{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,.3)}
    .btn-secondary{background:#f8f9fa;color:#333;border:1px solid #e1e5e9}
    .btn-secondary:hover{background:#eef1f5}

    .calendar-section{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:30px}
    .calendar-header{background:linear-gradient(135deg,rgba(74,144,226,.1),rgba(45,168,255,.1));padding:25px 30px;border-bottom:1px solid #e1e5e9;display:flex;justify-content:space-between;align-items:center}
    .calendar-header h3{font-size:18px;font-weight:600;color:#333;margin:0}
    .calendar-controls{display:flex;gap:10px;align-items:center}
    .view-toggle{display:flex;background:#f8f9fa;border-radius:8px;padding:4px;gap:2px}
    .view-btn{padding:8px 12px;background:transparent;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;color:#666;transition:.2s}
    .view-btn.active{background:#fff;color:#4A90E2;box-shadow:0 1px 3px rgba(0,0,0,.1)}

    .legend{display:flex;gap:25px;margin-bottom:25px;padding:20px 30px;background:linear-gradient(135deg,rgba(74,144,226,.05),rgba(45,168,255,.05));border-bottom:1px solid #e1e5e9}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:#333}
    .legend-color{width:16px;height:16px;border-radius:4px;border:2px solid}

    .calendar-container{padding:0}

    /* FullCalendar tweaks */
    .fc{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    .fc-header-toolbar{background:#fff;padding:20px 30px;margin-bottom:0 !important;border-bottom:1px solid #e1e5e9}
    .fc-toolbar-title{color:#333 !important;font-size:20px !important;font-weight:600 !important}
    .fc-button-primary{background:#4A90E2 !important;border:1px solid #4A90E2 !important;border-radius:6px !important;font-weight:500 !important;font-size:13px !important;padding:8px 16px !important}
    .fc-button-primary:hover{background:#357abd !important;border-color:#357abd !important}
    .fc-daygrid{padding:0 30px 30px}
    .fc-event{border-radius:6px !important;padding:4px 8px !important;font-size:11px !important;font-weight:500 !important;border:none !important;box-shadow:0 1px 3px rgba(0,0,0,.1) !important;margin-bottom:2px !important}
    .fc-daygrid-day:hover{background:rgba(74,144,226,.05) !important}
    .fc-day-today{background:rgba(74,144,226,.08) !important}
    .fc-daygrid-day-number{color:#333 !important;font-weight:600 !important}

    /* Event colors */
    .fc-event.working-hours{background:#e8f5e8 !important;color:#2e7d32 !important;border-left:3px solid #2e7d32 !important}
    .fc-event.working-hours-appointments{background:#fce4ec !important;color:#c2185b !important;border-left:3px solid #c2185b !important}
    .fc-event.day-off{background:#f5f5f5 !important;color:#999 !important;border-left:3px solid #999 !important}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#666;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(74,144,226,.1);border-top:4px solid #4A90E2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000;display:none;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:12px;padding:30px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid #e1e5e9}
    .modal-title{font-size:18px;font-weight:600;color:#333;margin:0}
    .close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.2s}
    .close:hover{background:#f8f9fa;color:#333}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;color:#fff;font-size:14px;font-weight:500;z-index:4000;box-shadow:0 4px 12px rgba(0,0,0,.15);animation:slideInRight .3s ease;max-width:300px}
    .toast.success{background:#10b981}
    .toast.error{background:#ef4444}
    .toast.info{background:#3b82f6}
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

    /* Responsive */
    @media (max-width:768px){
      .sidebar{width:100%;height:auto;position:relative}
      .main{margin-left:0}
      .top-bar{flex-direction:column;gap:15px;align-items:stretch}
      .search-box{width:100%}
      .page-header{flex-direction:column;align-items:flex-start;gap:15px}
      .legend{flex-direction:column;gap:15px}
      .calendar-header{flex-direction:column;gap:15px;align-items:flex-start}
      .fc-toolbar{flex-direction:column !important;gap:15px !important}
      .fc-toolbar-chunk{display:flex !important;justify-content:center !important}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">🦷</div>
      <h3>Smile Clinic</h3>
    </div>
    <ul>
      <li><a href="/admin/dashboard"><i class="fas fa-chart-bar"></i> แดชบอร์ด</a></li>
      <li class="active"><a href="/admin/schedule"><i class="fas fa-calendar-alt"></i> ตารางเวลา</a></li>
      <li><a href="/admin/appointments"><i class="fas fa-hospital"></i> การนัดหมาย</a></li>
      <li><a href="/admin/dentists"><i class="fas fa-user-md"></i> ทันตแพทย์</a></li>
      <li><a href="/admin/patients"><i class="fas fa-users"></i> ผู้ป่วย</a></li>
      <li><a href="/admin/treatments"><i class="fas fa-tooth"></i> การรักษา</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="search-section">
        <label>ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="ทันตแพทย์, ตารางเวลา หรือวันที่..." id="searchInput" />
        </div>
      </div>
      <div class="user-section">
        <div class="notification-container">
          <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
          <div class="notification-badge" id="notificationBadge">0</div>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header"><h3>การแจ้งเตือน</h3></div>
            <div class="notification-content" id="notificationContent">
              <div style="text-align:center;color:#666;padding:20px">
                <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc"></i>
                <p>ไม่มีการแจ้งเตือนใหม่</p>
              </div>
            </div>
          </div>
        </div>
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()">
            <div class="avatar" id="userAvatar">A</div>
            <div class="user-details">
              <strong>สวัสดี ผู้ดูแลระบบ</strong>
              <small>ผู้ดูแลระบบ</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/admin/profile"><i class="fas fa-user"></i> โปรไฟล์ของฉัน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="page-header">
        <div class="page-title">
          <h1>ตารางเวลาทันตแพทย์</h1>
          <p>ดูและจัดการตารางเวลาและการนัดหมายของทันตแพทย์ทั้งหมด</p>
        </div>
        <div class="page-actions">
          <a href="/admin/appointments/add" class="btn btn-primary"><i class="fas fa-plus"></i> นัดหมายใหม่</a>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>กำลังโหลดข้อมูลตารางเวลา...</p>
      </div>

      <!-- Calendar -->
      <div class="calendar-section" id="calendarSection" style="display:none">
        <div class="calendar-header">
          <h3><i class="fas fa-calendar-alt"></i> ปฏิทินตารางเวลาทันตแพทย์</h3>
          <div class="calendar-controls">
            <!-- คงปุ่มสลับมุมมองของเราไว้ และตัดของ FullCalendar ออกเพื่อไม่ให้ซ้ำ -->
            <div class="view-toggle">
              <button class="view-btn active" data-view="dayGridMonth">เดือน</button>
              <button class="view-btn" data-view="timeGridWeek">สัปดาห์</button>
              <button class="view-btn" data-view="timeGridDay">วัน</button>
            </div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background:#e8f5e8;border-color:#2e7d32"></div><span>เวลาทำงาน</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#fce4ec;border-color:#c2185b"></div><span>เวลาทำงาน (มีนัดหมาย)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#f5f5f5;border-color:#999"></div><span>วันหยุด</span></div>
        </div>

        <div class="calendar-container"><div id="calendar"></div></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">รายละเอียดตารางเวลา</h3>
        <button class="close" onclick="closeScheduleModal()" aria-label="ปิด">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    let notificationData = [];
    let calendar;

    document.addEventListener('DOMContentLoaded', () => {
      initializeCalendar();
      loadUserInfo();
      loadScheduleData();
      loadNotifications();
      setupEventListeners();
      setInterval(loadNotifications, 120000);
      setTimeout(()=>showToast('ยินดีต้อนรับสู่ระบบตารางเวลา','info'), 800);
    });

    async function loadUserInfo(){
      try{
        const res = await fetch('/admin/profile/api');
        if(!res.ok) throw new Error();
        const data = await res.json();
        const firstLetter = (data.success && data.email ? data.email.charAt(0) : 'A').toUpperCase();
        document.getElementById('userAvatar').textContent = firstLetter;
      }catch{ document.getElementById('userAvatar').textContent = 'A'; }
    }

    function initializeCalendar(){
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'th',
        initialView: 'dayGridMonth',
        // แก้ปุ่มซ้ำ: เอาปุ่ม view ออกจาก header ของ FullCalendar แล้วใช้ปุ่ม custom ด้านบนแทน
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        buttonText: { today: 'วันนี้' },
        height: 'auto',
        eventDisplay: 'block',
        dayMaxEvents: 3,
        moreLinkClick: 'popover',
        events: [],
        eventClick: handleCalendarEventClick,
        loading: (isLoading)=>{
          document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
          document.getElementById('calendarSection').style.display = isLoading ? 'none' : 'block';
        },
        eventDidMount: (info)=>{
          const props = info.event.extendedProps;
          if (props.type === 'dayoff') info.el.classList.add('day-off');
          else if (props.hasAppointments) info.el.classList.add('working-hours-appointments');
          else info.el.classList.add('working-hours');
          info.el.title = info.event.title;
        },
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        datesSet: syncViewButtons // อัปเดตสถานะปุ่ม custom ให้ตรงกับมุมมองปัจจุบัน
      });
      calendar.render();
    }

    function setupEventListeners(){
      // ปุ่มสลับมุมมองของเรา
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          calendar.changeView(this.dataset.view);
        });
      });

      // ค้นหาแบบเบาเครื่อง (debounce)
      let t;
      document.getElementById('searchInput').addEventListener('input', (e)=>{
        clearTimeout(t);
        const term = e.target.value.trim().toLowerCase();
        t = setTimeout(()=>{
          if (term.length > 2) filterCalendarEvents(term); else resetCalendarFilter();
        }, 200);
      });

      // ปิดเมนู/โมดอลเมื่อคลิกนอก
      document.addEventListener('click', (ev)=>{
        const pd = document.querySelector('.profile-dropdown');
        if (pd && !pd.contains(ev.target)) document.getElementById('profileDropdown').style.display='none';
        const nc = document.querySelector('.notification-container');
        if (nc && !nc.contains(ev.target)) document.getElementById('notificationDropdown').classList.remove('show');
        if (ev.target === document.getElementById('scheduleModal')) closeScheduleModal();
      });

      window.addEventListener('online', ()=>{ showToast('เชื่อมต่ออินเทอร์เน็ตแล้ว','success'); loadScheduleData(); loadNotifications(); });
      window.addEventListener('offline', ()=> showToast('ไม่มีการเชื่อมต่ออินเทอร์เน็ต','error'));
      window.addEventListener('error', (e)=>{ console.error(e.error); showToast('เกิดข้อผิดพลาดที่ไม่คาดคิด','error'); });
    }

    function syncViewButtons(){
      const view = calendar.view.type; // dayGridMonth | timeGridWeek | timeGridDay
      document.querySelectorAll('.view-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.view === view);
      });
    }

    async function loadScheduleData(){
      try{
        const res = await fetch('/admin/api/schedule');
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(!data.success) throw new Error(data.error || 'ไม่สามารถโหลดตารางเวลาได้');
        calendar.removeAllEvents();
        calendar.addEventSource(data.events);
        showToast('โหลดตารางเวลาสำเร็จ','success');
      }catch(err){
        console.error('โหลดตารางเวลา:', err);
        showToast('ไม่สามารถโหลดตารางเวลาได้: ' + err.message, 'error');
        document.getElementById('loading').style.display='none';
        document.getElementById('calendarSection').style.display='block';
      }
    }

    async function loadNotifications(){
      try{
        const res = await fetch('/admin/api/notifications?limit=10');
        if(!res.ok) throw new Error();
        const data = await res.json();
        if (data.success){
          notificationData = data.notifications || [];
          renderNotifications();
          updateNotificationBadge();
        } else { showEmptyNotifications(); }
      }catch(err){ console.error('โหลดการแจ้งเตือน:', err); showEmptyNotifications(); }
    }

    function renderNotifications(){
      const el = document.getElementById('notificationContent');
      if (!notificationData.length) return showEmptyNotifications();
      const items = notificationData
        .slice().sort((a,b)=> new Date(b.created_at) - new Date(a.created_at))
        .map(n=>`
          <div class="notification-item" data-id="${n.id}">
            <div class="notification-title">${n.title || 'แจ้งเตือน'}</div>
            <div class="notification-message">${n.message || ''}</div>
            <div class="notification-time">${formatNotificationDate(n.created_at)}</div>
          </div>`).join('');
      el.innerHTML = items;
    }

    function showEmptyNotifications(){
      document.getElementById('notificationContent').innerHTML = `
        <div style="text-align:center;color:#666;padding:20px">
          <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc"></i>
          <p>ไม่มีการแจ้งเตือนใหม่</p>
        </div>`;
    }

    function formatNotificationDate(s){
      try{
        const d = new Date(s); const now = new Date();
        const mins = Math.floor((now - d)/60000);
        if (mins < 1) return 'เมื่อสักครู่';
        if (mins < 60) return `${mins} นาทีที่แล้ว`;
        const hrs = Math.floor(mins/60); if (hrs < 24) return `${hrs} ชั่วโมงที่แล้ว`;
        const days = Math.floor(hrs/24); if (days < 7) return `${days} วันที่แล้ว`;
        return d.toLocaleDateString('th-TH');
      }catch{ return 'ไม่ทราบ'; }
    }

    function updateNotificationBadge(){
      const unread = notificationData.filter(n=>!n.is_read).length;
      const badge = document.getElementById('notificationBadge');
      if (unread > 0){ badge.textContent = unread > 99 ? '99+' : unread; badge.classList.add('show'); }
      else badge.classList.remove('show');
    }

    function handleCalendarEventClick(info){
      const ev = info.event; const p = ev.extendedProps || {};
      showScheduleModal(ev, p);
    }

    function showScheduleModal(event, props){
      const modal = document.getElementById('scheduleModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      modalTitle.textContent = 'รายละเอียดตารางเวลา';
      const d = new Date(event.start);
      const thaiDate = d.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      let html = `<div style="margin-bottom:20px">
        <h4 style="margin:0 0 15px;color:#333;border-bottom:2px solid #e1e5e9;padding-bottom:10px"><i class="fas fa-calendar-alt"></i> ข้อมูลตารางเวลา</h4>
        <p style="margin:8px 0"><strong>หัวข้อ:</strong> ${event.title}</p>
        <p style="margin:8px 0"><strong>วันที่:</strong> ${thaiDate}</p>`;
      if (props){
        if (props.dentist) html += `<p style="margin:8px 0"><strong>ทันตแพทย์:</strong> ทพ. ${props.dentist}</p>`;
        if (props.specialty) html += `<p style="margin:8px 0"><strong>ความเชี่ยวชาญ:</strong> ${props.specialty}</p>`;
        if (props.startTime && props.endTime) html += `<p style="margin:8px 0"><strong>เวลาทำงาน:</strong> ${props.startTime} - ${props.endTime} น.</p>`;
        if (+props.appointmentCount > 0) html += `<p style="margin:8px 0"><strong>จำนวนนัดหมาย:</strong> ${props.appointmentCount} รายการ</p>`;
        if (props.type === 'dayoff' && props.note) html += `<p style="margin:8px 0"><strong>หมายเหตุ:</strong> ${props.note}</p>`;
      }
      html += `</div>
        <div style="text-align:right;border-top:2px solid #e1e5e9;padding-top:20px">
          <a href="/admin/appointments" class="btn btn-primary" style="margin-right:10px"><i class="fas fa-list"></i> ดูการนัดหมาย</a>
          <button onclick="closeScheduleModal()" class="btn btn-secondary"><i class="fas fa-times"></i> ปิด</button>
        </div>`;
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
    }

    function closeScheduleModal(){ document.getElementById('scheduleModal').style.display='none'; }

    function filterCalendarEvents(term){
      calendar.getEvents().forEach(ev=>{
        const t = (ev.title||'').toLowerCase();
        const d = (ev.extendedProps?.dentist||'').toLowerCase();
        ev.setProp('display', (t.includes(term) || d.includes(term)) ? 'auto' : 'none');
      });
    }
    function resetCalendarFilter(){ calendar.getEvents().forEach(ev=>ev.setProp('display','auto')); }

    function toggleNotifications(){
      const dd = document.getElementById('notificationDropdown');
      dd.classList.toggle('show');
      if (dd.classList.contains('show')) loadNotifications();
    }
    function toggleDropdown(){
      const m = document.getElementById('profileDropdown');
      m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    function showToast(msg,type='info'){
      document.querySelectorAll('.toast').forEach(t=>t.remove());
      const el = document.createElement('div'); el.className = `toast ${type}`;
      const icon = {success:'check-circle',error:'exclamation-circle',info:'info-circle'}[type]||'info-circle';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><i class="fas fa-${icon}"></i><span>${msg}</span></div>`;
      document.body.appendChild(el);
      setTimeout(()=>{ if(el.parentNode){ el.style.animation='slideOutRight .3s ease'; setTimeout(()=>el.remove(),300); } }, 4000);
    }
  </script>
</body>
</html>
