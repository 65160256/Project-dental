<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ตารางเวรทันตแพทย์ - Smile Clinic</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:#f5f7fa}

    /* Sidebar */
    .sidebar{width:180px;background:linear-gradient(135deg,#4A90E2,#2DA8FF);position:fixed;height:100vh;color:#fff;box-shadow:2px 0 10px rgba(0,0,0,.1);z-index:1000}
    .sidebar .logo{padding:20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar .logo .logo-icon{width:50px;height:50px;border-radius:8px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px;color:#4A90E2}
    .sidebar .logo h3{font-size:16px;font-weight:600}
    .sidebar ul{list-style:none;padding:10px 0}
    .sidebar ul li{margin:2px 0}
    .sidebar ul li a{display:flex;gap:8px;align-items:center;padding:12px 20px;color:rgba(255,255,255,.9);text-decoration:none;transition:.3s}
    .sidebar ul li.active a,.sidebar ul li:hover a{background:rgba(255,255,255,.2);color:#fff;border-radius:8px;margin:0 10px}

    /* Main */
    .main{margin-left:180px;min-height:100vh}

    /* Top bar */
    .top-bar{background:#fff;padding:15px 30px;display:flex;justify-content:flex-end;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}

    .user-section{display:flex;align-items:center;gap:15px}
    .notification-container{position:relative}
    .notification-icon{width:20px;height:20px;color:#666;cursor:pointer;transition:.2s}
    .notification-icon:hover{color:#4A90E2}
    .notification-badge{position:absolute;top:-8px;right:-8px;background:#ff4757;color:#fff;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:600}
    .notification-badge.show{display:flex;animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

    .notification-dropdown{position:absolute;top:100%;right:-10px;background:#fff;border:1px solid #e1e5e9;border-radius:12px;min-width:380px;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:2000;display:none;max-height:500px;overflow:hidden}
    .notification-dropdown.show{display:block;animation:slideDown .3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .notification-header{padding:20px;border-bottom:1px solid #e1e5e9;background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
    .notification-header h3{margin:0;font-size:18px;font-weight:600}
    .notification-content{max-height:400px;overflow-y:auto;padding:10px}
    .notification-item{padding:12px;border-bottom:1px solid #f1f3f4;cursor:pointer;transition:.2s}
    .notification-item:hover{background:#f8f9fa}
    .notification-title{font-weight:600;color:#333;font-size:13px;margin-bottom:3px}
    .notification-message{color:#666;font-size:12px;margin-bottom:5px;line-height:1.3}
    .notification-time{color:#999;font-size:11px}

    .profile-dropdown{position:relative}
    .user-info{display:flex;align-items:center;gap:10px;cursor:pointer}
    .avatar{width:32px;height:32px;border-radius:50%;background:#4A90E2;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;text-transform:uppercase}
    .user-details strong{display:block;font-size:13px;color:#333}
    .user-details small{color:#666;font-size:11px}
    .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e1e5e9;border-radius:6px;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:1000}
    .dropdown-menu a{display:block;padding:10px 15px;text-decoration:none;color:#333;font-size:13px}
    .dropdown-menu a:hover{background:#f8f9fa}

    /* Content */
    .content{padding:30px}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .page-title h1{font-size:24px;color:#333;font-weight:600}
    .page-title p{color:#666;font-size:13px}
    .page-actions{display:flex;gap:15px;align-items:center}

    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:.2s;text-decoration:none}
    .btn-primary{background:linear-gradient(135deg,#4A90E2,#2DA8FF);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,.3)}
    .btn-secondary{background:#f8f9fa;color:#333;border:1px solid #e1e5e9}
    .btn-secondary:hover{background:#eef1f5}


    .calendar-section{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:30px}
    .calendar-header{background:linear-gradient(135deg,rgba(74,144,226,.1),rgba(45,168,255,.1));padding:25px 30px;border-bottom:1px solid #e1e5e9;display:flex;justify-content:space-between;align-items:center}
    .calendar-header h3{font-size:18px;font-weight:600;color:#333;margin:0}
    .calendar-controls{display:flex;gap:15px;align-items:center}
    .calendar-actions{display:flex;gap:10px}
    .view-toggle{display:flex;background:#f8f9fa;border-radius:8px;padding:4px;gap:2px}
    .view-btn{padding:8px 12px;background:transparent;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;color:#666;transition:.2s}
    .view-btn.active{background:#fff;color:#4A90E2;box-shadow:0 1px 3px rgba(0,0,0,.1)}

    /* Simple Legend */
    .simple-legend{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background:rgba(74,144,226,.05);border-bottom:1px solid #e1e5e9}
    .legend-items{display:flex;gap:20px}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:#333}
    .legend-color{width:14px;height:14px;border-radius:3px;border:2px solid}
    .legend-stats{display:flex;gap:15px;font-size:12px;color:#666}

    .calendar-container{padding:0}

    /* FullCalendar tweaks */
    .fc{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    .fc-header-toolbar{background:#fff;padding:20px 30px;margin-bottom:0 !important;border-bottom:1px solid #e1e5e9}
    .fc-toolbar-title{color:#333 !important;font-size:20px !important;font-weight:600 !important}
    .fc-button-primary{background:#4A90E2 !important;border:1px solid #4A90E2 !important;border-radius:6px !important;font-weight:500 !important;font-size:13px !important;padding:8px 16px !important}
    .fc-button-primary:hover{background:#357abd !important;border-color:#357abd !important}
    .fc-daygrid{padding:0 30px 30px}
    .fc-event{border-radius:6px !important;padding:4px 8px !important;font-size:11px !important;font-weight:500 !important;border:none !important;box-shadow:0 1px 3px rgba(0,0,0,.1) !important;margin-bottom:2px !important;cursor:pointer !important}
    .fc-event:hover{transform:translateY(-1px) !important;box-shadow:0 2px 6px rgba(0,0,0,.15) !important}
    .fc-daygrid-day:hover{background:rgba(74,144,226,.05) !important}
    .fc-day-today{background:rgba(74,144,226,.08) !important;border:2px solid #4A90E2 !important}
    .fc-daygrid-day-number{color:#333 !important;font-weight:600 !important;font-size:14px !important}
    
    /* ปฏิทิน Grid */
    .fc-daygrid-body{background:#fff}
    .fc-daygrid-day-frame{min-height:120px !important;padding:8px !important}
    .fc-daygrid-day-events{margin-top:8px !important}
    .fc-daygrid-day-top{flex-direction:row !important;justify-content:space-between !important}
    .fc-daygrid-day-number{padding:4px 8px !important;border-radius:4px !important;transition:.2s}
    .fc-daygrid-day-number:hover{background:rgba(74,144,226,.1) !important}
    
    /* หัวตาราง */
    .fc-col-header{background:linear-gradient(135deg,#f8f9fa,#e9ecef) !important;border-bottom:2px solid #dee2e6 !important}
    .fc-col-header-cell{font-weight:600 !important;color:#495057 !important;padding:12px 8px !important;font-size:14px !important}
    
    /* Week/Day View */
    .fc-timegrid-slot{height:40px !important}
    .fc-timegrid-slot-label{font-size:12px !important;color:#6c757d !important}
    .fc-timegrid-event{border-radius:6px !important;padding:2px 6px !important;font-size:12px !important}
    .fc-timegrid-event:hover{transform:scale(1.02) !important;z-index:1000 !important}
    
    /* ซ่อนวันอาทิตย์ */
    .fc-day-sun{display:none !important}
    .fc-col-header-cell[data-date*="Sunday"]{display:none !important}
    
    /* ปรับขนาดปฏิทิน */
    .fc-daygrid-day-frame{min-height:140px !important}
    .fc-daygrid-event{font-size:10px !important;line-height:1.2 !important;padding:2px 4px !important}
    .fc-daygrid-event-title{font-weight:500 !important}
    
    /* Tooltip */
    .fc-event[data-tooltip]:hover::after{
      content:attr(data-tooltip);
      position:absolute;
      background:#333;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      font-size:12px;
      white-space:pre-line;
      z-index:1000;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      pointer-events:none;
    }

    /* Event colors */
    .fc-event.working-hours{background:#e8f5e8 !important;color:#2e7d32 !important;border-left:3px solid #2e7d32 !important}
    .fc-event.working-hours-appointments{background:#fce4ec !important;color:#c2185b !important;border-left:3px solid #c2185b !important}
    .fc-event.day-off{background:#f5f5f5 !important;color:#999 !important;border-left:3px solid #999 !important}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#666;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(74,144,226,.1);border-top:4px solid #4A90E2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000;display:none;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:12px;padding:30px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid #e1e5e9}
    .modal-title{font-size:18px;font-weight:600;color:#333;margin:0}
    .close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.2s}
    .close:hover{background:#f8f9fa;color:#333}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;color:#fff;font-size:14px;font-weight:500;z-index:4000;box-shadow:0 4px 12px rgba(0,0,0,.15);animation:slideInRight .3s ease;max-width:300px}
    .toast.success{background:#10b981}
    .toast.error{background:#ef4444}
    .toast.info{background:#3b82f6}
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

    /* Responsive */
    @media (max-width:768px){
      .sidebar{width:100%;height:auto;position:relative}
      .main{margin-left:0}
      .top-bar{flex-direction:column;gap:15px;align-items:stretch}
      .page-header{flex-direction:column;align-items:flex-start;gap:15px}
      .simple-legend{flex-direction:column;gap:15px;align-items:flex-start}
      .legend-items{flex-wrap:wrap}
      .calendar-header{flex-direction:column;gap:15px;align-items:flex-start}
      .fc-toolbar{flex-direction:column !important;gap:15px !important}
      .fc-toolbar-chunk{display:flex !important;justify-content:center !important}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">🦷</div>
      <h3>Smile Clinic</h3>
    </div>
    <ul>
      <li><a href="/admin/dashboard"><i class="fas fa-chart-bar"></i> แดชบอร์ด</a></li>
      <li class="active"><a href="/admin/schedule"><i class="fas fa-calendar-alt"></i> ตารางเวร</a></li>
      <li><a href="/admin/appointments"><i class="fas fa-hospital"></i> การนัดหมาย</a></li>
      <li><a href="/admin/dentists"><i class="fas fa-user-md"></i> ทันตแพทย์</a></li>
      <li><a href="/admin/patients"><i class="fas fa-users"></i> ผู้ป่วย</a></li>
      <li><a href="/admin/treatments"><i class="fas fa-tooth"></i> การรักษา</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="user-section">
        <div class="notification-container">
          <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
          <div class="notification-badge" id="notificationBadge">0</div>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header"><h3>การแจ้งเตือน</h3></div>
            <div class="notification-content" id="notificationContent">
              <div style="text-align:center;color:#666;padding:20px">
                <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc"></i>
                <p>ไม่มีการแจ้งเตือนใหม่</p>
              </div>
            </div>
          </div>
        </div>
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()">
            <div class="avatar" id="userAvatar">A</div>
            <div class="user-details">
              <strong>สวัสดี ผู้ดูแลระบบ</strong>
              <small>ผู้ดูแลระบบ</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/admin/profile"><i class="fas fa-user"></i> โปรไฟล์ของฉัน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="page-header">
        <div class="page-title">
          <h1>ตารางเวลาทันตแพทย์</h1>
          <p>ดูและจัดการตารางเวลาและการนัดหมายของทันตแพทย์ทั้งหมด</p>
        </div>
        <div class="page-actions">
          <a href="/admin/appointments/add" class="btn btn-primary"><i class="fas fa-plus"></i> นัดหมายใหม่</a>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>กำลังโหลดข้อมูลตารางเวร...</p>
      </div>


      <!-- Calendar -->
      <div class="calendar-section" id="calendarSection" style="display:none">
        <div class="calendar-header">
          <h3><i class="fas fa-calendar-alt"></i> ปฏิทินตารางเวรทันตแพทย์</h3>
          <div class="calendar-controls">
            <div class="view-toggle">
              <button class="view-btn active" data-view="dayGridMonth">เดือน</button>
              <button class="view-btn" data-view="timeGridWeek">สัปดาห์</button>
              <button class="view-btn" data-view="timeGridDay">วัน</button>
            </div>
            <button class="btn btn-primary" onclick="refreshSchedule()">
              <i class="fas fa-sync"></i> รีเฟรช
            </button>
          </div>
        </div>

        <div class="simple-legend">
          <div class="legend-items">
            <div class="legend-item"><div class="legend-color" style="background:#e8f5e8;border-color:#2e7d32"></div><span>เข้าเวรว่าง</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#fce4ec;border-color:#c2185b"></div><span>เข้าเวร (มีนัดหมาย)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#e3f2fd;border-color:#1976d2"></div><span>วันนี้</span></div>
          </div>
          <div class="legend-stats">
            <span id="totalEvents">รวม: 0 ช่วงเวร</span>
            <span id="totalAppointments">นัดหมาย: 0 รายการ</span>
          </div>
        </div>

        <div class="calendar-container"><div id="calendar"></div></div>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">รายละเอียดตารางเวลา</h3>
        <button class="close" onclick="closeScheduleModal()" aria-label="ปิด">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    let notificationData = [];
    let calendar;
    let allEvents = [];

    document.addEventListener('DOMContentLoaded', () => {
      initializeCalendar();
      loadUserInfo();
      loadScheduleData();
      loadNotifications();
      setupEventListeners();
      setInterval(loadNotifications, 120000);
    });

    async function loadUserInfo(){
      try{
        const res = await fetch('/admin/profile/api');
        if(!res.ok) throw new Error();
        const data = await res.json();
        const firstLetter = (data.success && data.email ? data.email.charAt(0) : 'A').toUpperCase();
        document.getElementById('userAvatar').textContent = firstLetter;
      }catch{ document.getElementById('userAvatar').textContent = 'A'; }
    }

    function initializeCalendar(){
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'th',
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        buttonText: { 
          today: 'วันนี้',
          month: 'เดือน',
          week: 'สัปดาห์',
          day: 'วัน'
        },
        height: 'auto',
        eventDisplay: 'block',
        dayMaxEvents: 4,
        moreLinkClick: 'popover',
        events: [],
        eventClick: handleCalendarEventClick,
        dateClick: handleDateClick,
        loading: (isLoading)=>{
          document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
          document.getElementById('calendarSection').style.display = isLoading ? 'none' : 'block';
        },
        eventDidMount: (info)=>{
          const props = info.event.extendedProps;
          if (props.type === 'dayoff') {
            info.el.classList.add('day-off');
          } else if (props.hasAppointments) {
            info.el.classList.add('working-hours-appointments');
          } else {
            info.el.classList.add('working-hours');
          }
          
          // สร้าง tooltip ที่ละเอียดขึ้น
          let tooltip = `${props.dentist || 'ทันตแพทย์'}`;
          if (props.specialty) tooltip += `\nความเชี่ยวชาญ: ${props.specialty}`;
          if (props.startTime && props.endTime) tooltip += `\nเวลา: ${props.startTime} - ${props.endTime}`;
          if (props.appointmentCount > 0) tooltip += `\nนัดหมาย: ${props.appointmentCount} รายการ`;
          
          info.el.title = tooltip;
          info.el.setAttribute('data-tooltip', tooltip);
          
          // เพิ่ม animation เมื่อ hover
          info.el.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
            this.style.zIndex = '1000';
          });
          
          info.el.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.zIndex = 'auto';
          });
        },
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        datesSet: syncViewButtons,
        dayCellDidMount: (info) => {
          // ซ่อนวันอาทิตย์
          if (info.date.getDay() === 0) {
            info.el.style.display = 'none';
            return;
          }
          
          // ไฮไลท์วันนี้
          const today = new Date();
          if (info.date.toDateString() === today.toDateString()) {
            info.el.style.backgroundColor = 'rgba(74, 144, 226, 0.1)';
          }
          
          // เพิ่มข้อมูลสถิติในแต่ละวัน
          const dateStr = info.date.toISOString().split('T')[0];
          const dayEvents = allEvents.filter(event => event.start && event.start.split('T')[0] === dateStr);
          
          if (dayEvents.length > 0) {
            // นับจำนวนทันตแพทย์ที่ไม่ซ้ำกัน
            const uniqueDentists = new Set(dayEvents.map(event => event.extendedProps?.dentist).filter(Boolean));
            const totalAppointments = dayEvents.reduce((sum, event) => sum + (event.extendedProps?.appointmentCount || 0), 0);
            
            // เพิ่มข้อมูลสถิติในมุมขวาบนของแต่ละวัน
            const statsElement = document.createElement('div');
            statsElement.style.cssText = `
              position: absolute;
              top: 4px;
              right: 4px;
              font-size: 10px;
              color: #666;
              background: rgba(255,255,255,0.8);
              padding: 2px 4px;
              border-radius: 3px;
              pointer-events: none;
            `;
            
            let statsText = `${uniqueDentists.size} ทพ.`;
            if (totalAppointments > 0) {
              statsText += ` • ${totalAppointments} นัด`;
            }
            
            statsElement.textContent = statsText;
            info.el.appendChild(statsElement);
          }
        },
        dayHeaderDidMount: (info) => {
          // ซ่อนหัวคอลัมน์วันอาทิตย์
          if (info.text === 'อา') {
            info.el.style.display = 'none';
          }
        },
        // ปรับแต่งการแสดงผลของปฏิทิน
        dayMaxEventRows: 4,
        eventMaxStack: 3,
        eventOverlap: false,
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00'
      });
      calendar.render();
    }

    function setupEventListeners(){
      // ปุ่มสลับมุมมองของเรา
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          calendar.changeView(this.dataset.view);
        });
      });



      // ปิดเมนู/โมดอลเมื่อคลิกนอก
      document.addEventListener('click', (ev)=>{
        const pd = document.querySelector('.profile-dropdown');
        if (pd && !pd.contains(ev.target)) document.getElementById('profileDropdown').style.display='none';
        const nc = document.querySelector('.notification-container');
        if (nc && !nc.contains(ev.target)) document.getElementById('notificationDropdown').classList.remove('show');
        if (ev.target === document.getElementById('scheduleModal')) closeScheduleModal();
      });

      window.addEventListener('online', ()=>{ showToast('เชื่อมต่ออินเทอร์เน็ตแล้ว','success'); loadScheduleData(); loadNotifications(); });
      window.addEventListener('offline', ()=> showToast('ไม่มีการเชื่อมต่ออินเทอร์เน็ต','error'));
      window.addEventListener('error', (e)=>{ console.error(e.error); showToast('เกิดข้อผิดพลาดที่ไม่คาดคิด','error'); });
    }

    function syncViewButtons(){
      const view = calendar.view.type; // dayGridMonth | timeGridWeek | timeGridDay
      document.querySelectorAll('.view-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.view === view);
      });
    }


    async function loadScheduleData(){
      try{
        const res = await fetch('/admin/api/schedule');
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(!data.success) throw new Error(data.error || 'ไม่สามารถโหลดตารางเวลาได้');
        
        allEvents = data.events || [];
        
        calendar.removeAllEvents();
        calendar.addEventSource(allEvents);
        
        document.getElementById('loading').style.display='none';
        document.getElementById('calendarSection').style.display='block';
        
        updateStatistics();
      }catch(err){
        console.error('โหลดตารางเวลา:', err);
        document.getElementById('loading').style.display='none';
        document.getElementById('calendarSection').style.display='block';
      }
    }

    async function loadNotifications(){
      try{
        const res = await fetch('/admin/api/notifications?limit=10');
        if(!res.ok) throw new Error();
        const data = await res.json();
        if (data.success){
          notificationData = data.notifications || [];
          renderNotifications();
          updateNotificationBadge();
        } else { showEmptyNotifications(); }
      }catch(err){ console.error('โหลดการแจ้งเตือน:', err); showEmptyNotifications(); }
    }

    function renderNotifications(){
      const el = document.getElementById('notificationContent');
      if (!notificationData.length) return showEmptyNotifications();
      const items = notificationData
        .slice().sort((a,b)=> new Date(b.created_at) - new Date(a.created_at))
        .map(n=>`
          <div class="notification-item" data-id="${n.id}">
            <div class="notification-title">${n.title || 'แจ้งเตือน'}</div>
            <div class="notification-message">${n.message || ''}</div>
            <div class="notification-time">${formatNotificationDate(n.created_at)}</div>
          </div>`).join('');
      el.innerHTML = items;
    }

    function showEmptyNotifications(){
      document.getElementById('notificationContent').innerHTML = `
        <div style="text-align:center;color:#666;padding:20px">
          <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;color:#ccc"></i>
          <p>ไม่มีการแจ้งเตือนใหม่</p>
        </div>`;
    }

    function formatNotificationDate(s){
      try{
        const d = new Date(s); const now = new Date();
        const mins = Math.floor((now - d)/60000);
        if (mins < 1) return 'เมื่อสักครู่';
        if (mins < 60) return `${mins} นาทีที่แล้ว`;
        const hrs = Math.floor(mins/60); if (hrs < 24) return `${hrs} ชั่วโมงที่แล้ว`;
        const days = Math.floor(hrs/24); if (days < 7) return `${days} วันที่แล้ว`;
        return d.toLocaleDateString('th-TH');
      }catch{ return 'ไม่ทราบ'; }
    }

    function updateNotificationBadge(){
      const unread = notificationData.filter(n=>!n.is_read).length;
      const badge = document.getElementById('notificationBadge');
      if (unread > 0){ badge.textContent = unread > 99 ? '99+' : unread; badge.classList.add('show'); }
      else badge.classList.remove('show');
    }

    function handleCalendarEventClick(info){
      const ev = info.event; const p = ev.extendedProps || {};
      showScheduleModal(ev, p);
    }

    function handleDateClick(info){
      const clickedDate = info.dateStr;
      const dayOfWeek = info.date.getDay();
      
      // ถ้าคลิกวันอาทิตย์ ให้แสดงข้อความแจ้งเตือน
      if (dayOfWeek === 0) {
        showToast('วันอาทิตย์เป็นวันหยุด ไม่มีการให้บริการ', 'info');
        return;
      }
      
      // แสดงเมนูการดำเนินการสำหรับวันที่คลิก
      showDateActionMenu(clickedDate);
    }

    function showDateActionMenu(date) {
      // แค่เปลี่ยนไปมุมมองรายวัน
      calendar.changeView('timeGridDay', date);
    }

    function showScheduleModal(event, props){
      const modal = document.getElementById('scheduleModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      modalTitle.textContent = 'รายละเอียดตารางเวลา';
      const d = new Date(event.start);
      const thaiDate = d.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      
      let html = `<div style="margin-bottom:20px">
        <h4 style="margin:0 0 15px;color:#333;border-bottom:2px solid #e1e5e9;padding-bottom:10px"><i class="fas fa-calendar-alt"></i> ข้อมูลตารางเวลา</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
          <div>
            <p style="margin:8px 0"><strong>หัวข้อ:</strong> ${event.title}</p>
            <p style="margin:8px 0"><strong>วันที่:</strong> ${thaiDate}</p>`;
      
      if (props){
        if (props.dentist) html += `<p style="margin:8px 0"><strong>ทันตแพทย์:</strong> ทพ. ${props.dentist}</p>`;
        if (props.specialty) html += `<p style="margin:8px 0"><strong>ความเชี่ยวชาญ:</strong> ${props.specialty}</p>`;
        if (props.startTime && props.endTime) html += `<p style="margin:8px 0"><strong>ช่วงเวลาเวร:</strong> ${props.startTime} - ${props.endTime} น.</p>`;
        if (+props.appointmentCount > 0) html += `<p style="margin:8px 0"><strong>จำนวนนัดหมาย:</strong> <span style="color:#c2185b;font-weight:bold">${props.appointmentCount} รายการ</span></p>`;
        if (props.type === 'dayoff' && props.note) html += `<p style="margin:8px 0"><strong>หมายเหตุ:</strong> ${props.note}</p>`;
      }
      
      html += `</div>
          <div style="background:#f8f9fa;padding:15px;border-radius:8px">
            <h5 style="margin:0 0 10px;color:#555"><i class="fas fa-info-circle"></i> สถานะ</h5>`;
      
      if (props?.type === 'dayoff') {
        html += `<div style="color:#999;font-size:14px"><i class="fas fa-calendar-times"></i> วันหยุด</div>`;
      } else if (props?.hasAppointments) {
        html += `<div style="color:#c2185b;font-size:14px"><i class="fas fa-user-clock"></i> มีนัดหมาย</div>`;
      } else {
        html += `<div style="color:#2e7d32;font-size:14px"><i class="fas fa-clock"></i> เข้าเวรว่าง</div>`;
      }
      
      html += `</div></div></div>`;
      
      // Add close button
      html += `<div style="text-align:right;border-top:2px solid #e1e5e9;padding-top:20px">
        <button onclick="closeScheduleModal()" class="btn btn-secondary">
          <i class="fas fa-times"></i> ปิด
        </button>
      </div>`;
      
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
    }


    function closeScheduleModal(){ document.getElementById('scheduleModal').style.display='none'; }




    function refreshSchedule(){
      loadScheduleData();
    }

    function updateStatistics(){
      const totalEvents = allEvents.length;
      const workingDays = new Set(allEvents.map(event => event.start)).size;
      const totalAppointments = allEvents.reduce((sum, event) => {
        return sum + (event.extendedProps?.appointmentCount || 0);
      }, 0);
      
      document.getElementById('totalEvents').textContent = `รวม: ${totalEvents} ช่วงเวร`;
      document.getElementById('totalAppointments').textContent = `นัดหมาย: ${totalAppointments} รายการ`;
    }



    function toggleNotifications(){
      const dd = document.getElementById('notificationDropdown');
      dd.classList.toggle('show');
      if (dd.classList.contains('show')) loadNotifications();
    }
    function toggleDropdown(){
      const m = document.getElementById('profileDropdown');
      m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }


    function showToast(msg,type='info'){
      document.querySelectorAll('.toast').forEach(t=>t.remove());
      const el = document.createElement('div'); el.className = `toast ${type}`;
      const icon = {success:'check-circle',error:'exclamation-circle',info:'info-circle'}[type]||'info-circle';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><i class="fas fa-${icon}"></i><span>${msg}</span></div>`;
      document.body.appendChild(el);
      setTimeout(()=>{ if(el.parentNode){ el.style.animation='slideOutRight .3s ease'; setTimeout(()=>el.remove(),300); } }, 4000);
    }
  </script>
</body>
</html>
