<!-- views/patient/appointment/book.ejs -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จองนัดหมาย - Smile Clinic</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- แยก CSS -->
  <link rel="stylesheet" href="/css/patient/appointment-book.css">
  <style>
    /* เพิ่ม CSS สำหรับ time slot ให้เหมือน admin */
    .time-slot-btn {
      padding: 20px 12px;
      border: 2px solid #e9ecef;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: .3s;
      font-size: 14px;
      font-weight: 500;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .time-slot-btn:hover {
      border-color: #4A90E2;
      background: rgba(74,144,226,.1);
      transform: translateY(-2px);
    }
    .time-slot-btn.available {
      border-color: #10b981;
      background: #d1f2eb;
      color: #0c5a40;
    }
    .time-slot-btn.selected {
      border-color: #4A90E2;
      background: #4A90E2;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74,144,226,.3);
    }
    .time-slot-btn.unavailable {
      border-color: #ef4444;
      background: #fee2e2;
      color: #991b1b;
      cursor: not-allowed;
    }

    /* ปรับ doctor card ให้เหมือน admin */
    .doctor-card {
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: .3s;
      background: #f8f9fa;
    }
    .doctor-card:hover {
      border-color: #4A90E2;
      background: #fff;
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(74,144,226,.2);
    }
    .doctor-card.selected {
      border-color: #4A90E2;
      background: rgba(74,144,226,.1);
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(74,144,226,.3);
    }
    .doctor-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .doctor-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg,#4A90E2,#2DA8FF);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 20px;
    }
    .doctor-details h5 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }
    .doctor-details p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .doctor-treatments {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 12px 0 15px;
    }
    .treatment-tag {
      background: rgba(74,144,226,.1);
      color: #4A90E2;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .doctor-availability {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .time-slot {
      display: inline-block;
      background: #e8f5e8;
      color: #2e7d32;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    /* ปรับ calendar day doctors ให้เหมือน admin */
    .day-doctors {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .doctor-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 4px;
      background: rgba(74,144,226,.1);
      font-size: 11px;
      transition: .2s;
    }
    .doctor-item:hover {
      background: rgba(74,144,226,.2);
      transform: scale(1.02);
    }
    .doctor-mini-avatar {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4A90E2;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 9px;
    }
    .doctor-name-mini {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    .doctor-status {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
    }
    .doctor-status.busy {
      background: #ef4444;
    }

    /* เพิ่ม CSS สำหรับวันที่ที่ใกล้เกินไป */
    .calendar-day.too-close {
      background: #fee2e2 !important;
      color: #991b1b;
      opacity: 0.6;
      cursor: not-allowed !important;
    }
    .calendar-day.too-close:hover {
      background: #fee2e2 !important;
      border-color: #ef4444 !important;
      transform: none !important;
    }
    .calendar-day.too-close .day-number {
      color: #991b1b;
    }
    .calendar-day.too-close .day-number::after {
      content: "⚠️";
      font-size: 10px;
      margin-left: 4px;
      color: #ef4444;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i>หน้าหลัก</a></li>
      <li class="active"><a href="/patient/appointment/schedule"><i class="fas fa-calendar-check"></i>จองนัดหมาย</a></li>
      <li><a href="/patient/history"><i class="fas fa-history"></i>ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i>ประวัติการรักษา</a></li>
      <li><a href="/patient/dentists"><i class="fas fa-user-md"></i>ทันตแพทย์</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="search-section">
        <label>ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="ค้นหานัดหมาย การรักษา..." />
        </div>
      </div>

      <div class="user-section">
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()">
            <div class="avatar" id="userAvatar">P</div>
            <div class="user-details">
              <strong id="userName">ผู้ป่วย</strong>
              <small>Patient</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/patient/profile"><i class="fas fa-user"></i>โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i>เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i>ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Container -->
    <div class="container">
      <!-- Progress Section -->
      <div class="progress-section">
        <div class="progress-steps">
          <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">เลือกวันที่ & ทันตแพทย์</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">เลือกเวลา & รายละเอียด</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">ยืนยันการจอง</div>
          </div>
        </div>
      </div>

      <!-- Toast Message -->
      <div class="toast" id="toastMessage">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>

      <!-- Step 1: Select Date and Doctor -->
      <div class="step-content active" id="step1Content">
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-filter"></i>
            ค้นหาหมอตามการรักษา
          </h3>
          <div class="filter-grid">
            <div class="form-group">
              <label for="treatmentFilter">เลือกประเภทการรักษา:</label>
              <select id="treatmentFilter" class="form-control">
                <option value="">-- เลือกการรักษา --</option>
              </select>
            </div>
            <div style="display: flex; gap: 10px;">
              <button type="button" class="btn btn-primary" onclick="applyTreatmentFilter()">
                <i class="fas fa-search"></i> ค้นหา
              </button>
              <button type="button" class="btn btn-secondary" onclick="clearTreatmentFilter()">
                <i class="fas fa-times"></i> ล้าง
              </button>
            </div>
          </div>
        </div>

        <div class="calendar-section">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>วิธีใช้งาน:</strong>
              <span id="filterInstructions">
                <strong>ต้องจองล่วงหน้าอย่างน้อย 24 ชั่วโมง</strong> เพื่อรอการยืนยันจากแอดมิน และคลินิกปิดวันอาทิตย์
              </span>
            </div>
          </div>

          <div class="calendar-header">
            <button type="button" class="calendar-nav" onclick="changeCalendarMonth(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="calendar-title" id="calendarTitle">กำลังโหลด...</div>
            <button type="button" class="calendar-nav" onclick="changeCalendarMonth(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="calendar-grid" id="calendarGrid">
            <div class="weekday">อา</div>
            <div class="weekday">จ</div>
            <div class="weekday">อ</div>
            <div class="weekday">พ</div>
            <div class="weekday">พฤ</div>
            <div class="weekday">ศ</div>
            <div class="weekday">ส</div>
          </div>
        </div>

        <div class="doctors-section" id="doctorsSection" style="display: none;">
          <h3 class="section-title">
            <i class="fas fa-user-md"></i>
            ทันตแพทย์ที่ว่าง <span id="selectedDateText"></span>
          </h3>
          <div class="doctors-grid" id="doctorsGrid"></div>
        </div>

        <div class="step-navigation">
          <a href="/patient/dashboard" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> กลับไปหน้าหลัก
          </a>
          <button type="button" class="btn btn-primary" onclick="nextStep(2)" id="step1Next" disabled>
            ถัดไป: เลือกเวลา <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step-content" id="step2Content">
        <div class="time-section">
          <div class="selected-doctor-info" id="selectedDoctorInfo">
            <div class="doctor-avatar" id="selectedDoctorAvatar">D</div>
            <div class="doctor-details">
              <h3 id="selectedDoctorName">ทพ. ชื่อ</h3>
              <p id="selectedDoctorSpecialty">ความเชี่ยวชาญ</p>
            </div>
          </div>

          <div class="date-selector">
            <button type="button" class="date-nav" onclick="changeSelectedDate(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="selected-date" id="selectedDateDisplay">วันนี้</div>
            <button type="button" class="date-nav" onclick="changeSelectedDate(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <h4 style="margin-bottom: 15px; color: #333; font-size: 16px; font-weight: 600;">
            <i class="fas fa-clock" style="color: #4A90E2; margin-right: 8px;"></i>
            ช่วงเวลาว่าง
          </h4>
          <div class="time-slots-grid" id="timeSlotsGrid">
            <div class="loading" style="grid-column: 1 / -1;">
              <div class="loading-spinner"></div>
              <span>กำลังโหลดช่วงเวลาว่าง...</span>
            </div>
          </div>
        </div>

        <div class="appointment-details">
          <h3 class="section-title">
            <i class="fas fa-clipboard-list"></i>
            รายละเอียดนัดหมาย
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="treatmentSelect">การรักษา: *</label>
              <select id="treatmentSelect" class="form-control" required>
                <option value="">เลือกการรักษา</option>
              </select>
            </div>
            <div class="form-group">
              <label for="symptoms">อาการ/รายละเอียดเพิ่มเติม:</label>
              <textarea id="symptoms" class="form-control" rows="4" placeholder="กรุณาอธิบายอาการ หรือความกังวลของคุณ..."></textarea>
            </div>
          </div>
        </div>

        <div class="step-navigation">
          <button type="button" class="btn btn-secondary" onclick="previousStep(1)">
            <i class="fas fa-arrow-left"></i> ย้อนกลับ
          </button>
          <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="step2Next" disabled>
            ถัดไป: ยืนยันการจอง <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step-content" id="step3Content">
        <div class="confirmation-section">
          <div class="booking-success" id="bookingSuccess">
            <i class="fas fa-calendar-check"></i>
            พร้อมจองนัดหมายของคุณ
          </div>

          <div class="booking-details">
            <h4><i class="fas fa-file-alt"></i> สรุปนัดหมาย</h4>
            <div class="detail-row"><span class="detail-label">ชื่อผู้ป่วย:</span><span class="detail-value" id="finalPatientName">-</span></div>
            <div class="detail-row"><span class="detail-label">การรักษา:</span><span class="detail-value" id="finalTreatment">-</span></div>
            <div class="detail-row"><span class="detail-label">ทันตแพทย์:</span><span class="detail-value" id="finalDoctor">-</span></div>
            <div class="detail-row"><span class="detail-label">วันที่:</span><span class="detail-value" id="finalDate">-</span></div>
            <div class="detail-row"><span class="detail-label">เวลา:</span><span class="detail-value" id="finalTime">-</span></div>
            <div class="detail-row"><span class="detail-label">หมายเหตุ:</span><span class="detail-value" id="finalSymptoms">-</span></div>
            <div class="detail-row"><span class="detail-label">สถานะ:</span><span class="status-badge status-pending">รอยืนยัน</span></div>
          </div>

          <div class="step-navigation">
            <button type="button" class="btn btn-secondary" onclick="previousStep(2)">
              <i class="fas fa-edit"></i> แก้ไขรายละเอียด
            </button>
            <button type="button" class="btn btn-success" onclick="confirmBooking()">
              <i class="fas fa-check"></i> ยืนยันการจอง
            </button>
          </div>

          <div class="step-navigation" style="margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="startNewBooking()">
              <i class="fas fa-plus"></i> จองอีกครั้ง
            </button>
            <a href="/patient/history" class="btn btn-primary">
              <i class="fas fa-list"></i> ดูประวัติการนัดหมายของฉัน
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- แยก JS -->
  <script src="/js/patient/appointment-book.js" defer></script>
</body>
</html>
