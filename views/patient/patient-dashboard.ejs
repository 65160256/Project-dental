<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>แดชบอร์ด - <%= patient.fname %> <%= patient.lname %></title>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- แยก CSS ออกมา -->
  <link rel="stylesheet" href="/css/patient/dashboard.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li class="active"><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i>หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i>จองนัดหมาย</a></li>
      <li><a href="/patient/history"><i class="fas fa-history"></i>ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i>ประวัติการรักษา</a></li>
      <li><a href="/patient/dentists"><i class="fas fa-user-md"></i>ทันตแพทย์</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="top-bar">
      <div class="search-section">
        <label>ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text" placeholder="ค้นหานัดหมาย การรักษา..." />
        </div>
      </div>
      <div class="user-section">
        <!-- ===== Notification Bell ===== -->
        <div class="notification-bell-container">
          <button class="notification-bell-btn" id="notificationBellBtn" aria-haspopup="true" aria-expanded="false" aria-controls="notificationDropdown">
            <i class="fas fa-bell" aria-hidden="true"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
          </button>

          <div class="notification-dropdown" id="notificationDropdown" role="menu" aria-label="การแจ้งเตือน">
            <div class="notification-header">
              <h3>การแจ้งเตือน</h3>
              <button class="mark-all-read-btn" id="markAllReadBtn">
                <i class="fas fa-check-double"></i> อ่านทั้งหมด
              </button>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="notification-loading">
                <i class="fas fa-spinner fa-spin"></i> กำลังโหลด...
              </div>
            </div>
            <div class="notification-footer">
              <a href="/patient/notifications" class="view-all-link">ดูทั้งหมด <i class="fas fa-arrow-right"></i></a>
            </div>
          </div>
        </div>
        <!-- ===== /Notification Bell ===== -->

        <div class="profile-dropdown">
          <div class="user-info" id="profileToggle">
            <div class="avatar"><%= patient.fname.charAt(0) + patient.lname.charAt(0) %></div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/patient/profile"><i class="fas fa-user"></i>โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i>เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i>ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="welcome-section">
        <h1>ยินดีต้อนรับกลับมา, <%= patient.fname %>!</h1>
        <p><i class="fas fa-calendar-day"></i><%= currentDate %></p>
        <div class="quick-actions">
          <a href="/patient/appointments" class="quick-action"><i class="fas fa-plus"></i>จองนัดหมาย</a>
          <a href="/patient/dentists" class="quick-action"><i class="fas fa-search"></i>ค้นหาทันตแพทย์</a>
          <a href="/patient/history" class="quick-action"><i class="fas fa-history"></i>ดูประวัติ</a>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3><%= appointments.length %></h3>
          <p>นัดหมายทั้งหมด</p>
        </div>
        <div class="stat-card">
          <h3><%= nextAppointment ? '1' : '0' %></h3>
          <p>นัดหมายที่กำลังจะมาถึง</p>
        </div>
        <div class="stat-card">
          <h3><%= dentists.length %></h3>
          <p>ทันตแพทย์พร้อมให้บริการ</p>
        </div>
      </div>

      <div class="next-appointment">
        <h2><i class="fas fa-calendar-check"></i>นัดหมายถัดไป</h2>
        <% if (nextAppointment) { %>
          <div class="appointment-details">
            <p><strong>วันที่:</strong> <%= new Date(nextAppointment.time).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
            <p><strong>เวลา:</strong> <%= new Date(nextAppointment.time).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit', hour12: false}) %> น.</p>
            <p><strong>การรักษา:</strong> <%= nextAppointment.treatment %></p>
            <p><strong>ทันตแพทย์:</strong> ทพ. <%= nextAppointment.dentist %></p>
            <p><strong>สถานะ:</strong>
              <span class="status-badge status-<%= nextAppointment.queue_status %>">
                <%= nextAppointment.queue_status === 'confirm' ? 'ยืนยันแล้ว' : 
                    nextAppointment.queue_status === 'pending' ? 'รอยืนยัน' :
                    nextAppointment.queue_status === 'cancel' ? 'ยกเลิกแล้ว' :
                    nextAppointment.queue_status %>
              </span>
            </p>
          </div>
          <a href="/patient/history/details/<%= nextAppointment.queue_id %>" class="view-details">ดูรายละเอียด</a>
        <% } else { %>
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>ไม่มีนัดหมายที่กำลังจะมาถึง</h3>
            <p>คุณสามารถจองนัดหมายใหม่ได้ตลอดเวลา</p>
          </div>
        <% } %>
      </div>

      <div class="appointments-section">
        <div class="section-header">
          <h2>นัดหมายล่าสุด</h2>
          <div class="controls">
            <button class="filter-btn"><i class="fas fa-filter"></i>กรอง</button>
            <a href="/patient/appointments" class="add-btn"><i class="fas fa-plus"></i>นัดหมายใหม่</a>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>วันที่ & เวลา</th>
                <th>การรักษา</th>
                <th>ทันตแพทย์</th>
                <th>สถานะ</th>
              </tr>
            </thead>
            <tbody>
              <% if (appointments.length > 0) { %>
                <% appointments.forEach(function(apt) { %>
                  <tr>
                    <td>
                      <%= new Date(apt.time).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' }) %><br>
                      <small style="color: #666;"><%= new Date(apt.time).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit', hour12: false}) %> น.</small>
                    </td>
                    <td><%= apt.treatment %></td>
                    <td>ทพ. <%= apt.dentist %></td>
                    <td>
                      <span class="status-badge status-<%= apt.queue_status %>">
                        <%= apt.queue_status === 'confirm' ? 'ยืนยันแล้ว' : 
                            apt.queue_status === 'pending' ? 'รอยืนยัน' :
                            apt.queue_status === 'cancel' ? 'ยกเลิกแล้ว' :
                            apt.queue_status %>
                      </span>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4">
                    <div class="empty-state">
                      <i class="fas fa-calendar"></i>
                      <h3>ไม่พบนัดหมาย</h3>
                      <p>คุณยังไม่มีนัดหมายในระบบ</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="bottom-panels">
        <div class="treatment-history">
          <h2>ประวัติการรักษาล่าสุด</h2>
          <% if (treatmentHistory) { %>
            <div class="treatment-card">
              <p><strong>การรักษา:</strong> <%= treatmentHistory.treatment %></p>
              <p><strong>ทันตแพทย์:</strong> ทพ. <%= treatmentHistory.dentist %></p>
              <p><strong>การวินิจฉัย:</strong> <%= treatmentHistory.diagnosis %></p>
              <% if (treatmentHistory.followUpdate) { %>
                <p><strong>การติดตาม:</strong> <%= treatmentHistory.followUpdate %></p>
              <% } %>
              <a href="/patient/my-treatments" class="view-details">ดูทั้งหมด</a>
            </div>
          <% } else { %>
            <div class="empty-state">
              <i class="fas fa-notes-medical"></i>
              <h3>ไม่มีประวัติการรักษา</h3>
              <p>ประวัติการรักษาของคุณจะแสดงที่นี่</p>
            </div>
          <% } %>
        </div>

        <div class="dentists-today">
          <h2>ทันตแพทย์วันนี้</h2>
          <% if (dentists.length > 0) { %>
            <div class="dentist-cards">
              <% dentists.forEach(function(dentist) { %>
                <div class="dentist-card">
                  <% if (dentist.photo && dentist.photo !== 'default-avatar.png' && dentist.photo !== 'default-doctor.png') { %>
                    <div class="avatar"><img src="/uploads/<%= dentist.photo %>" alt="<%= dentist.name %>" /></div>
                  <% } else { %>
                    <div class="avatar"><%= dentist.name.split(' ').map(n => n.charAt(0)).join('') %></div>
                  <% } %>
                  <p>ทพ. <%= dentist.name %></p>
                  <% if (dentist.specialty) { %><small><%= dentist.specialty %></small><% } %>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="empty-state">
              <i class="fas fa-user-md"></i>
              <h3>ไม่มีทันตแพทย์ปฏิบัติงานวันนี้</h3>
              <p>กรุณาตรวจสอบอีกครั้งในภายหลัง</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- แยก JS ออกมา -->
  <script src="/js/patient/dashboard.js"></script>
</body>
</html>
