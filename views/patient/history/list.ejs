<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title %> - คลินิกยิ้มสดใส</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
   <!-- แยก CSS -->
  <link rel="stylesheet" href="/css/patient/history-list.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i>หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i>จองนัดหมาย</a></li>
      <li class="active"><a href="/patient/history"><i class="fas fa-history"></i>ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i>ประวัติการรักษา</a></li>
      <li><a href="/patient/dentists"><i class="fas fa-user-md"></i>ทันตแพทย์</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="top-bar">
      <div class="search-section">
        <label>ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="ค้นหานัดหมาย การรักษา หมอ..." />
        </div>
      </div>
      <div class="user-section">
        <div class="notification-wrapper">
          <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
        </div>
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()">
            <div class="avatar">
              <%= patient.fname.charAt(0) + patient.lname.charAt(0) %>
            </div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/patient/profile"><i class="fas fa-user"></i>โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i>เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i>ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="page-header">
        <h1>ประวัติการนัดหมาย</h1>
        <p>ติดตามและจัดการนัดหมายทางทันตกรรมของคุณ</p>
      </div>

      <% if (typeof success !== 'undefined' && success === 'cancelled') { %>
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> 
        ยกเลิกนัดหมายเรียบร้อยแล้ว
      </div>
      <% } %>

      <div class="controls-section">
        <div class="controls-header">
          <h3>กรองและเรียงลำดับนัดหมาย</h3>
        </div>
        <div class="filter-controls">
          <div class="filter-group">
            <label>สถานะ:</label>
            <select class="filter-select" id="statusFilter">
              <option value="">นัดหมายทั้งหมด</option>
              <option value="pending">รอยืนยัน</option>
              <option value="confirm">ยืนยันแล้ว</option>
              <option value="cancel">ยกเลิกแล้ว</option>
              <option value="completed">เสร็จสิ้นแล้ว</option>
            </select>
          </div>
          <div class="filter-group">
            <label>ช่วงเวลา:</label>
            <select class="filter-select" id="dateFilter">
              <option value="">ทุกช่วงเวลา</option>
              <option value="this-week">สัปดาห์นี้</option>
              <option value="this-month">เดือนนี้</option>
              <option value="last-month">เดือนที่แล้ว</option>
              <option value="last-3-months">3 เดือนที่แล้ว</option>
            </select>
          </div>
          <div class="filter-group">
            <label>เรียงตาม:</label>
            <select class="filter-select" id="sortFilter">
              <option value="date-asc">เก่าสุดก่อน</option>
              <option value="date-desc">ล่าสุดก่อน</option>
              <option value="status">สถานะ</option>
              <option value="treatment">การรักษา</option>
            </select>
          </div>
        </div>
      </div>

      <div class="appointment-list">
        <div class="list-header">
          <h3>นัดหมายของคุณ (<span id="appointmentCount"><%= appointments ? appointments.length : 0 %></span>)</h3>
        </div>
        
        <% if (appointments && appointments.length > 0) { %>
          <% appointments.forEach(function(appointment) { %>
          <div class="appointment-item" data-status="<%= appointment.queue_status %>" data-date="<%= appointment.time %>" data-treatment="<%= appointment.treatment_name %>" data-dentist="<%= appointment.dentist_name %>">
            <div class="appointment-header">
              <div>
                <div class="appointment-id">นัดหมายเลขที่ #Y-<%= appointment.queue_id.toString().padStart(6, '0') %></div>
                <div class="appointment-date">
                  จองเมื่อ <%= new Date(appointment.created_at || appointment.time).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' }) %>
                </div>
              </div>
              <div class="status-badge status-<%= appointment.queue_status %>">
                <%= appointment.queue_status === 'confirm' ? 'ยืนยันแล้ว' : 
                    appointment.queue_status === 'pending' ? 'รอยืนยัน' :
                    appointment.queue_status === 'cancel' ? 'ยกเลิกแล้ว' :
                    appointment.queue_status === 'completed' ? 'เสร็จสิ้นแล้ว' :
                    appointment.queue_status.charAt(0).toUpperCase() + appointment.queue_status.slice(1) %>
              </div>
            </div>
            
            <div class="appointment-details">
              <div class="detail-group">
                <div class="detail-item">
                  <div class="detail-icon"><i class="fas fa-stethoscope"></i></div>
                  <div class="detail-content">
                    <div class="detail-label">การรักษา</div>
                    <div class="detail-value"><%= appointment.treatment_name %></div>
                  </div>
                </div>
                <div class="detail-item">
                  <div class="detail-icon"><i class="fas fa-user-md"></i></div>
                  <div class="detail-content">
                    <div class="detail-label">ทันตแพทย์</div>
                    <div class="detail-value">ทพ. <%= appointment.dentist_name %></div>
                  </div>
                </div>
              </div>
              
              <div class="detail-group">
                <div class="detail-item">
                  <div class="detail-icon"><i class="fas fa-calendar"></i></div>
                  <div class="detail-content">
                    <div class="detail-label">วันที่นัด</div>
                    <div class="detail-value">
                      <%= new Date(appointment.time).toLocaleDateString('th-TH', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: 'long', 
                        year: 'numeric' 
                      }) %>
                    </div>
                  </div>
                </div>
                <div class="detail-item">
  <div class="detail-icon"><i class="fas fa-clock"></i></div>
  <div class="detail-content">
    <div class="detail-label">เวลา</div>
    <div class="detail-value">
      <% 
        const startTime = new Date(appointment.time);
        const endTime = new Date(startTime.getTime() + ((appointment.duration || 60) * 60000));
        const fmt = d => d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
      %>
      <%= fmt(startTime) %> - <%= fmt(endTime) %> น.
    </div>
  </div>
</div>

              </div>
            </div>
            
            <div class="action-buttons">
              <a href="/patient/history/details/<%= appointment.queue_id %>" class="btn btn-primary">
                <i class="fas fa-eye"></i> ดูรายละเอียด
              </a>
              <!-- <% if (appointment.queue_status === 'pending' || appointment.queue_status === 'confirm') { %>
                <a href="/patient/history/edit/<%= appointment.queue_id %>" class="btn btn-outline">
                  <i class="fas fa-edit"></i> แก้ไข
                </a>
              <% } %> -->
            </div>
          </div>
          <% }); %>
        <% } else { %>
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>ไม่พบนัดหมาย</h3>
            <p>คุณยังไม่มีนัดหมายใดๆ<br>จองนัดหมายแรกของคุณเพื่อเริ่มดูแลสุขภาพช่องปาก</p>
            <a href="/patient/appointments" class="btn btn-primary">
              <i class="fas fa-plus"></i> จองนัดหมาย
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- แยก JS -->
  <script src="/js/patient/history-list.js" defer></script>
</body>
</html>