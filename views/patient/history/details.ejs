<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>รายละเอียดนัดหมาย - คลินิกยิ้มสดใส</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- แยก CSS -->
  <link rel="stylesheet" href="/css/patient/history-details.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i>หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i>จองนัดหมาย</a></li>
      <li class="active"><a href="/patient/history"><i class="fas fa-history"></i>ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i>ประวัติการรักษา</a></li>
      <li><a href="/patient/dentists"><i class="fas fa-user-md"></i>ทันตแพทย์</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="top-bar">
      <div class="search-section">
        <label>ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="ค้นหานัดหมาย..." />
        </div>
      </div>
      <div class="user-section">
        <div class="notification-wrapper">
          <i class="fas fa-bell notification-icon" onclick="toggleNotifications()"></i>
        </div>
        <div class="profile-dropdown">
          <div class="user-info" onclick="toggleDropdown()">
            <div class="avatar">
              <%= patient.fname.charAt(0) + patient.lname.charAt(0) %>
            </div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown">
            <a href="/patient/profile"><i class="fas fa-user"></i>โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i>เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i>ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="page-header">
        <a href="/patient/history" class="back-btn">
          <i class="fas fa-chevron-left"></i>
        </a>
        <h1>รายละเอียดนัดหมาย</h1>
      </div>

      <!-- Success/Error Messages -->
      <% if (typeof success !== 'undefined' && success === 'updated') { %>
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> 
        อัปเดตนัดหมายเรียบร้อยแล้ว
      </div>
      <% } %>

      <% if (typeof error !== 'undefined' && error === 'cancel_time_limit') { %>
      <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i> 
        ไม่สามารถยกเลิกได้ นัดหมายใกล้เวลาแล้ว (น้อยกว่า 24 ชั่วโมง)
      </div>
      <% } %>

      <% if (typeof error !== 'undefined' && error === 'cancel_failed') { %>
      <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i> 
        ไม่สามารถยกเลิกนัดหมายได้ กรุณาลองใหม่อีกครั้ง
      </div>
      <% } %>

      <div class="main-content">
        <div class="booking-id-header">
          <h3 class="booking-id">รหัสนัดหมาย: #Y-<%= appointment.queue_id.toString().padStart(6, '0') %></h3>
        </div>

        <!-- Patient Information Section -->
        <div class="details-section">
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">ชื่อผู้ป่วย:</span>
              <span class="detail-value"><%= appointment.patient_name %></span>
            </div>
            <div class="detail-item">
  <span class="detail-label">รหัสผู้ป่วย:</span>
  <span class="detail-value"><%= appointment.patient_id || appointment.patient_code || '-' %></span>
</div>

            <div class="detail-item">
              <span class="detail-label">เบอร์โทรศัพท์:</span>
              <span class="detail-value">087985000</span>
            </div>
          </div>
        </div>

        <!-- Appointment Information Section -->
        <div class="details-section">
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">การรักษาที่ต้องการ:</span>
              <span class="detail-value"><%= appointment.treatment_name %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">วันเวลาที่นัด:</span>
              <span class="detail-value">
  <% 
    const start = new Date(appointment.time);
    const end = new Date(start.getTime() + ((appointment.duration || 60) * 60000));
    const fmtDate = d => d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const fmtTime = d => d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
  %>
  <%= fmtDate(start) %>, <%= fmtTime(start) %> - <%= fmtTime(end) %> น.
</span>
            </div>
            <div class="detail-item full-width-item">
              <span class="detail-label">ทันตแพทย์ที่เลือก:</span>
              <span class="detail-value">ทพ. <%= appointment.dentist_name %></span>
            </div>
          </div>
        </div>

        <!-- Symptom Details Section -->
        <div class="details-section">
          <div class="detail-item">
            <span class="detail-label">รายละเอียดอาการ:</span>
            <span class="detail-value"><%= appointment.diagnosis || '-' %></span>
          </div>
        </div>

        <!-- Status Section -->
        <div class="status-section">
          <div class="status-label">สถานะปัจจุบัน:</div>
          <span class="status-badge status-<%= appointment.queue_status %>">
            <%= appointment.queue_status === 'confirm' ? 'ยืนยันแล้ว' : 
                appointment.queue_status === 'pending' ? 'รอยืนยัน' :
                appointment.queue_status === 'cancel' ? 'ยกเลิกแล้ว' :
                appointment.queue_status === 'completed' ? 'เสร็จสิ้นแล้ว' :
                appointment.queue_status.charAt(0).toUpperCase() + appointment.queue_status.slice(1) %>
          </span>
        </div>

        <%
        // Calculate time difference for 24-hour rule
        const appointmentTime = new Date(appointment.time);
        const now = new Date();
        const timeDiff = appointmentTime.getTime() - now.getTime();
        const hoursDiff = timeDiff / (1000 * 3600);
        const canEdit = hoursDiff > 24;
        const isActive = appointment.queue_status === 'pending' || appointment.queue_status === 'confirm';
        %>

        <!-- 24-hour Warning Notice -->
        <% if (isActive) { %>
          <% if (!canEdit) { %>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ไม่สามารถดำเนินการได้</strong> กรุณาติดต่อคลินิกโดยตรง
          </div>
          <% } else { %>
          <div class="warning-notice">
            <div class="warning-text">
              <strong>หมายเหตุ:</strong> คุณสามารถเปลี่ยนแปลงนัดหมายได้ล่วงหน้าอย่างน้อย 24 ชั่วโมง<br>
              หากต้องการเปลี่ยนแปลงนัดหมายที่น้อยกว่านี้ กรุณาติดต่อคลินิกโดยตรง
            </div>
          </div>
          <% } %>
        <% } %>

        <!-- Action Buttons -->
        <div class="action-buttons">
  <% if (isActive && canEdit) { %>
    <form method="POST" action="/patient/history/cancel/<%= appointment.queue_id %>" style="display: inline;">
      <button type="submit" class="btn btn-cancel" onclick="return confirm('คุณแน่ใจหรือไม่ที่จะยกเลิกนัดหมายนี้?')">
        <i class="fas fa-times"></i>
        ยกเลิกนัดหมาย
      </button>
    </form>
  <% } else { %>
    <button class="btn btn-cancel" disabled>
      <i class="fas fa-times"></i>
      ยกเลิกนัดหมาย
    </button>
  <% } %>
</div>

      </div>
    </div>
  </div>

  <!-- แยก JS -->
  <script src="/js/patient/history-details.js" defer></script>
</body>
</html>