<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ทันตแพทย์ของเรา - คลินิกยิ้มสดใส</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  
  <!-- แยก CSS -->
  <link rel="stylesheet" href="/css/patient/dentist-list.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i>หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i>จองนัดหมาย</a></li>
      <li><a href="/patient/history"><i class="fas fa-history"></i>ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i>ประวัติการรักษา</a></li>
      <li class="active"><a href="/patient/dentists"><i class="fas fa-user-md"></i>ทันตแพทย์</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="top-bar" role="banner">
      <div class="search-section" role="search">
        <label for="searchInput">ค้นหา:</label>
        <div class="search-box">
          <i class="fas fa-search" aria-hidden="true"></i>
          <input type="text" id="searchInput" value="<%= searchQuery %>" placeholder="ค้นหาทันตแพทย์..." aria-label="ค้นหาทันตแพทย์"/>
          <button class="search-clear" id="clearSearch" type="button" aria-label="ล้างการค้นหา" title="ล้างการค้นหา" onclick="clearSearch()">
            <i class="fas fa-times" aria-hidden="true"></i>
          </button>
        </div>
      </div>
      <div class="user-section">
        <div class="notification-wrapper">
          <i class="fas fa-bell notification-icon" role="button" tabindex="0" aria-label="การแจ้งเตือน" onclick="toggleNotifications()"></i>
        </div>
        <div class="profile-dropdown">
          <div class="user-info" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" onclick="toggleDropdown()" onkeydown="if(event.key==='Enter'||event.key===' '){toggleDropdown(); event.preventDefault();}">
            <div class="avatar" aria-hidden="true">
              <% if (patient && patient.avatar) { %>
                <img src="/uploads/<%= patient.avatar %>" alt="">
              <% } else { %>
                <%= (patient?.fname?.[0] || 'ผ')[0] %><%= (patient?.lname?.[0] || 'ป')[0] %>
              <% } %>
            </div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down" aria-hidden="true"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown" role="menu" aria-label="โปรไฟล์">
            <a href="/patient/profile"><i class="fas fa-user"></i>โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i>เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i>ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- เนื้อหาส่วนอื่นๆ เหมือนเดิม -->
    <div class="content">
      <div class="page-header">
        <h1><i class="fas fa-user-md" aria-hidden="true"></i> ทันตแพทย์ของเรา</h1>
        <p>พบกับทีมทันตแพทย์ผู้เชี่ยวชาญของเรา</p>
      </div>

      <div class="filters-bar" aria-label="ตัวกรอง">
        <div class="filter-group">
          <span class="filter-label">กรองตามความเชี่ยวชาญ:</span>
          <button class="filter-btn active" type="button" onclick="filterBySpecialty('all', this)">ทั้งหมด</button>
          <% specialties.forEach(function(specialty) { %>
            <button class="filter-btn" type="button" onclick="filterBySpecialty('<%= specialty %>', this)"><%= specialty %></button>
          <% }); %>
        </div>
      </div>

      <div id="searchResultsAnchor"></div>

      <div id="dentistsContainer">
        <!-- ส่วนนี้เหมือนเดิม ตามโค้ดก่อนหน้า -->
        <% if (specialties.length > 0) { %>
          <% specialties.forEach(function(specialty) { %>
            <div class="specialty-section" data-specialty="<%= specialty %>">
              <h2 class="specialty-header">
                <i class="fas fa-tooth" aria-hidden="true"></i>
                <%= specialty %>
                <small>(<%= dentistsBySpecialty[specialty].length %> ท่าน)</small>
              </h2>

              <div class="dentists-grid">
                <% dentistsBySpecialty[specialty].forEach(function(dentist) { 
                     const hasPhoto = dentist.photo && dentist.photo !== 'default-avatar.png' && dentist.photo !== 'default-doctor.png';
                     const initials = (dentist.full_name || '').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
                %>
                  <div class="dentist-card is-visible"
                       data-dentist-name="<%= (dentist.full_name || '').toLowerCase() %>"
                       data-specialty="<%= (specialty || '').toLowerCase() %>">
                    <div class="dentist-photo" id="photo-<%= dentist.dentist_id %>">
                      <% if (hasPhoto) { %>
                        <img src="/uploads/<%= dentist.photo %>"
                             alt="ทพ. <%= dentist.full_name %>"
                             loading="lazy" decoding="async"
                             onerror="handleImageError(this, <%= dentist.dentist_id %>, '<%= initials %>')">
                      <% } else { %>
                        <span class="dentist-initials"><%= initials || 'DR' %></span>
                      <% } %>
                    </div>

                    <div class="dentist-info">
                      <h3 class="dentist-name">
                        ทพ. <%= (dentist.full_name || '').toUpperCase() %>
                        <span class="online-indicator" title="พร้อมให้บริการ"></span>
                      </h3>

                      <div class="dentist-specialty">
                        <i class="fas fa-stethoscope" aria-hidden="true"></i>
                        <%= dentist.specialty %>
                      </div>

                      <div class="dentist-credentials">
                        <% if (dentist.education) { %>
                          <% dentist.education.split(',').slice(0, 2).forEach(function(edu) { %>
                            <div class="credential">
                              <i class="fas fa-graduation-cap"></i>
                              <span><%= edu.trim() %></span>
                            </div>
                          <% }); %>
                        <% } else { %>
                          <div class="credential">
                            <i class="fas fa-graduation-cap"></i>
                            <span>ทันตแพทยศาสตรบัณฑิต เกียรตินิยม</span>
                          </div>
                          <div class="credential">
                            <i class="fas fa-certificate"></i>
                            <span>วุฒิบัตรชำนาญการ ทันตกรรม</span>
                          </div>
                        <% } %>
                        <div class="credential">
                          <i class="fas fa-clock"></i>
                          <span>ประสบการณ์: 5+ ปี</span>
                        </div>
                      </div>

                      <div class="dentist-actions">
                        <a href="javascript:void(0)"
                           onclick="makeAppointment(<%= dentist.dentist_id %>, '<%- dentist.full_name %>')"
                           class="make-appointment-btn">
                          <i class="fas fa-calendar-plus"></i>
                          จองนัดหมาย
                        </a>
                        <button type="button"
                                onclick="viewDentistProfile(<%= dentist.dentist_id %>)"
                                class="view-profile-btn">
                          <i class="fas fa-user"></i>
                          ดูโปรไฟล์
                        </button>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="no-dentists">
            <i class="fas fa-user-md" aria-hidden="true"></i>
            <h3>ไม่พบทันตแพทย์</h3>
            <% if (searchQuery) { %>
              <p>ไม่พบทันตแพทย์ที่ตรงกับ "<%= searchQuery %>" กรุณาลองค้นหาใหม่</p>
              <button onclick="clearSearch()" class="clear-search-btn">ล้างการค้นหา</button>
            <% } else { %>
              <p>ไม่มีทันตแพทย์ในขณะนี้</p>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div id="profileModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-content" tabindex="-1">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">ข้อมูลทันตแพทย์</h2>
        <span class="close" role="button" aria-label="ปิด" onclick="closeModal()">&times;</span>
      </div>
      <div id="profileContent">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          กำลังโหลด...
        </div>
      </div>
    </div>
  </div>

  <!-- แยก JS -->
  <script src="/js/patient/dentist-list.js" defer></script>
</body>
</html>