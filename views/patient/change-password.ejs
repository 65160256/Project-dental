<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title || 'เปลี่ยนรหัสผ่าน - คลินิกยิ้มสดใส' %></title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    *{ box-sizing: border-box; }
    :root{
      --primary:#4A90E2; --primary-2:#2DA8FF; --bg:#f5f7fa; --text:#333; --muted:#666; --border:#e1e5e9;
      --success:#28a745; --danger:#dc3545;
    }
    body{ margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); color:var(--text) }

    /* Sidebar */
    .sidebar{
      width:220px; background:linear-gradient(135deg,var(--primary),var(--primary-2));
      position:fixed; inset:0 auto 0 0; color:#fff; box-shadow:2px 0 15px rgba(0,0,0,.1); z-index:1000;
    }
    .sidebar .logo{ text-align:center; padding:25px 20px; border-bottom:1px solid rgba(255,255,255,.15) }
    .sidebar .logo img{ width:55px;height:55px;border-radius:10px;background:#fff;padding:8px;margin-bottom:10px;object-fit:contain }
    .sidebar .logo h3{ margin:0; font-size:18px; font-weight:800 }
    .sidebar ul{ list-style:none; padding:15px 0; margin:0 }
    .sidebar ul li{ margin:3px 0 }
    .sidebar ul li a{
      display:flex; align-items:center; gap:12px; padding:15px 25px; color:rgba(255,255,255,.9);
      text-decoration:none; transition:.3s; font-size:15px; font-weight:600;
    }
    .sidebar ul li a i{ width:20px; text-align:center }
    .sidebar ul li a:hover, .sidebar ul li.active a{
      background:rgba(255,255,255,.2); color:#fff; border-radius:10px; margin:0 15px; transform:translateX(5px)
    }

    /* Main/Top bar */
    .main{ margin-left:220px; min-height:100vh }
    .top-bar{
      background:#fff; padding:20px 30px; display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,.08); position:sticky; top:0; z-index:999;
    }
    .top-bar h1{ margin:0; font-size:24px; font-weight:800; color:#333; display:flex; align-items:center; gap:10px }
    .user-section{ display:flex; align-items:center; gap:25px }
    .notification-icon{ font-size:20px; cursor:pointer; color:#666; padding:8px; transition:.2s }
    .notification-icon:hover{ color:var(--primary) }

    .profile-dropdown{ position:relative }
    .user-info{
      display:flex; align-items:center; gap:12px; padding:10px 15px; border-radius:10px; cursor:pointer; transition:.2s
    }
    .user-info:hover{ background:#f8f9fa }
    .avatar{
      width:40px; height:40px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center;
      font-weight:800; color:#fff; background:linear-gradient(135deg,var(--primary),var(--primary-2)); border:2px solid #fff;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block }
    .user-details strong{ display:block; font-size:15px; color:#333; font-weight:700 }
    .user-details small{ color:#666; font-size:12px }
    .dropdown-menu{
      display:none; position:absolute; right:0; top:110%; background:#fff; border:1px solid var(--border); border-radius:10px;
      min-width:200px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden; z-index:1000;
    }
    .dropdown-menu a{
      display:flex; align-items:center; gap:10px; padding:14px 18px; text-decoration:none; color:#333; font-size:14px; font-weight:600;
    }
    .dropdown-menu a:hover{ background:#f8f9fa }
    .dropdown-menu hr{ margin:0; border:none; border-top:1px solid var(--border) }

    /* Content */
    .content{ padding:30px; display:flex; justify-content:center }
    .wrap{ width:100%; max-width:980px }

    .back-button{
      background:none; border:none; cursor:pointer; font-size:18px; color:var(--primary); margin-bottom:20px; padding:6px 8px; border-radius:8px;
      display:inline-flex; align-items:center; gap:8px; transition:.2s
    }
    .back-button:hover{ color:#357abd; background:#e9f2ff }

    .password-container{
      display:flex; gap:30px; align-items:flex-start; flex-wrap:wrap;
    }
    .profile-info{
      flex:0 0 260px; text-align:center; background:#fff; border-radius:15px; padding:24px;
      box-shadow:0 2px 15px rgba(0,0,0,.08);
    }
    .profile-avatar{
      width:100px; height:100px; border-radius:50%; margin:0 auto 14px; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; font-size:42px; font-weight:800; letter-spacing:.5px; overflow:hidden;
      box-shadow:0 6px 18px rgba(74,144,226,.35)
    }
    .profile-name{ font-size:18px; font-weight:800; color:#333; margin:0 0 6px }
    .profile-subtitle{ font-size:12px; color:#666; margin:0 }

    .password-form-section{
      flex:1; background:#fff; padding:28px; border-radius:15px; box-shadow:0 2px 15px rgba(0,0,0,.08);
    }
    .form-title{ font-size:18px; font-weight:800; color:#333; margin:0 0 18px; display:flex; align-items:center; gap:10px }
    .form-group{ margin-bottom:18px }
    .form-label{ display:block; font-size:14px; font-weight:700; color:#555; margin-bottom:6px }
    .form-input{
      width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:14px; color:#333; background:#f8f9fa;
      transition:.2s
    }
    .form-input:focus{ outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 3px rgba(74,144,226,.12) }
    .password-note{ font-size:12px; color:#666; margin-top:6px }

    .save-btn{
      background:linear-gradient(135deg,#28a745,#20c997); color:#fff; padding:12px 22px; border:none; border-radius:10px; font-size:14px; font-weight:800;
      cursor:pointer; transition:.2s; box-shadow:0 4px 12px rgba(40,167,69,.3)
    }
    .save-btn:hover{ transform:translateY(-1px); filter:saturate(1.03) }

    .error-message, .success-message{
      padding:12px 14px; border-radius:10px; margin-bottom:16px; font-size:14px; border-left:4px solid; display:flex; align-items:flex-start; gap:10px
    }
    .error-message{ background:#fde9eb; color:#7a1b25; border-color:var(--danger) }
    .success-message{ background:#e7f6ff; color:#0c5460; border-color:#17a2b8 }

    @media (max-width:1024px){
      .sidebar{ width:200px } .main{ margin-left:200px }
    }
    @media (max-width:768px){
      .sidebar{ width:100%; height:auto; position:relative }
      .main{ margin-left:0 }
      .content{ padding:20px }
      .profile-info{ flex:1 }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i> หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i> จองนัดหมาย</a></li>
      <li><a href="/patient/history"><i class="fas fa-history"></i> ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i> ประวัติการรักษา</a></li>
      <li class="active"><a href="/patient/dentists"><i class="fas fa-user-md"></i> ทันตแพทย์</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="top-bar" role="banner">
      <h1><i class="fas fa-key" aria-hidden="true"></i> เปลี่ยนรหัสผ่าน</h1>
      <div class="user-section">
        <i class="fas fa-bell notification-icon" role="button" tabindex="0" aria-label="การแจ้งเตือน" onclick="toggleNotifications()"></i>
        <div class="profile-dropdown">
          <div class="user-info" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false"
               onclick="toggleDropdown()"
               onkeydown="if(event.key==='Enter'||event.key===' '){toggleDropdown();event.preventDefault();}">
            <div class="avatar" aria-hidden="true">
              <% if (patient && patient.avatar) { %>
                <img src="/uploads/<%= patient.avatar %>" alt="">
              <% } else { %>
                <%= (patient?.fname?.[0] || 'ผ')[0] %><%= (patient?.lname?.[0] || 'ป')[0] %>
              <% } %>
            </div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down" aria-hidden="true"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown" role="menu" aria-label="โปรไฟล์">
            <a href="/patient/profile"><i class="fas fa-user"></i> โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i> เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="wrap">
        <button class="back-button" type="button" onclick="history.back()" aria-label="ย้อนกลับ">
          <i class="fas fa-arrow-left"></i> กลับ
        </button>

        <div class="password-container">
          <!-- Left: Profile -->
          <div class="profile-info">
            <div class="profile-avatar" aria-hidden="true">
              <% if (patient && patient.avatar) { %>
                <img src="/uploads/<%= patient.avatar %>" alt="" style="width:100%;height:100%;object-fit:cover;">
              <% } else { 
                   const initials = ((patient.full_name || (patient.fname+' '+patient.lname)) || '')
                                    .split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase(); %>
                <span><%= initials || 'ME' %></span>
              <% } %>
            </div>
            <h2 class="profile-name"><%= patient.full_name %></h2>
            <p class="profile-subtitle">เข้าสู่ระบบล่าสุด: <%= patient.last_login_formatted || '—' %></p>
          </div>

          <!-- Right: Form -->
          <div class="password-form-section">
            <h3 class="form-title"><i class="fas fa-lock"></i> ตั้งรหัสผ่านใหม่</h3>

            <!-- Server-side messages -->
            <% if (typeof query !== 'undefined' && query.error) { %>
              <% if (query.error === 'missing_fields') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> กรุณากรอกข้อมูลรหัสผ่านให้ครบทุกช่อง</div>
              <% } else if (query.error === 'password_mismatch') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน</div>
              <% } else if (query.error === 'password_weak') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านต้องมีอย่างน้อย 8 อักขระ</div>
              <% } else if (query.error === 'current_password_wrong') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านปัจจุบันไม่ถูกต้อง</div>
              <% } else if (query.error === 'same_password') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านใหม่ต้องไม่ซ้ำกับรหัสผ่านปัจจุบัน</div>
              <% } else if (query.error === 'update_failed') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> ไม่สามารถอัปเดตรหัสผ่านได้ โปรดลองอีกครั้ง</div>
              <% } %>
            <% } %>

            <% if (typeof query !== 'undefined' && query.success === '1') { %>
              <div class="success-message"><i class="fas fa-circle-check"></i> เปลี่ยนรหัสผ่านสำเร็จ</div>
            <% } %>

            <form action="/patient/profile/change-password" method="POST" novalidate>
              <div class="form-group">
                <label class="form-label" for="currentPassword">รหัสผ่านปัจจุบัน</label>
                <input id="currentPassword" type="password" name="currentPassword" class="form-input" required autocomplete="current-password">
              </div>

              <div class="form-group">
                <label class="form-label" for="newPassword">รหัสผ่านใหม่</label>
                <input id="newPassword" type="password" name="newPassword" class="form-input" required minlength="8" autocomplete="new-password">
                <div class="password-note" id="pwdNote">รหัสผ่านต้องมีอย่างน้อย 8 อักขระ</div>
              </div>

              <div class="form-group">
                <label class="form-label" for="confirmPassword">ยืนยันรหัสผ่านใหม่</label>
                <input id="confirmPassword" type="password" name="confirmPassword" class="form-input" required minlength="8" autocomplete="new-password">
              </div>

              <button type="submit" class="save-btn"><i class="fas fa-save"></i> บันทึก</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleDropdown() {
      const menu = document.getElementById('profileDropdown');
      const trigger = document.querySelector('.profile-dropdown .user-info');
      const isOpen = menu.style.display === 'block';
      menu.style.display = isOpen ? 'none' : 'block';
      trigger && trigger.setAttribute('aria-expanded', String(!isOpen));
    }
    function toggleNotifications(){ console.log('การแจ้งเตือนถูกคลิก'); }

    // ปิดเมนูเมื่อคลิกนอก
    document.addEventListener('click', function (e) {
      const prof = document.querySelector('.profile-dropdown');
      if (prof && !prof.contains(e.target)) {
        document.getElementById('profileDropdown').style.display = 'none';
        const trigger = prof.querySelector('.user-info');
        trigger && trigger.setAttribute('aria-expanded','false');
      }
    });

    // Client-side validation (ข้อความไทยทั้งหมด)
    const form = document.querySelector('form');
    const currentEl = document.getElementById('currentPassword');
    const newEl = document.getElementById('newPassword');
    const confirmEl = document.getElementById('confirmPassword');
    const note = document.getElementById('pwdNote');

    form.addEventListener('submit', function(e){
      const currentPassword = currentEl.value.trim();
      const newPassword = newEl.value.trim();
      const confirmPassword = confirmEl.value.trim();

      if (!currentPassword || !newPassword || !confirmPassword) {
        e.preventDefault(); alert('กรุณากรอกข้อมูลรหัสผ่านให้ครบทุกช่อง'); return false;
      }
      if (newPassword.length < 8) {
        e.preventDefault(); alert('รหัสผ่านใหม่ต้องมีอย่างน้อย 8 อักขระ'); return false;
      }
      if (newPassword !== confirmPassword) {
        e.preventDefault(); alert('รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน'); return false;
      }
      if (newPassword === currentPassword) {
        e.preventDefault(); alert('รหัสผ่านใหม่ต้องไม่ซ้ำกับรหัสผ่านปัจจุบัน'); return false;
      }
    });

    // Strength hint
    newEl.addEventListener('input', function(e){
      const p = e.target.value;
      if (!p) { note.textContent = 'รหัสผ่านต้องมีอย่างน้อย 8 อักขระ'; note.style.color='#666'; return; }
      if (p.length < 8) { note.textContent = `ความยาวรหัสผ่าน (${p.length}/8)`; note.style.color='#dc3545'; return; }
      // ตัวอย่างเงื่อนไขง่ายๆ: มีตัวพิมพ์เล็ก/ใหญ่/ตัวเลข อย่างน้อยอย่างละหนึ่ง
      const ok = /[a-z]/.test(p) + /[A-Z]/.test(p) + /\d/.test(p) + /[^A-Za-z0-9]/.test(p);
      note.textContent = ok >= 3 ? 'ความแข็งแรงรหัสผ่าน: ดี' : 'ความแข็งแรงรหัสผ่าน: ปานกลาง';
      note.style.color = ok >= 3 ? '#28a745' : '#ff9800';
    });

    // Confirm realtime
    confirmEl.addEventListener('input', function(e){
      const v = e.target.value, n = newEl.value;
      e.target.style.borderColor = (!v ? '#ddd' : (v===n ? '#28a745' : '#dc3545'));
    });
  </script>
</body>
</html>
