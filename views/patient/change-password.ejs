<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title || 'เปลี่ยนรหัสผ่าน - คลินิกยิ้มสดใส' %></title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- แยก CSS -->
  <link rel="stylesheet" href="/css/patient/change-password.css">
  
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="/img/logo.png" alt="คลินิกยิ้มสดใส" />
      <h3>คลินิกยิ้มสดใส</h3>
    </div>
    <ul>
      <li><a href="/patient/dashboard"><i class="fas fa-tachometer-alt"></i> หน้าหลัก</a></li>
      <li><a href="/patient/appointments"><i class="fas fa-calendar-check"></i> จองนัดหมาย</a></li>
      <li><a href="/patient/history"><i class="fas fa-history"></i> ประวัตินัดหมาย</a></li>
      <li><a href="/patient/my-treatments"><i class="fas fa-stethoscope"></i> ประวัติการรักษา</a></li>
      <li class="active"><a href="/patient/dentists"><i class="fas fa-user-md"></i> ทันตแพทย์</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="top-bar" role="banner">
      <h1><i class="fas fa-key" aria-hidden="true"></i> เปลี่ยนรหัสผ่าน</h1>
      <div class="user-section">
        <!-- <i class="fas fa-bell notification-icon" role="button" tabindex="0" aria-label="การแจ้งเตือน" onclick="toggleNotifications()"></i> -->
        <div class="profile-dropdown">
          <div class="user-info" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false"
               onclick="toggleDropdown()"
               onkeydown="if(event.key==='Enter'||event.key===' '){toggleDropdown();event.preventDefault();}">
            <div class="avatar" aria-hidden="true">
              <% if (patient && patient.avatar) { %>
                <img src="/uploads/<%= patient.avatar %>" alt="">
              <% } else { %>
                <%= (patient?.fname?.[0] || 'ผ')[0] %><%= (patient?.lname?.[0] || 'ป')[0] %>
              <% } %>
            </div>
            <div class="user-details">
              <strong><%= patient.fname %> <%= patient.lname %></strong>
              <small>ผู้ป่วย</small>
            </div>
            <i class="fas fa-caret-down" aria-hidden="true"></i>
          </div>
          <div class="dropdown-menu" id="profileDropdown" role="menu" aria-label="โปรไฟล์">
            <a href="/patient/profile"><i class="fas fa-user"></i> โปรไฟล์ของฉัน</a>
            <a href="/patient/profile/change-password"><i class="fas fa-key"></i> เปลี่ยนรหัสผ่าน</a>
            <hr />
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="wrap">
        <button class="back-button" type="button" onclick="history.back()" aria-label="ย้อนกลับ">
          <i class="fas fa-arrow-left"></i> กลับ
        </button>

        <div class="password-container">
          <!-- Left: Profile -->
          <div class="profile-info">
            <div class="profile-avatar" aria-hidden="true">
              <% if (patient && patient.avatar) { %>
                <img src="/uploads/<%= patient.avatar %>" alt="" style="width:100%;height:100%;object-fit:cover;">
              <% } else { 
                   const initials = ((patient.full_name || (patient.fname+' '+patient.lname)) || '')
                                    .split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase(); %>
                <span><%= initials || 'ME' %></span>
              <% } %>
            </div>
            <h2 class="profile-name"><%= patient.full_name %></h2>
            <p class="profile-subtitle">เข้าสู่ระบบล่าสุด: <%= patient.last_login_formatted || '—' %></p>
          </div>

          <!-- Right: Form -->
          <div class="password-form-section">
            <h3 class="form-title"><i class="fas fa-lock"></i> ตั้งรหัสผ่านใหม่</h3>

            <!-- Server-side messages -->
            <% if (typeof query !== 'undefined' && query.error) { %>
              <% if (query.error === 'missing_fields') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> กรุณากรอกข้อมูลรหัสผ่านให้ครบทุกช่อง</div>
              <% } else if (query.error === 'password_mismatch') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน</div>
              <% } else if (query.error === 'password_weak') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านต้องมีอย่างน้อย 8 อักขระ</div>
              <% } else if (query.error === 'current_password_wrong') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านปัจจุบันไม่ถูกต้อง</div>
              <% } else if (query.error === 'same_password') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> รหัสผ่านใหม่ต้องไม่ซ้ำกับรหัสผ่านปัจจุบัน</div>
              <% } else if (query.error === 'update_failed') { %>
                <div class="error-message"><i class="fas fa-circle-exclamation"></i> ไม่สามารถอัปเดตรหัสผ่านได้ โปรดลองอีกครั้ง</div>
              <% } %>
            <% } %>

            <% if (typeof query !== 'undefined' && query.success === '1') { %>
              <div class="success-message"><i class="fas fa-circle-check"></i> เปลี่ยนรหัสผ่านสำเร็จ</div>
            <% } %>

            <form action="/patient/profile/change-password" method="POST" novalidate>
              <div class="form-group">
                <label class="form-label" for="currentPassword">รหัสผ่านปัจจุบัน</label>
                <input id="currentPassword" type="password" name="currentPassword" class="form-input" required autocomplete="current-password">
              </div>

              <div class="form-group">
                <label class="form-label" for="newPassword">รหัสผ่านใหม่</label>
                <input id="newPassword" type="password" name="newPassword" class="form-input" required minlength="8" autocomplete="new-password">
                <div class="password-note" id="pwdNote">รหัสผ่านต้องมีอย่างน้อย 8 อักขระ</div>
              </div>

              <div class="form-group">
                <label class="form-label" for="confirmPassword">ยืนยันรหัสผ่านใหม่</label>
                <input id="confirmPassword" type="password" name="confirmPassword" class="form-input" required minlength="8" autocomplete="new-password">
              </div>

              <button type="submit" class="save-btn"><i class="fas fa-save"></i> บันทึก</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- แยก JS -->
  <script src="/js/patient/change-password.js" defer></script>
</body>
</html>
