# ระบบยกเลิกอัตโนมัติ (Auto-Cancel System)

## ภาพรวม
ระบบนี้จะตรวจสอบและยกเลิกอัตโนมัติสำหรับนัดหมายที่หมอไม่ได้กรอกการรักษาหลังจากเวลานัดแล้ว

## การทำงาน

### 1. เงื่อนไขการยกเลิกอัตโนมัติ
- นัดหมายที่มีสถานะ `confirm` (ยืนยันแล้ว)
- เวลานัดหมายผ่านไปแล้ว **2 ชั่วโมง** ขึ้นไป
- หมอยังไม่ได้กรอกการรักษา (ไม่มีข้อมูลใน `treatmentHistory`)

### 2. การทำงานของระบบ
- ระบบจะตรวจสอบทุก **2 ชั่วโมง** (Cron: `0 */2 * * *`)
- เมื่อพบนัดหมายที่ตรงเงื่อนไข จะ:
  1. เปลี่ยนสถานะเป็น `auto_cancelled`
  2. สร้างการแจ้งเตือนให้แอดมินและหมอ
  3. บันทึก log การทำงาน

### 3. สถานะใหม่: `auto_cancelled`
- **สี**: สีเหลือง/ส้ม (warning)
- **ไอคอน**: ⚠️
- **ข้อความ**: "ยกเลิกอัตโนมัติ"
- **การใช้งาน**: ไม่สามารถดูรายละเอียดได้

## ไฟล์ที่เกี่ยวข้อง

### 1. Jobs
- `jobs/notificationJobs.js` - ฟังก์ชัน `autoCancelMissedAppointments()`

### 2. Models
- `models/Queue.model.js` - เพิ่ม `auto_cancelled` ใน `validStatuses`

### 3. Views
- `views/dentist/appointments.ejs` - แสดงสถานะในหน้าทันตแพทย์
- `views/patient/history/list.ejs` - แสดงสถานะในหน้าผู้ป่วย
- `views/patient/history/details.ejs` - แสดงสถานะในหน้ารายละเอียด

### 4. CSS
- `views/dentist/appointments.ejs` - สไตล์สำหรับ `.status-badge.auto_cancelled`
- `public/css/patient/history-list.css` - สไตล์สำหรับ `.status-auto_cancelled`

### 5. JavaScript
- `public/js/patient/history-list.js` - ป้องกันการคลิกดูรายละเอียดสำหรับสถานะ `auto_cancelled`

## การทดสอบ

### วิธีทดสอบด้วยตนเอง
1. สร้างนัดหมายที่มีสถานะ `confirm`
2. เปลี่ยนเวลานัดหมายเป็น 3 ชั่วโมงที่แล้ว
3. รัน job: `node test-auto-cancel.js`
4. ตรวจสอบว่านัดหมายเปลี่ยนสถานะเป็น `auto_cancelled`

### การตรวจสอบในระบบ
1. ดูในหน้าทันตแพทย์ - นัดหมายจะแสดงสถานะ "ยกเลิกอัตโนมัติ"
2. ดูในหน้าผู้ป่วย - ไม่สามารถกดดูรายละเอียดได้
3. ดูการแจ้งเตือน - จะมีการแจ้งเตือนใหม่

## การแจ้งเตือน
เมื่อมีการยกเลิกอัตโนมัติ ระบบจะสร้างการแจ้งเตือน:
- **ประเภท**: `appointment_auto_cancelled`
- **หัวข้อ**: "⚠️ นัดหมายถูกยกเลิกอัตโนมัติ"
- **ข้อความ**: "นัดหมายของ [ชื่อผู้ป่วย] กับ [ชื่อหมอ] ถูกยกเลิกอัตโนมัติเนื่องจากหมอไม่ได้กรอกการรักษาหลังจากเวลานัด"

## การตั้งค่า Cron Job
```javascript
// ตรวจสอบทุก 2 ชั่วโมง
cron.schedule('0 */2 * * *', autoCancelMissedAppointments, {
  timezone: 'Asia/Bangkok'
});
```

## หมายเหตุ
- ระบบจะทำงานเฉพาะในเวลาทำการ (08:00-18:00) ตามการตั้งค่าเดิม
- การยกเลิกอัตโนมัติจะไม่สามารถย้อนกลับได้
- นัดหมายที่ถูกยกเลิกอัตโนมัติจะไม่สามารถดูรายละเอียดได้
